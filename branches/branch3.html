<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>×× ×•×™×” ×§×™×™××ª â€“ ×¤×¢×•×œ×•×ª</title>

  <!-- ×¢×™×¦×•×‘ ×‘×”×™×¨ ××—×™×“ -->
  <link rel="stylesheet" href="../styles.light.css?v=1" />
  <meta name="theme-color" content="#5b7cfa" />

  <style>
    /* ×’×œ×™×œ×” ×××™×ª×™×ª ×œ××–×•×¨ ×”×©×™×—×” */
    #area{ overflow-y:auto; max-height:70vh; scroll-behavior:smooth }

    /* ×¦×‘×¢×™× × ×™×™×˜×¨×œ×™×™× ×œ×›×¤×ª×•×¨×™× â€“ ×œ×œ× ×¢×“×™×¤×•×™×•×ª */
    .btn.primary { 
      background: var(--btn-bg, #f3f4f6) !important;
      color: var(--btn-fg, #111827) !important;
      border-color: var(--btn-border, #e5e7eb) !important;
    }
    .btn.next-arrow::after{ content:""; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">

      <!-- ×˜×•×¤Ö¾×‘×¨ ××—×™×“ -->
      <div class="topbar">
        <button class="btn" onclick="location.href='../index.html'">×œ×ª×¤×¨×™×˜ ×¨××©×™</button>
      </div>

      <!-- ×›×•×ª×¨×ª -->
      <div class="head">
        <div class="brand">
          <div class="logo">HB</div>
          <div class="title">×× ×•×™×” ×§×™×™××ª â€“ ×¤×¢×•×œ×•×ª</div>
        </div>
      </div>

      <!-- ××–×•×¨ ×”×ª×•×›×Ÿ -->
      <div class="body chat-body" id="area" role="log" aria-live="polite" aria-atomic="false"></div>

      <!-- ×ª×—×ª×™×ª: ×—×–×¨×” + ×©××œ×•×ª (FAQ) -->
      <div class="footer">
        <button id="backBtn" class="btn" disabled>×—×–×¨×”</button>
        <a id="faqBtn" class="btn ghost" href="../faq.html" target="_blank" rel="noopener">×™×© ×œ×™ ×©××œ×•×ª</a>
        <span class="spacer"></span>
      </div>

    </div>
  </div>

  <!-- ×§×‘×¦×™× ××©×•×ª×¤×™× -->
  <script src="./js/config.js?v=3"></script>
  <script src="./js/chat-helpers.js?v=3"></script>

  <script>
    /* ===== FAQ context ===== */
    function setHelpContext(ctx){
      const btn = document.getElementById('faqBtn');
      if(!btn) return;
      const base = '../faq.html';
      btn.href = ctx ? `${base}?ctx=${encodeURIComponent(ctx)}` : base;
    }

    /* ===== × ×™×•×•×˜ ××—×•×¨×” ×“×¨×š ×”×™×¡×˜×•×¨×™×™×ª Chat ===== */
    const backBtn = document.getElementById('backBtn');
    backBtn.onclick = ()=> Chat.goBack?.();

    /* ===== ×‘×™×ª â€“ ×‘×—×™×¨×ª ×¤×¢×•×œ×” (×›×œ ×”×›×¤×ª×•×¨×™× × ×™×™×˜×¨×œ×™×™×) ===== */
    function stepHome(){
      setHelpContext('review');
      Chat.clear(); Chat.push(stepHome);

      const header = Chat.botHTML(
        '<strong>×”×™×™ ğŸ‘‹</strong><br>' +
        '×× ××ª× ×›×‘×¨ ×× ×•×™×™×/×•×ª, ×ª×•×›×œ×• ×œ×‘×¦×¢ ×›××Ÿ ×¤×¢×•×œ×•×ª ×‘×—×©×‘×•×Ÿ. ×‘××” × ×•×›×œ ×œ×¢×–×•×¨?'
      );
      Chat.scrollStartOf(header);

      Chat.button('×©×™× ×•×™ ×™×•×/×©×¢×” ×§×‘×•×¢×” ×©×œ ×©×™×¢×•×¨', stepRescheduleContactFirst, 'btn');
      Chat.button('×‘×™×˜×•×œ ×©×™×¢×•×¨ ×¢×ª×™×“×™', stepCancel_Contact, 'btn');        // <â€” ×¢×•×“×›×Ÿ ×œ×–×¨×™××” ×”×—×“×©×”
      Chat.button('×¢×“×›×•×Ÿ ×¤×¨×˜×™ ×ª×©×œ×•×', stepBilling, 'btn');
      Chat.button('×©×œ×™×—×ª ×”×•×“×¢×” ×œ××–×›×™×¨×•×ª', stepMessage, 'btn');
      Chat.button('×× ×™ ×¨×•×¦×” ×©×™×¢×•×¨ ×ª×’×‘×•×¨ ×‘× ×•×¡×£ ×œ×× ×•×™', stepBoost_Contact, 'btn');
      Chat.button('×× ×™ ×¨×•×¦×” ×œ×”×©×œ×™× ×©×™×¢×•×¨', stepMakeUp_Contact, 'btn');
    }

    /* ===== ×©×™× ×•×™ ×™×•×/×©×¢×” â€“ ×©×œ×‘ 1: ×¤×¨×˜×™ ×§×©×¨ ===== */
    function stepRescheduleContactFirst(){
      setHelpContext('contact');
      Chat.clear(); Chat.push(stepRescheduleContactFirst);

      Chat.askContact({
        titleHtml: '<strong>×›××¢×˜ ×©× ğŸ™‚</strong><br><span class="muted">× ×©××•×¨ ×¤×¨×˜×™ ×§×©×¨ ×›×“×™ ×œ××©×¨ ××ª ×”×©×™× ×•×™.</span>',
        nextText: '×”××©×š',
        requireLast: true,
        showBack: true
      }).then(contact=>{
        if(!contact) return;
        Chat.State.data.firstName = contact.firstName;
        Chat.State.data.lastName  = contact.lastName;
        Chat.State.data.phone     = contact.phone;
        stepReschedule(); // ×‘×—×™×¨×ª ×™××™×/×©×¢×•×ª
      });
    }

    /* ===== ×©×™× ×•×™ ×™×•×/×©×¢×” â€“ ×©×œ×‘ 2: ×‘×—×™×¨×ª ××•×¢×“×™× ===== */
    function stepReschedule(){
      setHelpContext('availability');
      Chat.clear(); Chat.push(stepReschedule);

      Chat.typingThen(
        '<strong>×©×™× ×•×™ ×™×•×/×©×¢×” ×§×‘×•×¢×”</strong><br>' +
        '<span class="muted">×‘×—×¨×• ×›××” ×©×™×•×ª×¨ ××¤×©×¨×•×™×•×ª ×©× ×•×—×•×ª ×œ×›×.</span>',
        600, true
      );

      setTimeout(async ()=>{
        const chosen = await Chat.pickAvailability({
          tipText: '×‘×—×¨×• ×›××” ×©×™×•×ª×¨ ××¤×©×¨×•×™×•×ª ×©× ×•×—×•×ª ×œ×›×',
          continueText: '×”××©×š',
          allowBack: true
        });
        if(!chosen) return; // ×”××©×ª××© ×—×–×¨ ××—×•×¨×”
        stepRescheduleReview(chosen.join('; '));
      }, 650);
    }

    /* ===== ×©×™× ×•×™ ×™×•×/×©×¢×” â€“ ×©×œ×‘ 3: ×¡×™×›×•× ×•×©×œ×™×—×” ===== */
    function stepRescheduleReview(availabilitySummary){
      setHelpContext('review');
      Chat.clear(); Chat.push(()=>stepRescheduleReview(availabilitySummary));

      const h = Chat.botHTML('<strong>×¡×™×›×•× ×‘×§×©×”</strong><br><span class="muted">×‘×“×§×• ×©×”×›×•×œ × ×›×•×Ÿ ×œ×¤× ×™ ×©×œ×™×—×”.</span>');
      Chat.scrollStartOf(h);

      const d = Chat.State.data;
      const card = document.createElement('div'); card.className='bubble bot';
      const addLine = (label, value)=>{ if(!value) return; const row=document.createElement('div'); const b=document.createElement('strong'); b.textContent=label+' '; const s=document.createElement('span'); s.textContent=value; row.append(b,s); card.appendChild(row); };

      addLine('×©× ×¤×¨×˜×™:', d.firstName);
      addLine('×©× ××©×¤×—×”:', d.lastName);
      addLine('×˜×œ×¤×•×Ÿ ×œ×—×–×¨×”:', d.phone);
      addLine('×™××™× ×•×©×¢×•×ª ××•×¢×“×¤×™×:', availabilitySummary);
      document.getElementById('area').appendChild(card);
      (function(){ const a=document.getElementById('area'); a.scrollTop=a.scrollHeight; })();

      Chat.button('××™×©×•×¨ ×•×©×œ×™×—×” ×œ××–×›×™×¨×•×ª ğŸ“¤', async ()=>{
        const stop = Chat.showProcessing();

        const payload = {
          path: '×× ×•×™×” ×§×™×™××ª â€“ ×¤×¢×•×œ×•×ª',
          cta: '×©×™× ×•×™ ×™×•×/×©×¢×” ×§×‘×•×¢×”',
          availability: availabilitySummary,
          message: '',
          extraNotes: '',
          fullName: `${d.firstName||''} ${d.lastName||''}`.trim(),
          phone: d.phone || '',
          source: '×™×•×¡×˜×•×Ÿ â€“ ××ª×¨',
          status: '×œ×˜×™×¤×•×œ',
          createdAt: new Date().toISOString()
        };

        const ok = await Chat.sendLeadToSheet(payload);

        stop();
        Chat.clear();

        const fname = (d.firstName||'').trim();
        if(ok){
          Chat.botText(`×”×™×™ ${fname || '×©× ×¤×¨×˜×™'}, ×”×‘×§×©×” × ×§×œ×˜×” ×•×”×•×¢×‘×¨×” ×œ××–×›×™×¨×•×ª ×œ×”××©×š ×˜×™×¤×•×œ.\n×× ×™ ××“××’ ×©×™×—×–×¨×• ××œ×™×™×š ğŸ‘¨â€ğŸš€`).classList.add('ok');
          const home = Chat.button('×—×–×¨×” ×œ×ª×¤×¨×™×˜ ×”×¨××©×™', ()=> location.href='../index.html', 'btn');
          home.focus();
        }else{
          Chat.botText('×œ× ×”×¦×œ×—× ×• ×œ×©××•×¨ ××ª ×”×‘×§×©×” âŒ × ×™×ª×Ÿ ×œ× ×¡×•×ª ×©×•×‘ ××• ×œ×¤× ×•×ª ×‘×•×•××˜×¡××¤ 050-9570866.').classList.add('err');
          Chat.button('×œ× ×¡×•×ª ×©×•×‘', ()=> stepRescheduleReview(availabilitySummary), 'btn');
          Chat.button('×¢×¨×™×›×”', ()=> Chat.goBack?.(), 'btn');
          Chat.button('×œ×ª×¤×¨×™×˜ ×”×¨××©×™', ()=> location.href='../index.html', 'btn');
        }
      }, 'btn');

      Chat.button('×¢×¨×™×›×”', ()=> Chat.goBack?.(), 'btn');
    }

    /* ===== ×‘×™×˜×•×œ ×©×™×¢×•×¨ â€“ ×–×¨×™××” ×—×“×©×” ===== */
    function stepCancel_Contact(){
      setHelpContext('contact');
      Chat.clear(); Chat.push(stepCancel_Contact);

      Chat.askContact({
        titleHtml: '<strong>×‘×™×˜×•×œ ×©×™×¢×•×¨ ×¢×ª×™×“×™</strong><br><span class="muted">× ×©××•×¨ ×¤×¨×˜×™ ×§×©×¨ ×•× ××©×™×š ×œ×‘×—×™×¨×ª ×”××•×¢×“ ×œ×‘×™×˜×•×œ.</span>',
        nextText: '×”××©×š',
        requireLast: true,
        showBack: true
      }).then(contact=>{
        if(!contact) return;
        Chat.State.data.firstName = contact.firstName;
        Chat.State.data.lastName  = contact.lastName;
        Chat.State.data.phone     = contact.phone;
        stepCancel_Details();
      });
    }

    function stepCancel_Details(){
      setHelpContext('review');
      Chat.clear(); Chat.push(stepCancel_Details);

      Chat.botHTML('<strong>×‘×—×™×¨×ª ×¤×¨×˜×™ ×”×©×™×¢×•×¨ ×œ×‘×™×˜×•×œ</strong><br><span class="muted">×‘×—×¨×• ×ª××¨×™×š ××œ×•×— ×—×•×“×©×™, ×©×¢×”, ××§×¦×•×¢ ×•×”×•×¡×™×¤×• ×”×¢×¨×” ×× ×¦×¨×™×š.</span>');

      // ×ª××¨×™×š â€“ ×œ×•×— ×—×•×“×©×™ (native)
      const dateEl = (()=>{
        const wrap=document.createElement('div'); wrap.className='input-wrap bubble bot';
        const l=document.createElement('label'); l.textContent='×ª××¨×™×š ×”×©×™×¢×•×¨';
        const i=document.createElement('input'); i.type='date'; i.className='input'; i.id='cancel_date';
        // ××•×¤×¦×™×•× ×œ×™: ×ª×—×•× ×ª××¨×™×›×™× ×§×“×™××” ×‘×œ×‘×“
        const today = new Date().toISOString().slice(0,10);
        i.min = today;
        wrap.append(l,i); document.getElementById('area').appendChild(wrap); return i;
      })();

      // ×©×¢×” â€“ ×¨×©×™××” × ×¤×ª×—×ª
      const timeSel = (()=>{
        const times = ['','14:00','15:00','16:00','17:00','18:00','19:00','20:00','21:00'];
        const wrap=document.createElement('div'); wrap.className='input-wrap bubble bot';
        const l=document.createElement('label'); l.textContent='×©×¢×”';
        const s=document.createElement('select'); s.className='input'; s.id='cancel_time';
        const opt0=document.createElement('option'); opt0.value=''; opt0.textContent='×‘×—×¨/×™ ×©×¢×”'; s.appendChild(opt0);
        times.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; s.appendChild(o); });
        wrap.append(l,s); document.getElementById('area').appendChild(wrap); return s;
      })();

      // ××§×¦×•×¢ â€“ ×¨×©×™××” × ×¤×ª×—×ª
      const subjSel = (()=>{
        const subjects = ['','××ª××˜×™×§×”','×× ×’×œ×™×ª','×¤×™×–×™×§×”','×©×¤×”','×”×•×¨××” ××ª×§× ×ª','×× ×’×œ×™×ª ××“×•×‘×¨×ª'];
        const wrap=document.createElement('div'); wrap.className='input-wrap bubble bot';
        const l=document.createElement('label'); l.textContent='××§×¦×•×¢';
        const s=document.createElement('select'); s.className='input'; s.id='cancel_subject';
        subjects.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent = v || '×‘×—×¨/×™ ××§×¦×•×¢'; s.appendChild(o); });
        wrap.append(l,s); document.getElementById('area').appendChild(wrap); return s;
      })();

      // ××œ×œ ×—×•×¤×©×™
      const notes = Chat.inputRow('×¡×™×‘×ª ×‘×™×˜×•×œ / ×¤×¨×˜×™× (×¨×©×•×ª)', { textarea:true, id:'cancel_reason', placeholder:'×”×¡×‘×¨ ×§×¦×¨ (××•×¤×¦×™×•× ×œ×™)' });

      Chat.button('×”××©×š ×œ×¡×™×›×•×', ()=>{
        const d = Chat.State.data;
        const payload = {
          path: '×× ×•×™×” ×§×™×™××ª â€“ ×¤×¢×•×œ×•×ª',
          cta: '×‘×™×˜×•×œ ×©×™×¢×•×¨',
          lessonDate: (dateEl.value || '').trim(),    // YYYY-MM-DD
          lessonTime: (timeSel.value || '').trim(),   // HH:MM
          subject: (subjSel.value || '').trim(),
          message: (notes.value || '').trim(),
          extraNotes: '',
          fullName: `${d.firstName||''} ${d.lastName||''}`.trim(),
          phone: d.phone || '',
          source: '×™×•×¡×˜×•×Ÿ â€“ ××ª×¨',
          status: '×œ×˜×™×¤×•×œ',
          createdAt: new Date().toISOString()
        };

        // ×•×œ×™×“×¦×™×” ×‘×¡×™×¡×™×ª
        const errs=[];
        if(!payload.lessonDate) errs.push('lessonDate');
        if(!payload.lessonTime) errs.push('lessonTime');
        if(!payload.subject) errs.push('subject');
        if(!payload.fullName) errs.push('fullName');
        if(!Chat.validILPhone(payload.phone)) errs.push('phone');

        if(errs.length){
          const e = errs[0];
          if(e==='phone'){
            Chat.botText('××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ× ×ª×§×™×Ÿ ğŸ“ (×œ××©×œ 0501234567)').classList.add('err');
          }else{
            Chat.botText('×—×¡×¨ ×©×“×” × ×“×¨×©. ×× × ××œ××• ×•× ×¡×• ×©×•×‘.').classList.add('err');
          }
          return;
        }

        stepReviewGeneric(payload, {required:['lessonDate','lessonTime','subject','fullName','phone']});
      }, 'btn');

      Chat.button('×—×–×¨×”', ()=> Chat.goBack(), 'btn');
    }

    /* ===== ×¢×“×›×•×Ÿ ×¤×¨×˜×™ ×ª×©×œ×•× ===== */
    function stepBilling(){
      setHelpContext('review');
      Chat.clear(); Chat.push(stepBilling);

      Chat.typingThen('×›×“×™ ×œ×¢×“×›×Ÿ ×¤×¨×˜×™ ×ª×©×œ×•× â€” × ×©××•×¨ ×¤×¨×˜×™ ×§×©×¨ ×•× ×—×–×•×¨ ××œ×™×›×/×Ÿ ×œ×”××©×š ×˜×™×¤×•×œ ××™×©×™ ğŸ™', 550, true);

      const notes = Chat.inputRow('×¤×¨×˜×™× ×©×›×“××™ ×œ×“×¢×ª (×¨×©×•×ª)', { textarea:true, id:'bill_notes', placeholder:'×œ××©×œ: ×”×—×œ×¤×ª ×›×¨×˜×™×¡, ×©×™× ×•×™ ×××¦×¢×™ ×—×™×•×‘ ×•×›×•×³' });
      const first = Chat.inputRow('×©× ×¤×¨×˜×™',   { id:'fullName_first', placeholder:'×œ×“×•×’××”: ×“× ×”' });
      const last  = Chat.inputRow('×©× ××©×¤×—×”',  { id:'fullName_last',  placeholder:'×œ×“×•×’××”: ×œ×•×™' });
      const tel   = Chat.inputRow('×˜×œ×¤×•×Ÿ ×œ×—×–×¨×”', { type:'tel', id:'phone', placeholder:'×œ×“×•×’××”: 0501234567' });

      Chat.button('×”××©×š ×œ×¡×™×›×•×', ()=>{
        const payload = {
          path: '×× ×•×™×” ×§×™×™××ª â€“ ×¤×¢×•×œ×•×ª',
          cta: '×¢×“×›×•×Ÿ ×¤×¨×˜×™ ×ª×©×œ×•×',
          message: (notes.value||'').trim(),
          extraNotes: '',
          fullName: `${(first.value||'').trim()} ${(last.value||'').trim()}`.trim(),
          phone: Chat.normalizeILPhone(tel.value||''),
          source: '×™×•×¡×˜×•×Ÿ â€“ ××ª×¨',
          status: '×œ×˜×™×¤×•×œ',
          createdAt: new Date().toISOString()
        };
        stepReviewGeneric(payload, {required:['fullName','phone']});
      }, 'btn');

      Chat.button('×—×–×¨×”', ()=> Chat.goBack(), 'btn');
    }

    /* ===== ×”×•×“×¢×” ×œ××–×›×™×¨×•×ª ===== */
    function stepMessage(){
      setHelpContext('review');
      Chat.clear(); Chat.push(stepMessage);

      Chat.typingThen('××” ×ª×¨×¦×• ×œ×›×ª×•×‘ ×œ××–×›×™×¨×•×ª ×©×œ× ×•? âœï¸', 550, true);

      const msg   = Chat.inputRow('×”×•×“×¢×”', { textarea:true, id:'msg', placeholder:'×›×ª×‘×• ×›××Ÿ ×›×œ ×“×‘×¨ ×©×ª×¨×¦×•' });
      const notes = Chat.inputRow('×¤×¨×˜×™× × ×•×¡×¤×™× (×¨×©×•×ª)', { textarea:true, id:'msg_notes', placeholder:'×× ×™×© ×¢×•×“ ×¤×¨×˜×™× ×—×©×•×‘×™×' });
      const first = Chat.inputRow('×©× ×¤×¨×˜×™',   { id:'fullName_first', placeholder:'×œ×“×•×’××”: ×“× ×”' });
      const last  = Chat.inputRow('×©× ××©×¤×—×”',  { id:'fullName_last',  placeholder:'×œ×“×•×’××”: ×œ×•×™' });
      const tel   = Chat.inputRow('×˜×œ×¤×•×Ÿ ×œ×—×–×¨×”', { type:'tel', id:'phone', placeholder:'×œ×“×•×’××”: 0501234567' });

      Chat.button('×”××©×š ×œ×¡×™×›×•×', ()=>{
        const payload = {
          path: '×× ×•×™×” ×§×™×™××ª â€“ ×¤×¢×•×œ×•×ª',
          cta: '×¤× ×™×™×” ×œ××–×›×™×¨×•×ª',
          message: (msg.value||'').trim(),
          extraNotes: (notes.value||'').trim(),
          fullName: `${(first.value||'').trim()} ${(last.value||'').trim()}`.trim(),
          phone: Chat.normalizeILPhone(tel.value||''),
          source: '×™×•×¡×˜×•×Ÿ â€“ ××ª×¨',
          status: '×œ×˜×™×¤×•×œ',
          createdAt: new Date().toISOString()
        };
        stepReviewGeneric(payload, {required:['message','fullName','phone']});
      }, 'btn');

      Chat.button('×—×–×¨×”', ()=> Chat.goBack(), 'btn');
    }

    /* ===== ×©×™×¢×•×¨ ×ª×’×‘×•×¨ ×‘× ×•×¡×£ ×œ×× ×•×™ ===== */
    function stepBoost_Contact(){
      setHelpContext('contact');
      Chat.clear(); Chat.push(stepBoost_Contact);

      Chat.askContact({
        titleHtml: '<strong>×©×™×¢×•×¨ ×ª×’×‘×•×¨</strong><br><span class="muted">× ×©××•×¨ ×¤×¨×˜×™ ×§×©×¨ ×•× ××©×™×š ×œ×‘×—×™×¨×ª ××•×¢×“×™×.</span>',
        nextText: '×”××©×š',
        requireLast: true,
        showBack: true
      }).then(contact=>{
        if(!contact) return;
        Chat.State.data.firstName = contact.firstName;
        Chat.State.data.lastName  = contact.lastName;
        Chat.State.data.phone     = contact.phone;
        stepBoost_Availability();
      });
    }

    function stepBoost_Availability(){
      setHelpContext('availability');
      Chat.clear(); Chat.push(stepBoost_Availability);

      Chat.typingThen('<strong>×‘×—×™×¨×ª ××•×¢×“×™× ×œ×©×™×¢×•×¨ ×ª×’×‘×•×¨</strong><br><span class="muted">×‘×—×¨×• ×›××” ×©×™×•×ª×¨ ××¤×©×¨×•×™×•×ª ×©× ×•×—×•×ª ×œ×›×.</span>', 600, true);

      setTimeout(async ()=>{
        const chosen = await Chat.pickAvailability({
          tipText: '× ×™×ª×Ÿ ×œ×‘×—×•×¨ ×›××” ××•×¢×“×™×',
          continueText: '×”××©×š',
          allowBack: true
        });
        if(!chosen) return;
        stepBoost_Subject(chosen);
      }, 650);
    }

    function stepBoost_Subject(availabilityArr){
      setHelpContext('review');
      Chat.clear(); Chat.push(()=>stepBoost_Subject(availabilityArr));

      const h = Chat.botHTML('<strong>×‘×—×™×¨×ª ××§×¦×•×¢</strong><br><span class="muted">×‘××™×–×” ××§×¦×•×¢ × ×“×¨×© ×”×ª×’×‘×•×¨?</span>');
      Chat.scrollStartOf(h);

      const subjects = ['××ª××˜×™×§×”','×× ×’×œ×™×ª','×¤×™×–×™×§×”','×©×¤×”','×”×•×¨××” ××ª×§× ×ª','×× ×’×œ×™×ª ××“×•×‘×¨×ª'];
      const subjectSel = (()=>{
        const wrap=document.createElement('div'); wrap.className='input-wrap bubble bot';
        const l=document.createElement('label'); l.textContent='××§×¦×•×¢';
        const s=document.createElement('select'); s.className='input';
        const opt0=document.createElement('option'); opt0.value=''; opt0.textContent='×‘×—×¨/×™ ××§×¦×•×¢'; s.appendChild(opt0);
        subjects.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; s.appendChild(o); });
        wrap.append(l,s); document.getElementById('area').appendChild(wrap); return s;
      })();

      const notes = Chat.inputRow('×¤×¨×˜×™× × ×•×¡×¤×™× (×¨×©×•×ª)', { textarea:true, id:'boost_notes', placeholder:'×× ×™×© ×”×§×©×¨ ××• ×‘×§×©×•×ª' });

      Chat.button('×”××©×š ×œ×¡×™×›×•×', ()=>{
        const subj = subjectSel.value || '';
        if(!subj){
          Chat.botText('×‘×—×¨/×™ ××§×¦×•×¢ ğŸ“š').classList.add('err');
          subjectSel.focus(); return;
        }
        const d = Chat.State.data;
        const payload = {
          path: '×× ×•×™×” ×§×™×™××ª â€“ ×¤×¢×•×œ×•×ª',
          cta: '×©×™×¢×•×¨ ×ª×’×‘×•×¨ ×‘× ×•×¡×£ ×œ×× ×•×™',
          subject: subj,
          availability: availabilityArr.join('; '),
          message: (notes.value||'').trim(),
          extraNotes: '',
          fullName: `${d.firstName||''} ${d.lastName||''}`.trim(),
          phone: d.phone || '',
          source: '×™×•×¡×˜×•×Ÿ â€“ ××ª×¨',
          status: '×œ×˜×™×¤×•×œ',
          createdAt: new Date().toISOString()
        };
        stepReviewGeneric(payload, {required:['subject','availability','fullName','phone']});
      }, 'btn');

      Chat.button('×—×–×¨×”', ()=> Chat.goBack(), 'btn');
    }

    /* ===== ×”×©×œ××ª ×©×™×¢×•×¨ ===== */
    function stepMakeUp_Contact(){
      setHelpContext('contact');
      Chat.clear(); Chat.push(stepMakeUp_Contact);

      Chat.askContact({
        titleHtml: '<strong>×”×©×œ××ª ×©×™×¢×•×¨</strong><br><span class="muted">× ×©××•×¨ ×¤×¨×˜×™ ×§×©×¨ ×•× ××©×™×š ×œ×¤×¨×˜×™×.</span>',
        nextText: '×”××©×š',
        requireLast: true,
        showBack: true
      }).then(contact=>{
        if(!contact) return;
        Chat.State.data.firstName = contact.firstName;
        Chat.State.data.lastName  = contact.lastName;
        Chat.State.data.phone     = contact.phone;
        stepMakeUp_Details();
      });
    }

    function stepMakeUp_Details(){
      setHelpContext('review');
      Chat.clear(); Chat.push(stepMakeUp_Details);

      Chat.botHTML('<strong>×¤×¨×˜×™ ×”×©×œ××ª ×”×©×™×¢×•×¨</strong><br><span class="muted">××œ××• ××ª ×”×¤×¨×˜×™× ×”×“×¨×•×©×™×.</span>');

      // ××™ ×‘×™×˜×œ?
      const whoSel = (()=>{
        const wrap=document.createElement('div'); wrap.className='input-wrap bubble bot';
        const l=document.createElement('label'); l.textContent='××™ ×‘×™×˜×œ ××ª ×”×©×™×¢×•×¨?';
        const s=document.createElement('select'); s.className='input'; s.id='whoCanceled';
        const opt0=document.createElement('option'); opt0.value=''; opt0.textContent='×‘×—×¨/×™'; s.appendChild(opt0);
        ['×× ×—× ×• ×‘×™×˜×œ× ×•','×”××¨×›×– ×‘×™×˜×œ'].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; s.appendChild(o); });
        wrap.append(l,s); document.getElementById('area').appendChild(wrap); return s;
      })();

      // ××§×¦×•×¢
      const subjects = ['××ª××˜×™×§×”','×× ×’×œ×™×ª','×¤×™×–×™×§×”','×©×¤×”','×”×•×¨××” ××ª×§× ×ª','×× ×’×œ×™×ª ××“×•×‘×¨×ª'];
      const subjSel = (()=>{
        const wrap=document.createElement('div'); wrap.className='input-wrap bubble bot';
        const l=document.createElement('label'); l.textContent='××§×¦×•×¢';
        const s=document.createElement('select'); s.className='input'; s.id='subject';
        const opt0=document.createElement('option'); opt0.value=''; opt0.textContent='×‘×—×¨/×™ ××§×¦×•×¢'; s.appendChild(opt0);
        subjects.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; s.appendChild(o); });
        wrap.append(l,s); document.getElementById('area').appendChild(wrap); return s;
      })();

      // ×ª××¨×™×š ×•×©×¢×”
      const dateEl = (()=>{
        const wrap=document.createElement('div'); wrap.className='input-wrap bubble bot';
        const l=document.createElement('label'); l.textContent='×ª××¨×™×š';
        const i=document.createElement('input'); i.type='date'; i.className='input'; i.id='makeup_date';
        const today = new Date().toISOString().slice(0,10);
        i.min = today;
        wrap.append(l,i); document.getElementById('area').appendChild(wrap); return i;
      })();
      const timeFrom = Chat.inputRow('××©×¢×”', { id:'time_from', placeholder:'×œ×“×•×’××”: 16:00', inputmode:'numeric' });
      const timeTo   = Chat.inputRow('×¢×“ ×©×¢×”', { id:'time_to',   placeholder:'×œ×“×•×’××”: 18:00', inputmode:'numeric' });

      // ××œ×œ ×—×•×¤×©×™
      const notes = Chat.inputRow('×¤×¨×˜×™× × ×•×¡×¤×™× (×¨×©×•×ª)', { textarea:true, id:'makeup_notes', placeholder:'×›×œ ×“×‘×¨ ×©×—×©×•×‘ ×©× ×“×¢ ×œ×¤× ×™ ×”×ª×™××•×' });

      Chat.button('×”××©×š ×œ×¡×™×›×•×', ()=>{
        const d = Chat.State.data;
        const payload = {
          path: '×× ×•×™×” ×§×™×™××ª â€“ ×¤×¢×•×œ×•×ª',
          cta: '×”×©×œ××ª ×©×™×¢×•×¨',
          whoCanceled: whoSel.value || '',
          subject: subjSel.value || '',
          lessonDate: (dateEl.value || '').trim(),
          timeFrom: (timeFrom.value || '').trim(),
          timeTo:   (timeTo.value   || '').trim(),
          message:  (notes.value    || '').trim(),
          extraNotes: '',
          fullName: `${d.firstName||''} ${d.lastName||''}`.trim(),
          phone: d.phone || '',
          source: '×™×•×¡×˜×•×Ÿ â€“ ××ª×¨',
          status: '×œ×˜×™×¤×•×œ',
          createdAt: new Date().toISOString()
        };

        const errs=[];
        if(!payload.whoCanceled) errs.push('whoCanceled');
        if(!payload.subject) errs.push('subject');
        if(!payload.lessonDate) errs.push('lessonDate');
        if(!payload.timeFrom || !payload.timeTo) errs.push('time');
        if(!payload.fullName) errs.push('fullName');
        if(!Chat.validILPhone(payload.phone)) errs.push('phone');

        if(errs.length){
          const e = errs[0];
          if(e==='phone'){
            Chat.botText('××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ× ×ª×§×™×Ÿ ğŸ“ (×œ××©×œ 0501234567)').classList.add('err');
          }else{
            Chat.botText('×—×¡×¨ ×©×“×” × ×“×¨×©. ×× × ××œ××• ×•× ×¡×• ×©×•×‘.').classList.add('err');
          }
          return;
        }

        stepReviewGeneric(payload, {required:['whoCanceled','subject','lessonDate','timeFrom','timeTo','fullName','phone']});
      }, 'btn');

      Chat.button('×—×–×¨×”', ()=> Chat.goBack(), 'btn');
    }

    /* ===== ×¡×™×›×•×/×©×œ×™×—×” ×›×œ×œ×™ ===== */
    function stepReviewGeneric(payload, rules){
      const errs=[];
      (rules.required||[]).forEach(k=>{
        if(!payload[k] || (typeof payload[k]==='string' && !payload[k].trim())) errs.push(k);
      });
      if(payload.phone && !Chat.validILPhone(payload.phone)) errs.push('phone_invalid');

      if(errs.length){
        const e=errs[0];
        if(e==='phone' || e==='phone_invalid'){
          Chat.botText('××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ× ×ª×§×™×Ÿ ğŸ“ (×œ××©×œ 0501234567)').classList.add('err');
        }else{
          Chat.botText('×—×¡×¨ ×©×“×” × ×“×¨×©. ×× × ××œ××• ×•× ×¡×• ×©×•×‘.').classList.add('err');
        }
        return;
      }

      Chat.clear(); Chat.push(()=>stepReviewGeneric(payload, rules));

      const h = Chat.botHTML('<strong>×¡×™×›×•× ×”×‘×§×©×”</strong><br><span class="muted">×‘×“×§×• ×©×”×›×•×œ × ×›×•×Ÿ ×œ×¤× ×™ ×©×œ×™×—×”.</span>');
      Chat.scrollStartOf(h);

      const card = document.createElement('div'); card.className='bubble bot';
      const row = (label, val)=>{ if(!val) return; const d=document.createElement('div'); const b=document.createElement('strong'); b.textContent=label+' '; const s=document.createElement('span'); s.textContent=val; d.append(b,s); card.appendChild(d); };
      row('×¤×¢×•×œ×”:', payload.cta);
      row('×ª××¨×™×š:', payload.lessonDate);
      row('×©×¢×”:', payload.lessonTime); // ×™×•×¦×’ ×‘×‘×™×˜×•×œ ×©×™×¢×•×¨
      row('××©×¢×”:', payload.timeFrom);  // ×™×•×¦×’ ×‘×”×©×œ××”
      row('×¢×“ ×©×¢×”:', payload.timeTo);  // ×™×•×¦×’ ×‘×”×©×œ××”
      row('××™ ×‘×™×˜×œ:', payload.whoCanceled);
      row('××§×¦×•×¢:', payload.subject);
      row('×”×•×“×¢×”:', payload.message);
      row('×¤×¨×˜×™× × ×•×¡×¤×™×:', payload.extraNotes);
      row('×©× ××œ×:', payload.fullName);
      row('×˜×œ×¤×•×Ÿ ×œ×—×–×¨×”:', payload.phone);
      document.getElementById('area').appendChild(card);
      (function(){ const a=document.getElementById('area'); a.scrollTop=a.scrollHeight; })();

      Chat.button('××™×©×•×¨ ×•×©×œ×™×—×” ×œ××–×›×™×¨×•×ª ğŸ“¤', async ()=>{
        const stop = Chat.showProcessing();
        const ok = await Chat.sendLeadToSheet(payload);
        stop();
        Chat.clear();

        const fname = (payload.fullName||'').trim().split(' ')[0] || '×©× ×¤×¨×˜×™';

        if(ok){
          Chat.botText(`×”×™×™ ${fname}, ×”×‘×§×©×” × ×§×œ×˜×” ×•×”×•×¢×‘×¨×” ×œ××–×›×™×¨×•×ª ×œ×”××©×š ×˜×™×¤×•×œ.\n×× ×™ ××“××’ ×©×™×—×–×¨×• ××œ×™×™×š ğŸ‘¨â€ğŸš€`).classList.add('ok');
          const home = Chat.button('×—×–×¨×” ×œ×ª×¤×¨×™×˜ ×”×¨××©×™', ()=> location.href='../index.html', 'btn');
          home.focus();
        }else{
          Chat.botText('×œ× ×”×¦×œ×—× ×• ×œ×©××•×¨ ××ª ×”×‘×§×©×” âŒ × ×™×ª×Ÿ ×œ× ×¡×•×ª ×©×•×‘ ××• ×œ×¤× ×•×ª ×‘×•×•××˜×¡××¤ 050-9570866.').classList.add('err');
          Chat.button('×œ× ×¡×•×ª ×©×•×‘', ()=> stepReviewGeneric(payload, rules), 'btn');
          Chat.button('×¢×¨×™×›×”', ()=> Chat.goBack?.(), 'btn');
          Chat.button('×œ×ª×¤×¨×™×˜ ×”×¨××©×™', ()=> location.href='../index.html', 'btn');
        }
      }, 'btn');

      Chat.button('×¢×¨×™×›×”', ()=> Chat.goBack?.(), 'btn');
    }

    // ×”×¤×¢×œ×”
    stepHome();
  </script>
</body>
</html>