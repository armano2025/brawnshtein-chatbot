<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>×× ×•×™×” ×§×™×™××ª â€“ ×¤×¢×•×œ×•×ª</title>

  <!-- ×—×©×•×‘: ×”×¢× ×£ × ××¦× ×‘×ª×•×š /branches/, ×œ×›×Ÿ ../ -->
  <link rel="stylesheet" href="../styles.css?v=3" />
  <meta name="theme-color" content="#2563eb" />

  <style>
    /* ×—×™×–×•×§ ××§×•××™: ×’×œ×™×œ×” ×××™×ª×™×ª ×œ××–×•×¨ ×”×©×™×—×” */
    #area{ overflow-y:auto; max-height:70vh; scroll-behavior:smooth; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <!-- ×›×•×ª×¨×ª -->
      <div class="head">
        <div class="brand">
          <div class="logo">HB</div>
          <div class="title">×× ×•×™×” ×§×™×™××ª â€“ ×¤×¢×•×œ×•×ª</div>
        </div>
      </div>

      <!-- ××–×•×¨ ×”×ª×•×›×Ÿ -->
      <div class="body chat-body" id="area" role="log" aria-live="polite" aria-atomic="false"></div>

      <!-- ×›×¤×ª×•×¨×™ × ×™×•×•×˜ ×ª×—×ª×•× ×™× -->
      <div class="footer">
        <button id="backBtn" class="btn" disabled>×—×–×¨×”</button>
        <button id="homeBtn" class="btn primary" onclick="location.href='../index.html'">×œ×ª×¤×¨×™×˜ ×¨××©×™</button>
      </div>
    </div>
  </div>

  <script>
    /* ===== ×§×•× ×¤×™×’ ===== */
    const SHEETS_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbwnNKY0BeO5N2O9oWmr8ltCHr9fVdDdrXsL_3erastx4qdEqhCz1mYAhkvZETF-86CGnw/exec';

    /* ===== DOM/State ===== */
    const area    = document.getElementById('area');
    const backBtn = document.getElementById('backBtn');

    const state = { history: [] };
    const last  = () => state.history[state.history.length - 1];

    // ×× ×™×¢×ª "×˜×™×™××¨×™× ×¨×¤××™×"
    let runToken = 0;

    // ×©×œ×™×˜×” ×¢×“×™× ×” ×‘×’×œ×™×œ×”
    let autoScrollEnabled = true;
    const enableAutoScroll  = () => (autoScrollEnabled = true);
    const disableAutoScroll = () => (autoScrollEnabled = false);

    const updateBack = () => { backBtn.disabled = state.history.length <= 1; };
    const push = fn => { state.history.push(fn); updateBack(); };
    const goBack = () => {
      if (state.history.length > 1) {
        state.history.pop();
        updateBack();
        runToken++;           // ××‘×˜×œ setTimeout ×™×©× ×™×
        last()();
      }
    };
    backBtn.onclick = goBack;

    /* ===== UI helpers ===== */
    const clear       = () => { runToken++; area.innerHTML = ''; };
    const autoscroll  = () => { if (autoScrollEnabled) area.scrollTop = area.scrollHeight; };
    const scrollStart = el => el?.scrollIntoView({ block:'start', behavior:'smooth' });
    const waitP       = ms => new Promise(r=>setTimeout(r, ms));

    // ×‘×•×˜: HTML ×××™×Ÿ (×©×œ× ×•) ××•×œ ×˜×§×¡×˜ ×‘×˜×•×— (×œ××©×ª××©/×©×¨×ª)
    function botHTML(html){
      const d = document.createElement('div');
      d.className = 'bubble bot';
      d.innerHTML = html;
      area.appendChild(d); autoscroll(); return d;
    }
    function botText(text){
      const d = document.createElement('div');
      d.className = 'bubble bot';
      d.textContent = text;
      area.appendChild(d); autoscroll(); return d;
    }
    function userText(text){
      const d = document.createElement('div');
      d.className = 'bubble user';
      d.textContent = text;
      area.appendChild(d); autoscroll(); return d;
    }

    function button(text, onClick, cls='btn'){
      const b = document.createElement('button');
      b.className = cls;
      b.textContent = text;
      b.onclick = () => { b.disabled = true; onClick(); }; // ×× ×™×¢×ª ×“××‘×œ-×§×œ×™×§
      area.appendChild(b); autoscroll(); return b;
    }

    function inputRow(label, {type='text', id, textarea=false, placeholder=''} = {}){
      const wrap = document.createElement('div');
      wrap.className = 'input-wrap bubble bot';

      const l = document.createElement('label');
      l.textContent = label;
      if(id) l.htmlFor = id;

      let el;
      if (textarea) {
        el = document.createElement('textarea'); el.className = 'textarea';
      } else {
        el = document.createElement('input'); el.type = type; el.className = 'input';
      }
      el.id = id; el.placeholder = placeholder; el.dir = 'rtl';

      // × ×’×™×©×•×ª/××•×˜×•×§×•××¤×œ×™×˜ ×‘×¡×™×¡×™×™×:
      if (id === 'fullName') { el.required = true; el.autocomplete = 'name'; }
      if (id === 'phone')    { el.required = true; el.autocomplete = 'tel'; el.setAttribute('inputmode','tel'); }

      wrap.append(l, el);
      area.appendChild(wrap);
      autoscroll();
      return el;
    }

    // ×˜×™×¤×™× ×’ ×©××›×‘×“ ×‘×™×˜×•×œ×™×
    function typingThenP(html, delay=800, trusted=true){
      const myToken = runToken;
      return new Promise(resolve=>{
        const t = document.createElement('div');
        t.className = 'typing-indicator';
        t.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
        area.appendChild(t); autoscroll();
        setTimeout(()=>{
          if (myToken !== runToken) return resolve(); // ×‘×•×˜×œ
          t.remove();
          trusted ? botHTML(html) : botText(html);
          resolve();
        }, delay);
      });
    }

    function showProcessing(text='×©×•×œ×— ×œ××–×›×™×¨×•×ªâ€¦'){
      const d = document.createElement('div');
      d.className = 'bubble bot processing';
      d.innerHTML = `<strong>${text}</strong><div class="progress"><div class="progress-bar"></div></div>`;
      area.appendChild(d); autoscroll();
      return () => d.remove();
    }

    /* ===== Utils ===== */
    const normalizeILPhone = raw => {
      let p=(raw||'').toString().trim().replace(/[^\d+]/g,'');
      if(p.startsWith('+972')) p='0'+p.slice(4);
      if(p.startsWith('972'))  p='0'+p.slice(3);
      return p;
    };
    const validILPhone = p => /^0\d{8,9}$/.test(p||'');

    async function sendToSheet(payload){
      const ctrl = new AbortController();
      const timer = setTimeout(()=>ctrl.abort(), 10000); // 10s
      try{
        const res = await fetch(SHEETS_WEBAPP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' }, // simple request (×œ×œ× preflight)
          body: JSON.stringify(payload),
          signal: ctrl.signal
        });
        let ok=false;
        try{ const j = await res.json(); ok = j?.ok === true; } catch { ok = res.ok; }
        return ok;
      }catch(e){
        console.error('Sheets error', e);
        return false;
      }finally{
        clearTimeout(timer);
      }
    }

    /* ===== ×‘×™×ª â€“ ×‘×—×™×¨×ª ×¤×¢×•×œ×” ===== */
    async function stepHome(){
      clear(); push(stepHome);
      await typingThenP('×”×™×™ ğŸ‘‹ ×× ××ª ×›×‘×¨ ×× ×•×™×” ××¦×œ× ×•, ××¤×©×¨ ×œ×‘×¦×¢ ×›××Ÿ ×¤×¢×•×œ×•×ª ×‘×—×©×‘×•×Ÿ. ××” ×ª×¨×¦×™ ×œ×¢×©×•×ª?', 700, true);

      button('×©×™× ×•×™ ×™×•×/×©×¢×” ×§×‘×•×¢×” ×©×œ ×©×™×¢×•×¨', stepReschedule);
      button('×‘×™×˜×•×œ ×©×™×¢×•×¨ ×¢×ª×™×“×™', stepCancel);
      button('×¢×“×›×•×Ÿ ×¤×¨×˜×™ ×ª×©×œ×•×', stepBilling);
      button('×©×œ×™×—×ª ×”×•×“×¢×” ×œ××–×›×™×¨×•×ª', stepMessage);
    }

    /* === ×¤×¢×•×œ×”: ×©×™× ×•×™ ×™×•×/×©×¢×” (availability) === */
    async function stepReschedule(){
      clear(); push(stepReschedule);

      // ×× ×˜×™-×§×¤×™×¦×”: ××¦×™×’×™× ×›×•×ª×¨×ª, ×’×•×œ×œ×™× ×œ×¨××©, ×•×¨×§ ××– ×‘×•× ×™× ××ª ×”×©×“×•×ª ×‘×”×©×”×™×” ×§×¦×¨×”
      disableAutoScroll();
      const header = botHTML('××™×Ÿ ×‘×¢×™×”! âœï¸<br><span class="muted">×›×ª×‘×™ ××ª ×”×™×•×/×”×©×¢×” ×”×—×“×©×™× ×©××ª××™××™× ×œ×š. × ×•×¡×™×£ ×’× ×¤×¨×˜×™ ×§×©×¨ ×œ××™×©×•×¨.</span>');
      scrollStart(header);
      setTimeout(()=> enableAutoScroll(), 450);

      await waitP(300);
      const when  = inputRow('×™×•× ×•×©×¢×” ××•×¢×“×¤×™×', { id:'when', placeholder:'×œ×“×•×’××”: ×©×œ×™×©×™ 18:00 ××• ×—××™×©×™ 16:00' });
      await waitP(150);
      const notes = inputRow('×¤×¨×˜×™× × ×•×¡×¤×™× (×¨×©×•×ª)', { textarea:true, id:'res_notes', placeholder:'×›×œ ×“×‘×¨ ×©×—×©×•×‘ ×©× ×“×¢' });
      await waitP(150);
      const name  = inputRow('×©× ××œ×', { id:'fullName', placeholder:'×œ×“×•×’××”: ×“× ×” ×œ×•×™' });
      await waitP(150);
      const tel   = inputRow('×˜×œ×¤×•×Ÿ ×œ×—×–×¨×”', { type:'tel', id:'phone', placeholder:'×œ×“×•×’××”: 0501234567' });

      when.focus({ preventScroll:true });

      await waitP(120);
      button('×”××©×š ×œ×¡×™×›×•×', ()=>{
        const payload = {
          path: '×× ×•×™×” ×§×™×™××ª â€“ ×¤×¢×•×œ×•×ª',
          cta: '×©×™× ×•×™ ×™×•×/×©×¢×” ×§×‘×•×¢×”',
          availability: (when.value||'').trim(),   // ×œ×¢××•×“×ª availability
          message: '',
          extraNotes: (notes.value||'').trim(),
          fullName: (name.value||'').trim(),
          phone: normalizeILPhone(tel.value||''),
          source: '×™×•×¡×˜×•×Ÿ â€“ ××ª×¨',
          status: '×œ×˜×™×¤×•×œ',
          createdAt: new Date().toISOString()
        };
        stepReview(payload, {required:['availability','fullName','phone']});
      }, 'btn primary');

      button('×—×–×¨×”', goBack);
    }

    /* === ×¤×¢×•×œ×”: ×‘×™×˜×•×œ ×©×™×¢×•×¨ â€” reason -> message === */
    async function stepCancel(){
      clear(); push(stepCancel);

      disableAutoScroll();
      const header = botHTML('××” ×”×ª××¨×™×š ×©×œ ×”×©×™×¢×•×¨ ×©×ª×¨×¦×™ ×œ×‘×˜×œ? ğŸ“…<br><span class="muted">× ×•×¡×™×£ ×’× ×¤×¨×˜×™ ×§×©×¨ ×›×“×™ ×©× ××©×¨ ×‘×”×•×“×¢×” ×—×•×–×¨×ª.</span>');
      scrollStart(header);
      setTimeout(()=> enableAutoScroll(), 450);

      await waitP(300);
      const date   = inputRow('×ª××¨×™×š/×©×¢×” ×©×œ ×”×©×™×¢×•×¨', { id:'date', placeholder:'×œ×“×•×’××”: 21/09 18:00' });
      await waitP(150);
      const reason = inputRow('×¡×™×‘×ª ×‘×™×˜×•×œ (×¨×©×•×ª)',  { textarea:true, id:'reason', placeholder:'×¨×©×•×ª: ×”×¡×‘×¨ ×§×¦×¨' });
      await waitP(150);
      const notes  = inputRow('×¤×¨×˜×™× × ×•×¡×¤×™× (×¨×©×•×ª)', { textarea:true, id:'cancel_notes', placeholder:'×›×œ ×“×‘×¨ ×©×—×©×•×‘ ×©× ×“×¢' });
      await waitP(150);
      const name   = inputRow('×©× ××œ×', { id:'fullName', placeholder:'×œ×“×•×’××”: ×“× ×” ×œ×•×™' });
      await waitP(150);
      const tel    = inputRow('×˜×œ×¤×•×Ÿ ×œ×—×–×¨×”', { type:'tel', id:'phone', placeholder:'×œ×“×•×’××”: 0501234567' });

      date.focus({ preventScroll:true });

      await waitP(120);
      button('×”××©×š ×œ×¡×™×›×•×', ()=>{
        const payload = {
          path: '×× ×•×™×” ×§×™×™××ª â€“ ×¤×¢×•×œ×•×ª',
          cta: '×‘×™×˜×•×œ ×©×™×¢×•×¨',
          lessonDate: (date.value||'').trim(),
          message: (reason.value||'').trim(),      // × ×›× ×¡ ×œ×¢××•×“×ª message
          extraNotes: (notes.value||'').trim(),
          fullName: (name.value||'').trim(),
          phone: normalizeILPhone(tel.value||''),
          source: '×™×•×¡×˜×•×Ÿ â€“ ××ª×¨',
          status: '×œ×˜×™×¤×•×œ',
          createdAt: new Date().toISOString()
        };
        stepReview(payload, {required:['lessonDate','fullName','phone']});
      }, 'btn primary');

      button('×—×–×¨×”', goBack);
    }

    /* === ×¤×¢×•×œ×”: ×¢×“×›×•×Ÿ ×¤×¨×˜×™ ×ª×©×œ×•× === */
    async function stepBilling(){
      clear(); push(stepBilling);

      disableAutoScroll();
      const header = botHTML('×›×“×™ ×œ×¢×“×›×Ÿ ×¤×¨×˜×™ ×ª×©×œ×•× â€” × ×¨×©×•× ×¤×¨×˜×™ ×§×©×¨ ×•× ×—×–×•×¨ ××œ×™×™×š ×œ×”××©×š ×˜×™×¤×•×œ ××™×©×™ ğŸ™');
      scrollStart(header);
      setTimeout(()=> enableAutoScroll(), 450);

      await waitP(300);
      const notes = inputRow('×¤×¨×˜×™× ×©×ª×¨×¦×™ ×©× ×“×¢ (×¨×©×•×ª)', { textarea:true, id:'bill_notes', placeholder:'×œ××©×œ: ×”×—×œ×¤×ª ×›×¨×˜×™×¡, ×©×™× ×•×™ ×××¦×¢×™ ×—×™×•×‘ ×•×›×•×³' });
      await waitP(150);
      const name  = inputRow('×©× ××œ×', { id:'fullName', placeholder:'×œ×“×•×’××”: ×“× ×” ×œ×•×™' });
      await waitP(150);
      const tel   = inputRow('×˜×œ×¤×•×Ÿ ×œ×—×–×¨×”', { type:'tel', id:'phone', placeholder:'×œ×“×•×’××”: 0501234567' });

      notes.focus({ preventScroll:true });

      await waitP(120);
      button('×”××©×š ×œ×¡×™×›×•×', ()=>{
        const payload = {
          path: '×× ×•×™×” ×§×™×™××ª â€“ ×¤×¢×•×œ×•×ª',
          cta: '×¢×“×›×•×Ÿ ×¤×¨×˜×™ ×ª×©×œ×•×',
          message: (notes.value||'').trim(),       // × ×›× ×¡ ×œ×¢××•×“×ª message
          extraNotes: '',
          fullName: (name.value||'').trim(),
          phone: normalizeILPhone(tel.value||''),
          source: '×™×•×¡×˜×•×Ÿ â€“ ××ª×¨',
          status: '×œ×˜×™×¤×•×œ',
          createdAt: new Date().toISOString()
        };
        stepReview(payload, {required:['fullName','phone']});
      }, 'btn primary');

      button('×—×–×¨×”', goBack);
    }

    /* === ×¤×¢×•×œ×”: ×”×•×“×¢×” ×œ××–×›×™×¨×•×ª === */
    async function stepMessage(){
      clear(); push(stepMessage);

      disableAutoScroll();
      const header = botHTML('××” ×ª×¨×¦×™ ×œ×›×ª×•×‘ ×œ××–×›×™×¨×•×ª ×©×œ× ×•? âœï¸');
      scrollStart(header);
      setTimeout(()=> enableAutoScroll(), 450);

      await waitP(300);
      const msg   = inputRow('×”×•×“×¢×”', { textarea:true, id:'msg', placeholder:'×›×ª×‘×™ ×›××Ÿ ×›×œ ×“×‘×¨ ×©×ª×¨×¦×™' });
      await waitP(150);
      const notes = inputRow('×¤×¨×˜×™× × ×•×¡×¤×™× (×¨×©×•×ª)', { textarea:true, id:'msg_notes', placeholder:'×× ×™×© ×¢×•×“ ×¤×¨×˜×™× ×—×©×•×‘×™×' });
      await waitP(150);
      const name  = inputRow('×©× ××œ×', { id:'fullName', placeholder:'×œ×“×•×’××”: ×“× ×” ×œ×•×™' });
      await waitP(150);
      const tel   = inputRow('×˜×œ×¤×•×Ÿ ×œ×—×–×¨×”', { type:'tel', id:'phone', placeholder:'×œ×“×•×’××”: 0501234567' });

      msg.focus({ preventScroll:true });

      await waitP(120);
      button('×”××©×š ×œ×¡×™×›×•×', ()=>{
        const payload = {
          path: '×× ×•×™×” ×§×™×™××ª â€“ ×¤×¢×•×œ×•×ª',
          cta: '×¤× ×™×™×” ×œ××–×›×™×¨×•×ª',
          message: (msg.value||'').trim(),
          extraNotes: (notes.value||'').trim(),
          fullName: (name.value||'').trim(),
          phone: normalizeILPhone(tel.value||''),
          source: '×™×•×¡×˜×•×Ÿ â€“ ××ª×¨',
          status: '×œ×˜×™×¤×•×œ',
          createdAt: new Date().toISOString()
        };
        stepReview(payload, {required:['message','fullName','phone']});
      }, 'btn primary');

      button('×—×–×¨×”', goBack);
    }

    /* ===== ×¡×™×›×•× ×•×©×œ×™×—×” (×‘×˜×•×— ×â€‘XSS) ===== */
    function stepReview(payload, rules){
      // ×•×œ×™×“×¦×™×” ××™× ×™××œ×™×ª
      const errors = [];
      (rules.required||[]).forEach(k=>{
        if(!payload[k] || (typeof payload[k]==='string' && !payload[k].trim())) errors.push(k);
      });
      if(payload.phone && !validILPhone(payload.phone)) errors.push('phone_invalid');

      if(errors.length){
        const e = errors[0];
        if(e==='phone' || e==='phone_invalid'){
          botText('××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ× ×ª×§×™×Ÿ ğŸ“ (×œ××©×œ 0501234567)').classList.add('err');
        }else{
          botText('×—×¡×¨ ×©×“×” × ×“×¨×©. ×× × ××œ××™ ×•× ×¡×™ ×©×•×‘.').classList.add('err');
        }
        return;
      }

      clear(); push(()=>stepReview(payload, rules));

      const h = botHTML('<strong>×¡×™×›×•× ×”×‘×§×©×”</strong><br><span class="muted">×‘×“×§×™ ×©×”×›×•×œ × ×›×•×Ÿ ×œ×¤× ×™ ×©×œ×™×—×”.</span>');
      scrollStart(h); // ×¨×•××™× ××ª ×ª×—×™×œ×ª ×”×¡×™×›×•×

      // ×‘× ×™×™×” ×™×“× ×™×ª ×›×“×™ ×œ× ×œ×”×–×¨×™×§ innerHTML ×©×œ ×˜×§×¡×˜ ××©×ª××©
      const card = document.createElement('div');
      card.className = 'bubble bot';
      const addLine = (label, val) => {
        if(!val) return;
        const row = document.createElement('div');
        const b   = document.createElement('strong'); b.textContent = label + ' ';
        const s   = document.createElement('span');  s.textContent = val;
        row.append(b, s);
        card.appendChild(row);
      };

      addLine('×¤×¢×•×œ×”:', payload.cta);
      addLine('×™×•×/×©×¢×” ××‘×•×§×©×™×:', payload.availability);
      addLine('×ª××¨×™×š/×©×¢×” ×œ×‘×™×˜×•×œ:', payload.lessonDate);
      addLine('×”×•×“×¢×”:', payload.message);
      addLine('×¤×¨×˜×™× × ×•×¡×¤×™×:', payload.extraNotes);
      addLine('×©× ××œ×:', payload.fullName);
      addLine('×˜×œ×¤×•×Ÿ ×œ×—×–×¨×”:', payload.phone);

      area.appendChild(card); autoscroll();

      const sendBtn = button('××™×©×•×¨ ×•×©×œ×™×—×” ×œ××–×›×™×¨×•×ª ğŸ“¤', async ()=>{
        // ×× ×™×¢×ª ×©×œ×™×—×” ×›×¤×•×œ×”
        [...area.querySelectorAll('button')].forEach(b=>b.disabled=true);

        const stopProcessing = showProcessing();

        const ok = await sendToSheet(payload);

        stopProcessing();
        clear();

        if(ok){
          const doneText = (payload.cta === '×¢×“×›×•×Ÿ ×¤×¨×˜×™ ×ª×©×œ×•×')
            ? '×”×‘×§×©×” ×œ×¢×“×›×•×Ÿ ×¤×¨×˜×™ ×ª×©×œ×•× × ×§×œ×˜×” âœ… × ×™×¦×•×¨ ××™×ª×š ×§×©×¨ ×‘×”×§×“× ×œ×”××©×š ×˜×™×¤×•×œ.'
            : '×”×‘×§×©×” × ×§×œ×˜×” ×•×”×•×¢×‘×¨×” ×œ××–×›×™×¨×•×ª âœ… × ×—×–×•×¨ ××œ×™×™×š ×‘×”×§×“×.';
          botText(doneText).classList.add('ok');
          const homeBtn = button('×—×–×¨×” ×œ×ª×¤×¨×™×˜ ×”×¨××©×™', ()=> location.href='../index.html', 'btn primary');
          homeBtn.focus();
        }else{
          botText('×œ× ×”×¦×œ×—× ×• ×œ×©××•×¨ ××ª ×”×‘×§×©×” âŒ ××¤×©×¨ ×œ× ×¡×•×ª ×©×•×‘ ××• ×œ×¤× ×•×ª ××œ×™× ×• ×‘×•×•××˜×¡××¤ 050â€‘9570866.').classList.add('err');
          const retry = button('×œ× ×¡×•×ª ×©×•×‘', ()=> stepReview(payload, rules), 'btn primary');
          button('×¢×¨×™×›×”', ()=> goBack());
          button('×œ×ª×¤×¨×™×˜ ×”×¨××©×™', ()=> location.href='../index.html');
          retry.focus();
        }
      }, 'btn primary');

      button('×¢×¨×™×›×”', ()=> { goBack(); });
    }

    // ×”×¤×¢×œ×”
    stepHome();
  </script>
</body>
</html>