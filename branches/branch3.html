<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>מנויה קיימת – פעולות</title>

  <!-- עיצוב בהיר אחיד -->
  <link rel="stylesheet" href="../styles.light.css?v=1" />
  <meta name="theme-color" content="#5b7cfa" />

  <style>
    /* גלילה אמיתית לאזור השיחה */
    #area{ overflow-y:auto; max-height:70vh; scroll-behavior:smooth }

    /* בוחר מועדים – פריסה אנכית גדולה וקריאה */
    .slots-grid{ display:grid; gap:10px }
    .slot-row{
      display:grid;
      grid-template-columns: 1fr;    /* אנכי: יום / משעה / עד שעה אחד מתחת לשני */
      gap:10px;
    }
    .slot-preview{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px }
    .slots-actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px }
    .chip.emph{ font-weight:700 }
    .x{ margin-inline-start:6px; border:none; background:transparent; cursor:pointer; font-size:14px }
    .row-error{ color:#b91c1c; font-size:.92rem; margin-top:4px }

    /* שדות/כפתורים מרובעים יותר וגדולים יותר */
    .input{ border-radius:10px !important; min-height:46px; font-size:16px }
    select.input{ padding-inline:10px; }
    .btn{ border-radius:12px }
    .btn.next-arrow::after{ content:" →"; font-weight:700; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">

      <!-- טופ־בר אחיד -->
      <div class="topbar">
        <button class="btn" onclick="location.href='../index.html'">לתפריט ראשי</button>
      </div>

      <!-- כותרת -->
      <div class="head">
        <div class="brand">
          <div class="logo">HB</div>
          <div class="title">מנויה קיימת – פעולות</div>
        </div>
      </div>

      <!-- אזור התוכן -->
      <div class="body chat-body" id="area" role="log" aria-live="polite" aria-atomic="false"></div>

      <!-- תחתית: חזרה + שאלות (FAQ) -->
      <div class="footer">
        <button id="backBtn" class="btn" disabled>חזרה</button>
        <a id="faqBtn" class="btn ghost" href="../faq.html" target="_blank" rel="noopener">יש לי שאלות</a>
        <span class="spacer"></span>
      </div>

    </div>
  </div>

  <!-- קבצים משותפים (כמו בענף 1/2) -->
  <script src="./js/config.js?v=2"></script>
  <script src="./js/chat-helpers.js?v=2"></script>

  <script>
    /* ===== FAQ context ===== */
    function setHelpContext(ctx){
      const btn = document.getElementById('faqBtn');
      if(!btn) return;
      const base = '../faq.html';
      btn.href = ctx ? `${base}?ctx=${encodeURIComponent(ctx)}` : base;
    }

    /* ===== ניווט אחורה דרך היסטוריית Chat ===== */
    const backBtn = document.getElementById('backBtn');
    backBtn.onclick = ()=> Chat.goBack?.();

    /* ===== בית – בחירת פעולה (לשון כללית + כותרת בראש) ===== */
    function stepHome(){
      setHelpContext('review');
      Chat.clear(); Chat.push(stepHome);

      const header = Chat.botHTML(
        '<strong>היי 👋</strong><br>' +
        'אם אתם מנויים/ות, אפשר לבצע כאן פעולות בחשבון. במה נוכל לעזור?'
      );
      Chat.scrollStartOf(header);

      Chat.button('שינוי יום/שעה קבועה של שיעור', stepRescheduleContactFirst, 'btn primary');
      Chat.button('ביטול שיעור עתידי', stepCancel);
      Chat.button('עדכון פרטי תשלום', stepBilling);
      Chat.button('שליחת הודעה למזכירות', stepMessage);
    }

    /* ===== שינוי יום/שעה – שלב 1: פרטי קשר (שם פרטי/משפחה/טלפון) ===== */
    async function stepRescheduleContactFirst(){
      setHelpContext('contact');
      Chat.clear(); Chat.push(stepRescheduleContactFirst);

      const contact = await Chat.askContact({
        titleHtml: '<strong>כמעט סיימנו 🙂</strong><br><span class="muted">נשמור פרטי קשר כדי לאשר את השינוי.</span>',
        nextText: 'המשך',
        requireLast: true,
        showBack: true
      });
      if(!contact) return;

      Chat.State.data.firstName = contact.firstName;
      Chat.State.data.lastName  = contact.lastName;
      Chat.State.data.phone     = contact.phone;

      stepReschedule(); // עכשיו בוחרים ימים ושעות
    }

    /* ===== שינוי יום/שעה – שלב 2: בחירת מועדים (עם copy החדש) ===== */
    async function stepReschedule(){
      setHelpContext('availability');
      Chat.clear(); Chat.push(stepReschedule);

      // כותרת
      Chat.botHTML(
        '<strong>שינוי יום/שעה קבועה</strong><br>' +
        '<span class="muted">בחרו כמה שיותר אפשרויות שנוחות לכם.</span>'
      );

      // שימוש בבוחר הכללי מה-helpers (כולל תיקון הסרת בחירה ראשונה)
      const picks = await Chat.pickAvailability({
        titleHtml: '<strong>בחירת ימים ושעות</strong>',
        tipText: 'בחרו כמה שיותר אפשרויות שנוחות לכם',
        continueText: 'המשך',
        allowBack: true
      });
      if(!picks) return; // חזרו אחורה

      stepRescheduleReview(picks.join('; '));
    }

    /* ===== שינוי יום/שעה – שלב 3: סיכום ושליחה ===== */
    function stepRescheduleReview(availabilitySummary){
      setHelpContext('review');
      Chat.clear(); Chat.push(()=>stepRescheduleReview(availabilitySummary));

      const h = Chat.botHTML('<strong>סיכום בקשה</strong><br><span class="muted">בדקו שהכול נכון לפני שליחה.</span>');
      Chat.scrollStartOf(h);

      const d = Chat.State.data;
      Chat.summaryCard([
        ['שם פרטי:', d.firstName],
        ['שם משפחה:', d.lastName],
        ['טלפון לחזרה:', d.phone],
        ['ימים ושעות מועדפים:', availabilitySummary]
      ]);

      Chat.button('אישור ושליחה למזכירות 📤', async ()=>{
        const stop = Chat.showProcessing();

        const ok = await Chat.sendLeadToSheet({
          path: 'מנויה קיימת – פעולות',
          cta: 'שינוי יום/שעה קבועה',
          availability: availabilitySummary,
          message: '',
          extraNotes: '',
          fullName: `${d.firstName||''} ${d.lastName||''}`.trim(),
          phone: d.phone || '',
          source: 'יוסטון – אתר',
          status: 'לטיפול',
          createdAt: new Date().toISOString()
        });

        stop();
        Chat.clear();

        const fname = (d.firstName||'').trim();
        if(ok){
          Chat.botText(`היי ${fname || 'שם פרטי'} הבקשה נקלטה והועברה למזכירות להמשך טיפול.\nאני אדאג שיחזרו אלייך 👨‍🚀`).classList.add('ok');
          const home = Chat.button('חזרה לתפריט הראשי', ()=> location.href='../index.html', 'btn');
          home.focus();
        }else{
          Chat.botText('לא הצלחנו לשמור את הבקשה ❌ ניתן לנסות שוב או לפנות בוואטסאפ 050‑9570866.').classList.add('err');
          Chat.button('לנסות שוב', ()=> stepRescheduleReview(availabilitySummary), 'btn primary');
          Chat.button('עריכה', ()=> Chat.goBack?.());
          Chat.button('לתפריט הראשי', ()=> location.href='../index.html');
        }
      }, 'btn primary');

      Chat.button('עריכה', ()=> Chat.goBack?.());
    }

    /* ===== ביטול שיעור ===== */
    function stepCancel(){
      setHelpContext('review');
      Chat.clear(); Chat.push(stepCancel);

      Chat.botHTML('מה התאריך של השיעור שתרצו לבטל? 📅');

      const date   = Chat.inputRow('תאריך/שעה של השיעור', { id:'date', placeholder:'לדוגמה: 21/09 18:00' });
      const reason = Chat.inputRow('סיבת ביטול (רשות)',  { textarea:true, id:'reason', placeholder:'הסבר קצר (אופציונלי)' });

      // פרטי קשר קצרים
      const first  = Chat.inputRow('שם פרטי',   { id:'fullName_first', placeholder:'לדוגמה: דנה' });
      const last   = Chat.inputRow('שם משפחה',  { id:'fullName_last',  placeholder:'לדוגמה: לוי' });
      const tel    = Chat.inputRow('טלפון לחזרה', { type:'tel', id:'phone', placeholder:'לדוגמה: 0501234567' });

      Chat.button('המשך לסיכום', ()=>{
        const payload = {
          path: 'מנויה קיימת – פעולות',
          cta: 'ביטול שיעור',
          lessonDate: (date.value||'').trim(),
          message: (reason.value||'').trim(),
          extraNotes: '',
          fullName: `${(first.value||'').trim()} ${(last.value||'').trim()}`.trim(),
          phone: Chat.normalizeILPhone(tel.value||''),
          source: 'יוסטון – אתר',
          status: 'לטיפול',
          createdAt: new Date().toISOString()
        };
        stepReviewGeneric(payload, {required:['lessonDate','fullName','phone']});
      }, 'btn primary');

      Chat.button('חזרה', ()=> Chat.goBack());
    }

    /* ===== עדכון פרטי תשלום ===== */
    function stepBilling(){
      setHelpContext('review');
      Chat.clear(); Chat.push(stepBilling);

      Chat.typingThen('כדי לעדכן פרטי תשלום — נשמור פרטי קשר ונחזור אליכם/ן להמשך טיפול אישי 🙏', 550, true);

      const notes = Chat.inputRow('פרטים שכדאי לדעת (רשות)', { textarea:true, id:'bill_notes', placeholder:'למשל: החלפת כרטיס, שינוי אמצעי חיוב וכו׳' });
      const first = Chat.inputRow('שם פרטי',   { id:'fullName_first', placeholder:'לדוגמה: דנה' });
      const last  = Chat.inputRow('שם משפחה',  { id:'fullName_last',  placeholder:'לדוגמה: לוי' });
      const tel   = Chat.inputRow('טלפון לחזרה', { type:'tel', id:'phone', placeholder:'לדוגמה: 0501234567' });

      Chat.button('המשך לסיכום', ()=>{
        const payload = {
          path: 'מנויה קיימת – פעולות',
          cta: 'עדכון פרטי תשלום',
          message: (notes.value||'').trim(),
          extraNotes: '',
          fullName: `${(first.value||'').trim()} ${(last.value||'').trim()}`.trim(),
          phone: Chat.normalizeILPhone(tel.value||''),
          source: 'יוסטון – אתר',
          status: 'לטיפול',
          createdAt: new Date().toISOString()
        };
        stepReviewGeneric(payload, {required:['fullName','phone']});
      }, 'btn primary');

      Chat.button('חזרה', ()=> Chat.goBack());
    }

    /* ===== הודעה למזכירות ===== */
    function stepMessage(){
      setHelpContext('review');
      Chat.clear(); Chat.push(stepMessage);

      Chat.typingThen('מה תרצו לכתוב למזכירות שלנו? ✍️', 550, true);

      const msg   = Chat.inputRow('הודעה', { textarea:true, id:'msg', placeholder:'כתבו כאן כל דבר שתרצו' });
      const notes = Chat.inputRow('פרטים נוספים (רשות)', { textarea:true, id:'msg_notes', placeholder:'אם יש עוד פרטים חשובים' });
      const first = Chat.inputRow('שם פרטי',   { id:'fullName_first', placeholder:'לדוגמה: דנה' });
      const last  = Chat.inputRow('שם משפחה',  { id:'fullName_last',  placeholder:'לדוגמה: לוי' });
      const tel   = Chat.inputRow('טלפון לחזרה', { type:'tel', id:'phone', placeholder:'לדוגמה: 0501234567' });

      Chat.button('המשך לסיכום', ()=>{
        const payload = {
          path: 'מנויה קיימת – פעולות',
          cta: 'פנייה למזכירות',
          message: (msg.value||'').trim(),
          extraNotes: (notes.value||'').trim(),
          fullName: `${(first.value||'').trim()} ${(last.value||'').trim()}`.trim(),
          phone: Chat.normalizeILPhone(tel.value||''),
          source: 'יוסטון – אתר',
          status: 'לטיפול',
          createdAt: new Date().toISOString()
        };
        stepReviewGeneric(payload, {required:['message','fullName','phone']});
      }, 'btn primary');

      Chat.button('חזרה', ()=> Chat.goBack());
    }

    /* ===== סיכום/שליחה כללי לשאר הפעולות ===== */
    function stepReviewGeneric(payload, rules){
      const errs=[];
      (rules.required||[]).forEach(k=>{
        if(!payload[k] || (typeof payload[k]==='string' && !payload[k].trim())) errs.push(k);
      });
      if(payload.phone && !Chat.validILPhone(payload.phone)) errs.push('phone_invalid');

      if(errs.length){
        const e=errs[0];
        if(e==='phone' || e==='phone_invalid'){
          Chat.botText('מספר טלפון לא תקין 📞 (למשל 0501234567)').classList.add('err');
        }else{
          Chat.botText('חסר שדה נדרש. אנא מלאו ונסו שוב.').classList.add('err');
        }
        return;
      }

      Chat.clear(); Chat.push(()=>stepReviewGeneric(payload, rules));

      const h = Chat.botHTML('<strong>סיכום הבקשה</strong><br><span class="muted">בדקו שהכול נכון לפני שליחה.</span>');
      Chat.scrollStartOf(h);

      Chat.summaryCard([
        ['פעולה:', payload.cta],
        ['תאריך/שעה לביטול:', payload.lessonDate],
        ['הודעה:', payload.message],
        ['פרטים נוספים:', payload.extraNotes],
        ['שם מלא:', payload.fullName],
        ['טלפון לחזרה:', payload.phone]
      ]);

      Chat.button('אישור ושליחה למזכירות 📤', async ()=>{
        const stop = Chat.showProcessing();
        const ok = await Chat.sendLeadToSheet(payload);
        stop();
        Chat.clear();

        const fname = (payload.fullName||'').trim().split(' ')[0] || 'שם פרטי';
        if(ok){
          Chat.botText(`היי ${fname} הבקשה נקלטה והועברה למזכירות להמשך טיפול.\nאני אדאג שיחזרו אלייך 👨‍🚀`).classList.add('ok');
          const home = Chat.button('חזרה לתפריט הראשי', ()=> location.href='../index.html', 'btn');
          home.focus();
        }else{
          Chat.botText('לא הצלחנו לשמור את הבקשה ❌ ניתן לנסות שוב או לפנות בוואטסאפ 050‑9570866.').classList.add('err');
          Chat.button('לנסות שוב', ()=> stepReviewGeneric(payload, rules), 'btn primary');
          Chat.button('עריכה', ()=> Chat.goBack?.());
          Chat.button('לתפריט הראשי', ()=> location.href='../index.html');
        }
      }, 'btn primary');

      Chat.button('עריכה', ()=> Chat.goBack?.());
    }

    // הפעלה
    stepHome();
  </script>
</body>
</html>