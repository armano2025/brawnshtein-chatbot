<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>×× ×•×™×” ×§×™×™××ª â€“ ×¤×¢×•×œ×•×ª</title>

  <link rel="stylesheet" href="../styles.css" />
  <meta name="theme-color" content="#2563eb" />
</head>
<body>
  <div class="wrap">
    <div class="card">
      <!-- ×›×•×ª×¨×ª -->
      <div class="head">
        <div class="brand">
          <div class="logo">HB</div>
          <div class="title">×× ×•×™×” ×§×™×™××ª â€“ ×¤×¢×•×œ×•×ª</div>
        </div>
      </div>

      <!-- ××–×•×¨ ×”×ª×•×›×Ÿ -->
      <div class="body" id="area"></div>

      <!-- ×›×¤×ª×•×¨×™ × ×™×•×•×˜ ×ª×—×ª×•× ×™× -->
      <div class="footer">
        <button id="backBtn" class="btn">×—×–×¨×”</button>
        <button id="homeBtn" class="btn primary" onclick="location.href='../index.html'">×œ×ª×¤×¨×™×˜ ×¨××©×™</button>
      </div>
    </div>
  </div>

  <script>
    /* ===== ×§×•× ×¤×™×’ ===== */
    const SHEETS_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbwnNKY0BeO5N2O9oWmr8ltCHr9fVdDdrXsL_3erastx4qdEqhCz1mYAhkvZETF-86CGnw/exec';

    /* ===== DOM/State ===== */
    const area    = document.getElementById('area');
    const backBtn = document.getElementById('backBtn');

    const state = {
      history: [],
    };
    const push   = fn => state.history.push(fn);
    const goBack = () => { if(state.history.length>1){ state.history.pop(); state.history.at(-1)(); } };
    backBtn.onclick = goBack;

    /* ===== UI helpers ===== */
    const clear = () => area.innerHTML = '';
    const autoscroll = () => { area.scrollTop = area.scrollHeight; };

    function bot(html){
      const d = document.createElement('div');
      d.className = 'bubble bot';
      d.innerHTML = html;
      area.appendChild(d);
      autoscroll();
      return d;
    }
    function user(html){
      const d = document.createElement('div');
      d.className = 'bubble user';
      d.innerHTML = html;
      area.appendChild(d);
      autoscroll();
      return d;
    }
    function button(text, onClick, cls='btn'){
      const b = document.createElement('button');
      b.className = cls;
      b.textContent = text;
      b.onclick = onClick;
      area.appendChild(b);
      autoscroll();
      return b;
    }
    function inputRow(label, {type='text', id, textarea=false, placeholder=''} = {}){
      const wrap = document.createElement('div');
      wrap.className = 'input-wrap bubble bot';
      const l = document.createElement('label'); l.textContent = label;
      let el;
      if(textarea){
        el = document.createElement('textarea'); el.className = 'textarea';
      }else{
        el = document.createElement('input'); el.type = type; el.className = 'input';
      }
      el.id = id; el.placeholder = placeholder; el.dir = 'rtl';
      wrap.append(l, el);
      area.appendChild(wrap);
      autoscroll();
      return el;
    }
    function typingThenP(text, delay=800){
      return new Promise(resolve=>{
        const t = document.createElement('div');
        t.className = 'typing-indicator';
        t.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
        area.appendChild(t);
        autoscroll();
        setTimeout(()=>{ t.remove(); bot(text); resolve(); }, delay);
      });
    }
    function showProcessing(text='×©×•×œ×— ×œ××–×›×™×¨×•×ªâ€¦'){
      const d = document.createElement('div');
      d.className = 'bubble bot processing';
      d.innerHTML = `<strong>${text}</strong><div class="progress"><div class="progress-bar"></div></div>`;
      area.appendChild(d);
      autoscroll();
      return () => d.remove();
    }

    /* ===== Utils ===== */
    const normalizeILPhone = raw => {
      let p=(raw||'').toString().trim().replace(/[^\d+]/g,'');
      if(p.startsWith('+972')) p='0'+p.slice(4);
      if(p.startsWith('972'))  p='0'+p.slice(3);
      return p;
    };
    const validILPhone = p => /^0\d{8,9}$/.test(p||'');

    async function sendToSheet(payload){
      try{
        const res = await fetch(SHEETS_WEBAPP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify(payload)
        });
        const j = await res.json().catch(()=>({ok:false}));
        return j.ok === true || res.ok;
      }catch(e){
        console.error('Sheets error', e);
        return false;
      }
    }

    /* ===== ×‘×™×ª â€“ ×‘×—×™×¨×ª ×¤×¢×•×œ×” ===== */
    async function stepHome(){
      clear(); push(stepHome);
      await typingThenP('×”×™×™ ğŸ‘‹ ×× ××ª ×›×‘×¨ ×× ×•×™×” ××¦×œ× ×•, ××¤×©×¨ ×œ×‘×¦×¢ ×›××Ÿ ×¤×¢×•×œ×•×ª ×‘×—×©×‘×•×Ÿ. ××” ×ª×¨×¦×™ ×œ×¢×©×•×ª?');

      button('×©×™× ×•×™ ×™×•×/×©×¢×” ×§×‘×•×¢×” ×©×œ ×©×™×¢×•×¨', stepReschedule);
      button('×‘×™×˜×•×œ ×©×™×¢×•×¨ ×¢×ª×™×“×™', stepCancel);
      button('×¢×“×›×•×Ÿ ×¤×¨×˜×™ ×ª×©×œ×•×', stepBilling);
      button('×©×œ×™×—×ª ×”×•×“×¢×” ×œ××–×›×™×¨×•×ª', stepMessage);
    }

    /* === ×¤×¢×•×œ×”: ×©×™× ×•×™ ×™×•×/×©×¢×” === */
    async function stepReschedule(){
      clear(); push(stepReschedule);
      await typingThenP('××™×Ÿ ×‘×¢×™×”! âœï¸ ×›×ª×‘×™ ××ª ×”×™×•×/×”×©×¢×” ×”×—×“×©×™× ×©××ª××™××™× ×œ×š. × ×•×¡×™×£ ×’× ×¤×¨×˜×™ ×§×©×¨ ×›×“×™ ×©× ×—×–×•×¨ ×œ××©×¨.');

      const when  = inputRow('×™×•× ×•×©×¢×” ××•×¢×“×¤×™×', { id:'when', placeholder:'×œ×“×•×’××”: ×©×œ×™×©×™ 18:00 ××• ×—××™×©×™ 16:00' });
      const notes = inputRow('×¤×¨×˜×™× × ×•×¡×¤×™× (×¨×©×•×ª)', { textarea:true, id:'res_notes', placeholder:'×›×œ ×“×‘×¨ ×©×—×©×•×‘ ×©× ×“×¢' });
      const name  = inputRow('×©× ××œ×', { id:'fullName', placeholder:'×œ×“×•×’××”: ×“× ×” ×œ×•×™' });
      const tel   = inputRow('×˜×œ×¤×•×Ÿ ×œ×—×–×¨×”', { type:'tel', id:'phone', placeholder:'×œ×“×•×’××”: 0501234567' });

      button('×”××©×š ×œ×¡×™×›×•×', ()=>{
        const payload = {
          path: '×× ×•×™×” ×§×™×™××ª â€“ ×¤×¢×•×œ×•×ª',
          cta: '×©×™× ×•×™ ×™×•×/×©×¢×” ×§×‘×•×¢×”',
          request: (when.value||'').trim(),
          message: '',                                // ×œ× × ×“×¨×© ×¤×”, × ×©××•×¨ ×¨×™×§ ×œ×¢×§×‘×™×•×ª
          extraNotes: (notes.value||'').trim(),       // ×¤×¨×˜×™× × ×•×¡×¤×™×
          fullName: (name.value||'').trim(),
          phone: normalizeILPhone(tel.value||''),
          source: '×™×•×¡×˜×•×Ÿ â€“ ××ª×¨',
          status: '×œ×˜×™×¤×•×œ',
          createdAt: new Date().toISOString()
        };
        return stepReview(payload, {required:['request','fullName','phone']});
      }, 'btn primary');

      button('×—×–×¨×”', goBack);
    }

    /* === ×¤×¢×•×œ×”: ×‘×™×˜×•×œ ×©×™×¢×•×¨ === */
    async function stepCancel(){
      clear(); push(stepCancel);
      await typingThenP('××” ×”×ª××¨×™×š ×©×œ ×”×©×™×¢×•×¨ ×©×ª×¨×¦×™ ×œ×‘×˜×œ? ğŸ“… × ×•×¡×™×£ ×’× ×¤×¨×˜×™ ×§×©×¨ ×›×“×™ ×©× ××©×¨ ×‘×”×•×“×¢×” ×—×•×–×¨×ª.');

      const date   = inputRow('×ª××¨×™×š/×©×¢×” ×©×œ ×”×©×™×¢×•×¨', { id:'date', placeholder:'×œ×“×•×’××”: 21/09 18:00' });
      const reason = inputRow('×¡×™×‘×ª ×‘×™×˜×•×œ (×¨×©×•×ª)',  { textarea:true, id:'reason', placeholder:'×¨×©×•×ª: ×”×¡×‘×¨ ×§×¦×¨' });
      const notes  = inputRow('×¤×¨×˜×™× × ×•×¡×¤×™× (×¨×©×•×ª)', { textarea:true, id:'cancel_notes', placeholder:'×›×œ ×“×‘×¨ ×©×—×©×•×‘ ×©× ×“×¢' });
      const name   = inputRow('×©× ××œ×', { id:'fullName', placeholder:'×œ×“×•×’××”: ×“× ×” ×œ×•×™' });
      const tel    = inputRow('×˜×œ×¤×•×Ÿ ×œ×—×–×¨×”', { type:'tel', id:'phone', placeholder:'×œ×“×•×’××”: 0501234567' });

      button('×”××©×š ×œ×¡×™×›×•×', ()=>{
        const payload = {
          path: '×× ×•×™×” ×§×™×™××ª â€“ ×¤×¢×•×œ×•×ª',
          cta: '×‘×™×˜×•×œ ×©×™×¢×•×¨',
          lessonDate: (date.value||'').trim(),
          reason: (reason.value||'').trim(),
          message: '',                                // ×œ× × ×“×¨×© ×›××Ÿ
          extraNotes: (notes.value||'').trim(),
          fullName: (name.value||'').trim(),
          phone: normalizeILPhone(tel.value||''),
          source: '×™×•×¡×˜×•×Ÿ â€“ ××ª×¨',
          status: '×œ×˜×™×¤×•×œ',
          createdAt: new Date().toISOString()
        };
        return stepReview(payload, {required:['lessonDate','fullName','phone']});
      }, 'btn primary');

      button('×—×–×¨×”', goBack);
    }

    /* === ×¤×¢×•×œ×”: ×¢×“×›×•×Ÿ ×¤×¨×˜×™ ×ª×©×œ×•× (×œ×œ× ×œ×™× ×§) === */
    async function stepBilling(){
      clear(); push(stepBilling);
      await typingThenP('×›×“×™ ×œ×¢×“×›×Ÿ ×¤×¨×˜×™ ×ª×©×œ×•×â€”× ××¡×•×£ ×××š ×¤×¨×˜×™ ×§×©×¨ ×•× ×—×–×™×¨ ××œ×™×™×š ×œ×”××©×š ×˜×™×¤×•×œ ××™×©×™ ğŸ™');

      const notes = inputRow('×¤×¨×˜×™× ×©×ª×¨×¦×™ ×©× ×“×¢ (×¨×©×•×ª)', { textarea:true, id:'bill_notes', placeholder:'×œ××©×œ: ×”×—×œ×¤×ª ×›×¨×˜×™×¡, ×©×™× ×•×™ ×××¦×¢×™ ×—×™×•×‘ ×•×›×•×³' });
      const name  = inputRow('×©× ××œ×', { id:'fullName', placeholder:'×œ×“×•×’××”: ×“× ×” ×œ×•×™' });
      const tel   = inputRow('×˜×œ×¤×•×Ÿ ×œ×—×–×¨×”', { type:'tel', id:'phone', placeholder:'×œ×“×•×’××”: 0501234567' });

      button('×”××©×š ×œ×¡×™×›×•×', ()=>{
        const payload = {
          path: '×× ×•×™×” ×§×™×™××ª â€“ ×¤×¢×•×œ×•×ª',
          cta: '×¢×“×›×•×Ÿ ×¤×¨×˜×™ ×ª×©×œ×•×',
          message: (notes.value||'').trim(),         // ×”×¢×¨×•×ª ×—×•×¤×©×™×•×ª
          extraNotes: '',                             // × ×©××•×¨ ×¢××•×“×” ×¢×§×‘×™×ª
          fullName: (name.value||'').trim(),
          phone: normalizeILPhone(tel.value||''),
          source: '×™×•×¡×˜×•×Ÿ â€“ ××ª×¨',
          status: '×œ×˜×™×¤×•×œ',
          createdAt: new Date().toISOString()
        };
        return stepReview(payload, {required:['fullName','phone']});
      }, 'btn primary');

      button('×—×–×¨×”', goBack);
    }

    /* === ×¤×¢×•×œ×”: ×”×•×“×¢×” ×œ××–×›×™×¨×•×ª === */
    async function stepMessage(){
      clear(); push(stepMessage);
      await typingThenP('××” ×ª×¨×¦×™ ×œ×›×ª×•×‘ ×œ××–×›×™×¨×•×ª ×©×œ× ×•? âœï¸');

      const msg   = inputRow('×”×•×“×¢×”', { textarea:true, id:'msg', placeholder:'×›×ª×‘×™ ×›××Ÿ ×›×œ ×“×‘×¨ ×©×ª×¨×¦×™' });
      const notes = inputRow('×¤×¨×˜×™× × ×•×¡×¤×™× (×¨×©×•×ª)', { textarea:true, id:'msg_notes', placeholder:'×× ×™×© ×¢×•×“ ×¤×¨×˜×™× ×—×©×•×‘×™×' });
      const name  = inputRow('×©× ××œ×', { id:'fullName', placeholder:'×œ×“×•×’××”: ×“× ×” ×œ×•×™' });
      const tel   = inputRow('×˜×œ×¤×•×Ÿ ×œ×—×–×¨×”', { type:'tel', id:'phone', placeholder:'×œ×“×•×’××”: 0501234567' });

      button('×”××©×š ×œ×¡×™×›×•×', ()=>{
        const payload = {
          path: '×× ×•×™×” ×§×™×™××ª â€“ ×¤×¢×•×œ×•×ª',
          cta: '×¤× ×™×™×” ×œ××–×›×™×¨×•×ª',
          message: (msg.value||'').trim(),
          extraNotes: (notes.value||'').trim(),
          fullName: (name.value||'').trim(),
          phone: normalizeILPhone(tel.value||''),
          source: '×™×•×¡×˜×•×Ÿ â€“ ××ª×¨',
          status: '×œ×˜×™×¤×•×œ',
          createdAt: new Date().toISOString()
        };
        return stepReview(payload, {required:['message','fullName','phone']});
      }, 'btn primary');

      button('×—×–×¨×”', goBack);
    }

    /* ===== ×¡×™×›×•× ×•×©×œ×™×—×” ===== */
    function stepReview(payload, rules){
      // ×•×œ×™×“×¦×™×” ××™× ×™××œ×™×ª
      const errors = [];
      (rules.required||[]).forEach(k=>{
        if(!payload[k] || (typeof payload[k]==='string' && !payload[k].trim())){
          errors.push(k);
        }
      });
      if(payload.phone && !validILPhone(payload.phone)) errors.push('phone_invalid');

      if(errors.length){
        const e = errors[0];
        if(e==='phone' || e==='phone_invalid'){
          bot('××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ× ×ª×§×™×Ÿ ğŸ“ (×œ××©×œ 0501234567)').classList.add('err');
        }else{
          bot('×—×¡×¨ ×©×“×” × ×“×¨×©. ×× × ××œ××™ ×•× ×¡×™ ×©×•×‘.').classList.add('err');
        }
        return;
      }

      clear(); push(()=>stepReview(payload, rules));
      bot('<strong>×¡×™×›×•× ×”×‘×§×©×”</strong><br><span class="muted">×‘×“×§×™ ×©×”×›×•×œ × ×›×•×Ÿ ×œ×¤× ×™ ×©×œ×™×—×”.</span>');

      const card = document.createElement('div');
      card.className = 'bubble bot';

      // ×ª×¦×•×’×ª ×¡×™×›×•× ×™×“×™×“×•×ª×™×ª
      const lines = [];
      if(payload.cta)        lines.push(`<strong>×¤×¢×•×œ×”:</strong> ${payload.cta}`);
      if(payload.request)    lines.push(`<strong>×™×•×/×©×¢×” ××‘×•×§×©×™×:</strong> ${payload.request}`);
      if(payload.lessonDate) lines.push(`<strong>×ª××¨×™×š/×©×¢×” ×œ×‘×™×˜×•×œ:</strong> ${payload.lessonDate}`);
      if(payload.reason)     lines.push(`<strong>×¡×™×‘×”:</strong> ${payload.reason}`);
      if(payload.message)    lines.push(`<strong>×”×•×“×¢×”:</strong> ${payload.message}`);
      if(payload.extraNotes) lines.push(`<strong>×¤×¨×˜×™× × ×•×¡×¤×™×:</strong> ${payload.extraNotes}`);
      if(payload.fullName)   lines.push(`<strong>×©× ××œ×:</strong> ${payload.fullName}`);
      if(payload.phone)      lines.push(`<strong>×˜×œ×¤×•×Ÿ ×œ×—×–×¨×”:</strong> ${payload.phone}`);

      card.innerHTML = lines.join('<br>');
      area.appendChild(card);

      const sendBtn = button('××™×©×•×¨ ×•×©×œ×™×—×” ×œ××–×›×™×¨×•×ª ğŸ“¤', async ()=>{
        // ×× ×™×¢×ª ×©×œ×™×—×” ×›×¤×•×œ×”
        [...area.querySelectorAll('button')].forEach(b=>b.disabled=true);

        const stopProcessing = showProcessing();

        const ok = await sendToSheet(payload);

        stopProcessing();
        clear();

        if(ok){
          const doneText = (payload.cta === '×¢×“×›×•×Ÿ ×¤×¨×˜×™ ×ª×©×œ×•×')
            ? '×”×‘×§×©×” ×œ×¢×“×›×•×Ÿ ×¤×¨×˜×™ ×ª×©×œ×•× × ×§×œ×˜×” âœ… × ×™×¦×•×¨ ××™×ª×š ×§×©×¨ ×‘×”×§×“× ×œ×”××©×š ×˜×™×¤×•×œ.'
            : '×”×‘×§×©×” × ×§×œ×˜×” ×•×”×•×¢×‘×¨×” ×œ××–×›×™×¨×•×ª âœ… × ×—×–×•×¨ ××œ×™×™×š ×‘×”×§×“×.';
          bot(doneText).classList.add('ok');
        }else{
          bot('×œ× ×”×¦×œ×—× ×• ×œ×©××•×¨ ××ª ×”×‘×§×©×” âŒ ××¤×©×¨ ×œ× ×¡×•×ª ×©×•×‘ ××• ×œ×¤× ×•×ª ××œ×™× ×• ×‘×•×•××˜×¡××¤ 050â€‘9570866.').classList.add('err');
        }

        button('×—×–×¨×” ×œ×ª×¤×¨×™×˜ ×”×¨××©×™', ()=> location.href='../index.html', 'btn primary');
      }, 'btn primary');

      button('×¢×¨×™×›×”', ()=> { goBack(); });
    }

    // ×”×¤×¢×œ×”
    stepHome();
  </script>
</body>
</html>