<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>×× ×•×™×” ×§×™×™××ª â€“ ×¤×¢×•×œ×•×ª</title>

  <!-- ×¢×™×¦×•×‘ ×‘×”×™×¨ ××—×™×“ -->
  <link rel="stylesheet" href="../styles.light.css?v=1" />
  <meta name="theme-color" content="#5b7cfa" />

  <style>
    /* ×—×™×–×•×§ ××§×•××™: ×’×œ×™×œ×” ×××™×ª×™×ª ×œ××–×•×¨ ×”×©×™×—×” */
    #area{ overflow-y:auto; max-height:70vh; scroll-behavior:smooth }

    /* ×¨×›×™×‘×™ ×‘×•×—×¨ ×”××•×¢×“×™× â€“ ×–×”×™× ×œ×¢× ×£ 1 */
    .slots-grid{ display:grid; gap:8px }
    .slot-row{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px }
    .slot-preview{ display:flex; flex-wrap:wrap; gap:6px; margin-top:8px }
    .slots-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:10px }
    .chip.emph{ font-weight:700 }
    .x{ margin-inline-start:6px; border:none; background:transparent; cursor:pointer; font-size:14px }
    .row-error{ color:#b91c1c; font-size:.88rem; margin-top:4px }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">

      <!-- ×˜×•×¤Ö¾×‘×¨ ××—×™×“ -->
      <div class="topbar">
        <button class="btn" onclick="location.href='../index.html'">×œ×ª×¤×¨×™×˜ ×¨××©×™</button>
      </div>

      <!-- ×›×•×ª×¨×ª -->
      <div class="head">
        <div class="brand">
          <div class="logo">HB</div>
          <div class="title">×× ×•×™×” ×§×™×™××ª â€“ ×¤×¢×•×œ×•×ª</div>
        </div>
      </div>

      <!-- ××–×•×¨ ×”×ª×•×›×Ÿ -->
      <div class="body chat-body" id="area" role="log" aria-live="polite" aria-atomic="false"></div>

      <!-- ×ª×—×ª×™×ª: ×—×–×¨×” + ×©××œ×•×ª (FAQ) -->
      <div class="footer">
        <button id="backBtn" class="btn" disabled>×—×–×¨×”</button>
        <a id="faqBtn" class="btn ghost" href="../faq.html" target="_blank" rel="noopener">×™×© ×œ×™ ×©××œ×•×ª</a>
        <span class="spacer"></span>
      </div>

    </div>
  </div>

  <!-- ×§×‘×¦×™× ××©×•×ª×¤×™× (×›××• ×‘×¢× ×£ 1/2) -->
  <script src="./js/config.js?v=2"></script>
  <script src="./js/chat-helpers.js?v=2"></script>

  <script>
    /* ===== FAQ context ===== */
    function setHelpContext(ctx){
      const btn = document.getElementById('faqBtn');
      if(!btn) return;
      const base = '../faq.html';
      btn.href = ctx ? `${base}?ctx=${encodeURIComponent(ctx)}` : base;
    }

    /* ===== × ×™×•×•×˜ ××—×•×¨×” ×“×¨×š ×”×™×¡×˜×•×¨×™×™×ª Chat ===== */
    const backBtn = document.getElementById('backBtn');
    backBtn.onclick = ()=> Chat.goBack?.();

    /* ===== ×‘×™×ª â€“ ×‘×—×™×¨×ª ×¤×¢×•×œ×” ===== */
    function stepHome(){
      setHelpContext('review');
      Chat.clear(); Chat.push(stepHome);

      Chat.typingThen(
        '<strong>×”×™×™ ğŸ‘‹</strong><br>' +
        '×× ××ª ×›×‘×¨ ×× ×•×™×”, ××¤×©×¨ ×œ×‘×¦×¢ ×›××Ÿ ×¤×¢×•×œ×•×ª ×‘×—×©×‘×•×Ÿ. ××” ×ª×¨×¦×™ ×œ×¢×©×•×ª?',
        600, true
      );

      Chat.button('×©×™× ×•×™ ×™×•×/×©×¢×” ×§×‘×•×¢×” ×©×œ ×©×™×¢×•×¨', stepReschedule, 'btn primary');
      Chat.button('×‘×™×˜×•×œ ×©×™×¢×•×¨ ×¢×ª×™×“×™', stepCancel);
      Chat.button('×¢×“×›×•×Ÿ ×¤×¨×˜×™ ×ª×©×œ×•×', stepBilling);
      Chat.button('×©×œ×™×—×ª ×”×•×“×¢×” ×œ××–×›×™×¨×•×ª', stepMessage);
    }

    /* ===== ×©×™× ×•×™ ×™×•×/×©×¢×” â€” ×‘×•×—×¨ ××•×¢×“×™× ×›××• ×‘×¢× ×£ 1 ===== */
    function stepReschedule(){
      setHelpContext('availability');
      Chat.clear(); Chat.push(stepReschedule);

      Chat.typingThen(
        '<strong>×©×™× ×•×™ ×™×•×/×©×¢×” ×§×‘×•×¢×”</strong><br>' +
        '<span class="muted">×‘×—×¨×™ ×™××™× ×•×©×¢×•×ª ××•×¢×“×¤×™×. ××¤×©×¨ ×œ×”×•×¡×™×£ ×›××” ××•×¢×“×™×.</span>',
        600, true
      );

      setTimeout(()=>{
        const area = document.getElementById('area');

        const wrap = document.createElement('div'); wrap.className='bubble bot wide';
        const grid = document.createElement('div'); grid.className='slots-grid';
        const rowsWrap = document.createElement('div'); rowsWrap.id='rowsWrap'; rowsWrap.className='slots-grid';
        const preview = document.createElement('div'); preview.className='slot-preview';

        const TIMES = ['','14:00','15:00','16:00','17:00','18:00','19:00','20:00'];
        const DAYS  = ['','×','×‘','×’','×“','×”'];
        const toNum = s => parseInt(String(s||'').replace(':',''),10) || 0;

        const makeSel = (placeholder, values)=>{
          const sel = document.createElement('select'); sel.className='input';
          values.forEach(v=>{
            const o=document.createElement('option');
            o.value=v; o.textContent = v ? `${placeholder} ${v}` : placeholder;
            sel.appendChild(o);
          });
          return sel;
        };

        const lastRowFilled = ()=>{
          const rows=[...rowsWrap.children];
          if(!rows.length) return false;
          const [dSel,fSel,tSel]=rows.at(-1).querySelectorAll('select');
          return dSel.value && fSel.value && tSel.value && toNum(fSel.value) < toNum(tSel.value);
        };

        const refreshPreview = ()=>{
          preview.innerHTML='';
          const rows=[...rowsWrap.children];
          rows.forEach(r=>{
            const [dSel,fSel,tSel]=r.querySelectorAll('select');
            const d=dSel.value, f=fSel.value, t=tSel.value;
            if(d && f && t && toNum(f) < toNum(t)){
              const chip = Chat.chip(`×™×•× ${d} ${f}â€“${t}`); chip.classList.add('emph');
              const x = document.createElement('button'); x.type='button'; x.className='x'; x.title='×”×¡×¨'; x.textContent='âœ–';
              x.onclick=()=>{ r.remove(); addBtn.disabled=!lastRowFilled(); refreshPreview(); };
              chip.appendChild(x);
              preview.appendChild(chip);
            }
          });
        };

        let btnContinue;
        const wireRow = (row)=>{
          row.querySelectorAll('select').forEach(sel=>{
            sel.addEventListener('change', ()=>{
              row.querySelector('.row-error')?.remove();
              const [ , fSel, tSel] = row.querySelectorAll('select');
              if(fSel.value && tSel.value && toNum(fSel.value) >= toNum(tSel.value)){
                const err=document.createElement('div'); err.className='row-error';
                err.textContent='×´×¢×“ ×©×¢×”×´ ×—×™×™×‘ ×œ×”×™×•×ª ××—×¨×™ ×´××©×¢×”×´'; row.appendChild(err);
              }
              addBtn.disabled = !lastRowFilled();
              if(btnContinue) btnContinue.disabled = false;
              refreshPreview();
            });
          });
        };

        const addRow = (force=false)=>{
          if(!force && !lastRowFilled()){
            Chat.botText('× ×™×ª×Ÿ ×œ×”×•×¡×™×£ ××•×¢×“ × ×•×¡×£ ×¨×§ ×œ××—×¨ ×©××™×œ××ª ××ª ×”××•×¢×“ ×”×§×•×“×.').classList.add('err');
            return;
          }
          const row=document.createElement('div'); row.className='slot-row';
          row.append(makeSel('×‘×—×¨/×™ ×™×•×',DAYS), makeSel('××©×¢×”',TIMES), makeSel('×¢×“ ×©×¢×”',TIMES));
          rowsWrap.appendChild(row);
          wireRow(row);
          addBtn.disabled=true;
          refreshPreview();
          area.scrollTop=area.scrollHeight;
          return row;
        };

        const title = document.createElement('div'); title.className='muted'; title.textContent='× ×™×ª×Ÿ ×œ×”×•×¡×™×£ ×™×•×ª×¨ ×××•×¢×“ ××—×“';
        const addBtn = document.createElement('button'); addBtn.className='btn'; addBtn.textContent='+ ×”×•×¡×¤×ª ××•×¢×“ × ×•×¡×£'; addBtn.disabled=true;
        addBtn.onclick = ()=> addRow(false);

        const actions = document.createElement('div'); actions.className='slots-actions';
        btnContinue = document.createElement('button'); btnContinue.className='btn primary'; btnContinue.textContent='×”××©×š';
        btnContinue.onclick = ()=>{
          Chat.userBubble('×”××©×š');
          const rows=[...rowsWrap.children]; const chosen=[];
          for(const r of rows){
            const [dSel,fSel,tSel]=r.querySelectorAll('select');
            const d=dSel.value, f=fSel.value, t=tSel.value;
            if(d && f && t){
              if(toNum(f) >= toNum(t)){ Chat.botText(`×‘××•×¢×“ ×™×•× ${d}: "×¢×“ ×©×¢×”" ×—×™×™×‘ ×œ×”×™×•×ª ××—×¨×™ "××©×¢×”" â±ï¸`).classList.add('err'); return; }
              chosen.push(`×™×•× ${d} ${f}â€“${t}`);
            }
          }
          if(!chosen.length){ Chat.botText('× ×“×¨×© ×œ×‘×—×•×¨ ×œ×¤×—×•×ª ××•×¢×“ ××—×“ ğŸ•’').classList.add('err'); return; }
          stepRescheduleContact(chosen.join('; '));
        };

        grid.append(title, rowsWrap, addBtn, preview);
        wrap.appendChild(grid);
        actions.appendChild(btnContinue);
        wrap.appendChild(actions);
        area.appendChild(wrap);

        addRow(true);
      }, 700);
    }

    function stepRescheduleContact(availabilitySummary){
      setHelpContext('contact');
      Chat.clear(); Chat.push(()=>stepRescheduleContact(availabilitySummary));

      Chat.typingThen('<strong>×›××¢×˜ ×¡×™×™×× ×•</strong><br><span class="muted">× ×•×¡×™×£ ×©× ××œ× ×•×˜×œ×¤×•×Ÿ ×œ××™×©×•×¨ ×”×©×™× ×•×™.</span>', 550, true);

      const name = Chat.inputRow('×©× ××œ×', { id:'fullName', placeholder:'×œ×“×•×’××”: ×“× ×” ×œ×•×™', required:true, autocomplete:'name' });
      const tel  = Chat.inputRow('×˜×œ×¤×•×Ÿ ×œ×—×–×¨×”', { type:'tel', id:'phone', placeholder:'×œ×“×•×’××”: 0501234567', required:true, autocomplete:'tel', inputmode:'tel' });

      Chat.button('×”××©×š ×œ×¡×™×›×•×', ()=>{
        const payload = {
          path: '×× ×•×™×” ×§×™×™××ª â€“ ×¤×¢×•×œ×•×ª',
          cta: '×©×™× ×•×™ ×™×•×/×©×¢×” ×§×‘×•×¢×”',
          availability: availabilitySummary,
          message: '',
          extraNotes: '',
          fullName: (name.value||'').trim(),
          phone: Chat.normalizeILPhone(tel.value||''),
          source: '×™×•×¡×˜×•×Ÿ â€“ ××ª×¨',
          status: '×œ×˜×™×¤×•×œ',
          createdAt: new Date().toISOString()
        };
        stepReview(payload, {required:['availability','fullName','phone']});
      }, 'btn primary');

      Chat.button('×—×–×¨×”', ()=> Chat.goBack());
    }

    /* ===== ×‘×™×˜×•×œ ×©×™×¢×•×¨ ===== */
    function stepCancel(){
      setHelpContext('review');
      Chat.clear(); Chat.push(stepCancel);

      Chat.botHTML('××” ×”×ª××¨×™×š ×©×œ ×”×©×™×¢×•×¨ ×©×ª×¨×¦×™ ×œ×‘×˜×œ? ğŸ“…');

      const date   = Chat.inputRow('×ª××¨×™×š/×©×¢×” ×©×œ ×”×©×™×¢×•×¨', { id:'date', placeholder:'×œ×“×•×’××”: 21/09 18:00' });
      const reason = Chat.inputRow('×¡×™×‘×ª ×‘×™×˜×•×œ (×¨×©×•×ª)',  { textarea:true, id:'reason', placeholder:'×”×¡×‘×¨ ×§×¦×¨ (××•×¤×¦×™×•× ×œ×™)' });
      const name   = Chat.inputRow('×©× ××œ×',             { id:'fullName', placeholder:'×œ×“×•×’××”: ×“× ×” ×œ×•×™' });
      const tel    = Chat.inputRow('×˜×œ×¤×•×Ÿ ×œ×—×–×¨×”',        { type:'tel', id:'phone', placeholder:'×œ×“×•×’××”: 0501234567' });

      Chat.button('×”××©×š ×œ×¡×™×›×•×', ()=>{
        const payload = {
          path: '×× ×•×™×” ×§×™×™××ª â€“ ×¤×¢×•×œ×•×ª',
          cta: '×‘×™×˜×•×œ ×©×™×¢×•×¨',
          lessonDate: (date.value||'').trim(),
          message: (reason.value||'').trim(),
          extraNotes: '',
          fullName: (name.value||'').trim(),
          phone: Chat.normalizeILPhone(tel.value||''),
          source: '×™×•×¡×˜×•×Ÿ â€“ ××ª×¨',
          status: '×œ×˜×™×¤×•×œ',
          createdAt: new Date().toISOString()
        };
        stepReview(payload, {required:['lessonDate','fullName','phone']});
      }, 'btn primary');

      Chat.button('×—×–×¨×”', ()=> Chat.goBack());
    }

    /* ===== ×¢×“×›×•×Ÿ ×¤×¨×˜×™ ×ª×©×œ×•× ===== */
    function stepBilling(){
      setHelpContext('review');
      Chat.clear(); Chat.push(stepBilling);

      Chat.typingThen('×›×“×™ ×œ×¢×“×›×Ÿ ×¤×¨×˜×™ ×ª×©×œ×•× â€” × ×©××•×¨ ×¤×¨×˜×™ ×§×©×¨ ×•× ×—×–×•×¨ ××œ×™×™×š ×œ×”××©×š ×˜×™×¤×•×œ ××™×©×™ ğŸ™', 550, true);

      const notes = Chat.inputRow('×¤×¨×˜×™× ×©×ª×¨×¦×™ ×©× ×“×¢ (×¨×©×•×ª)', { textarea:true, id:'bill_notes', placeholder:'×œ××©×œ: ×”×—×œ×¤×ª ×›×¨×˜×™×¡, ×©×™× ×•×™ ×××¦×¢×™ ×—×™×•×‘ ×•×›×•×³' });
      const name  = Chat.inputRow('×©× ××œ×', { id:'fullName', placeholder:'×œ×“×•×’××”: ×“× ×” ×œ×•×™' });
      const tel   = Chat.inputRow('×˜×œ×¤×•×Ÿ ×œ×—×–×¨×”', { type:'tel', id:'phone', placeholder:'×œ×“×•×’××”: 0501234567' });

      Chat.button('×”××©×š ×œ×¡×™×›×•×', ()=>{
        const payload = {
          path: '×× ×•×™×” ×§×™×™××ª â€“ ×¤×¢×•×œ×•×ª',
          cta: '×¢×“×›×•×Ÿ ×¤×¨×˜×™ ×ª×©×œ×•×',
          message: (notes.value||'').trim(),
          extraNotes: '',
          fullName: (name.value||'').trim(),
          phone: Chat.normalizeILPhone(tel.value||''),
          source: '×™×•×¡×˜×•×Ÿ â€“ ××ª×¨',
          status: '×œ×˜×™×¤×•×œ',
          createdAt: new Date().toISOString()
        };
        stepReview(payload, {required:['fullName','phone']});
      }, 'btn primary');

      Chat.button('×—×–×¨×”', ()=> Chat.goBack());
    }

    /* ===== ×”×•×“×¢×” ×œ××–×›×™×¨×•×ª ===== */
    function stepMessage(){
      setHelpContext('review');
      Chat.clear(); Chat.push(stepMessage);

      Chat.typingThen('××” ×ª×¨×¦×™ ×œ×›×ª×•×‘ ×œ××–×›×™×¨×•×ª ×©×œ× ×•? âœï¸', 550, true);

      const msg   = Chat.inputRow('×”×•×“×¢×”', { textarea:true, id:'msg', placeholder:'×›×ª×‘×™ ×›××Ÿ ×›×œ ×“×‘×¨ ×©×ª×¨×¦×™' });
      const notes = Chat.inputRow('×¤×¨×˜×™× × ×•×¡×¤×™× (×¨×©×•×ª)', { textarea:true, id:'msg_notes', placeholder:'×× ×™×© ×¢×•×“ ×¤×¨×˜×™× ×—×©×•×‘×™×' });
      const name  = Chat.inputRow('×©× ××œ×', { id:'fullName', placeholder:'×œ×“×•×’××”: ×“× ×” ×œ×•×™' });
      const tel   = Chat.inputRow('×˜×œ×¤×•×Ÿ ×œ×—×–×¨×”', { type:'tel', id:'phone', placeholder:'×œ×“×•×’××”: 0501234567' });

      Chat.button('×”××©×š ×œ×¡×™×›×•×', ()=>{
        const payload = {
          path: '×× ×•×™×” ×§×™×™××ª â€“ ×¤×¢×•×œ×•×ª',
          cta: '×¤× ×™×™×” ×œ××–×›×™×¨×•×ª',
          message: (msg.value||'').trim(),
          extraNotes: (notes.value||'').trim(),
          fullName: (name.value||'').trim(),
          phone: Chat.normalizeILPhone(tel.value||''),
          source: '×™×•×¡×˜×•×Ÿ â€“ ××ª×¨',
          status: '×œ×˜×™×¤×•×œ',
          createdAt: new Date().toISOString()
        };
        stepReview(payload, {required:['message','fullName','phone']});
      }, 'btn primary');

      Chat.button('×—×–×¨×”', ()=> Chat.goBack());
    }

    /* ===== ×¡×™×›×•× ×•×©×œ×™×—×” (×“×¨×š Chat.sendLeadToSheet) ===== */
    function stepReview(payload, rules){
      const errs=[];
      (rules.required||[]).forEach(k=>{
        if(!payload[k] || (typeof payload[k]==='string' && !payload[k].trim())) errs.push(k);
      });
      if(payload.phone && !Chat.validILPhone(payload.phone)) errs.push('phone_invalid');

      if(errs.length){
        const e=errs[0];
        if(e==='phone' || e==='phone_invalid'){
          Chat.botText('××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ× ×ª×§×™×Ÿ ğŸ“ (×œ××©×œ 0501234567)').classList.add('err');
        }else{
          Chat.botText('×—×¡×¨ ×©×“×” × ×“×¨×©. ×× × ××œ××™ ×•× ×¡×™ ×©×•×‘.').classList.add('err');
        }
        return;
      }

      Chat.clear(); Chat.push(()=>stepReview(payload, rules));

      const h = Chat.botHTML('<strong>×¡×™×›×•× ×”×‘×§×©×”</strong><br><span class="muted">×‘×“×§×™ ×©×”×›×•×œ × ×›×•×Ÿ ×œ×¤× ×™ ×©×œ×™×—×”.</span>');
      Chat.scrollStartOf(h);

      const card = document.createElement('div'); card.className='bubble bot';
      const row = (label, val)=>{ if(!val) return; const d=document.createElement('div'); const b=document.createElement('strong'); b.textContent=label+' '; const s=document.createElement('span'); s.textContent=val; d.append(b,s); card.appendChild(d); };
      row('×¤×¢×•×œ×”:', payload.cta);
      row('×™×•×/×©×¢×” ××‘×•×§×©×™×:', payload.availability);
      row('×ª××¨×™×š/×©×¢×” ×œ×‘×™×˜×•×œ:', payload.lessonDate);
      row('×”×•×“×¢×”:', payload.message);
      row('×¤×¨×˜×™× × ×•×¡×¤×™×:', payload.extraNotes);
      row('×©× ××œ×:', payload.fullName);
      row('×˜×œ×¤×•×Ÿ ×œ×—×–×¨×”:', payload.phone);
      document.getElementById('area').appendChild(card);
      (function(){ const a=document.getElementById('area'); a.scrollTop=a.scrollHeight; })();

      Chat.button('××™×©×•×¨ ×•×©×œ×™×—×” ×œ××–×›×™×¨×•×ª ğŸ“¤', async ()=>{
        const stop = Chat.showProcessing();

        const ok = await Chat.sendLeadToSheet(payload);

        stop();
        Chat.clear();

        if(ok){
          Chat.botText('×”×‘×§×©×” × ×§×œ×˜×” ×•×”×•×¢×‘×¨×” ×œ××–×›×™×¨×•×ª âœ… × ×—×–×•×¨ ××œ×™×™×š ×‘×”×§×“×.').classList.add('ok');
          const home = Chat.button('×—×–×¨×” ×œ×ª×¤×¨×™×˜ ×”×¨××©×™', ()=> location.href='../index.html', 'btn');
          home.focus();
        }else{
          Chat.botText('×œ× ×”×¦×œ×—× ×• ×œ×©××•×¨ ××ª ×”×‘×§×©×” âŒ ××¤×©×¨ ×œ× ×¡×•×ª ×©×•×‘ ××• ×œ×¤× ×•×ª ××œ×™× ×• ×‘×•×•××˜×¡××¤ 050â€‘9570866.').classList.add('err');
          Chat.button('×œ× ×¡×•×ª ×©×•×‘', ()=> stepReview(payload, rules), 'btn primary');
          Chat.button('×¢×¨×™×›×”', ()=> Chat.goBack?.());
          Chat.button('×œ×ª×¤×¨×™×˜ ×”×¨××©×™', ()=> location.href='../index.html');
        }
      }, 'btn primary');

      Chat.button('×¢×¨×™×›×”', ()=> Chat.goBack?.());
    }

    // ×”×¤×¢×œ×”
    stepHome();
  </script>
</body>
</html>