<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>מנוי חודשי – פרטים והרשמה</title>

  <!-- עיצוב גלובלי בהיר ואחיד -->
  <link rel="stylesheet" href="../styles.light.css?v=1" />
  <meta name="theme-color" content="#5b7cfa" />
</head>
<body>
  <div class="wrap">
    <div class="card">

      <!-- טופ־בר יוניפייד -->
      <div class="topbar">
        <button class="btn" onclick="location.href='../index.html'">לתפריט ראשי</button>
      </div>

      <!-- כותרת -->
      <div class="head">
        <div class="brand">
          <div class="logo">HB</div>
          <div class="title">מנוי חודשי – פרטים והרשמה</div>
        </div>
      </div>

      <!-- אזור התוכן -->
      <div class="body chat-body" id="area" role="log" aria-live="polite" aria-atomic="false"></div>

      <!-- תחתית -->
      <div class="footer">
        <button id="backBtn" class="btn" disabled>חזרה</button>
        <a id="faqBtn" class="btn ghost" href="../faq.html" target="_blank" rel="noopener">יש לי שאלות</a>
        <span class="spacer"></span>
      </div>

    </div>
  </div>

  <!-- סקריפטים משותפים (כמו בענף 1) -->
  <script src="./js/config.js?v=2"></script>
  <script src="./js/chat-helpers.js?v=2"></script>

  <script>
    /* ===== התאמת כפתור ה‑FAQ לפי הקשר ===== */
    function setHelpContext(ctx){
      const btn = document.getElementById('faqBtn');
      if(!btn) return;
      const base = '../faq.html';
      btn.href = ctx ? `${base}?ctx=${encodeURIComponent(ctx)}` : base;
    }

    /* ===== קישורים ותלויות (נשתמש בקונפיג אם קיים, אחרת fallback) ===== */
    const REG_LINK   = (window.Chat?.cfg?.REG_LINK)   || 'https://wordpress-1184560-4777160.cloudwaysapps.com/';
    const TERMS_LINK = (window.Chat?.cfg?.TERMS_LINK) || 'https://forms.gle/orUvvLrrSuCGAPVVA';

    /* ===== זרימה ===== */
    function start(){
      setHelpContext('plan');    // עזרה כללית על מסלולים/מנוי
      Chat.clear(); Chat.push(start);

      Chat.typingThen(
        '<strong>היי! מנוי חודשי במרכז בראונשטיין 👨‍🚀</strong><br>' +
        'כמה פרטים מהירים כדי שנוכל לחזור אלייך, ואז נסביר איך זה עובד.',
        700, true
      );

      setTimeout(stepLead, 900);
    }

    // שלב 1 — פרטי קשר (שם מלא, טלפון, הערות רשות)
    function stepLead(){
      setHelpContext('contact');
      Chat.clear(); Chat.push(stepLead);

      const anchor = Chat.botHTML('<span class="muted">פרטי קשר</span>');
      Chat.scrollStartOf(anchor);

      const fullName = Chat.inputRow('שם מלא', {
        id:'fullName', placeholder:'לדוגמה: דנה לוי', required:true, autocomplete:'name'
      });
      const phone = Chat.inputRow('טלפון לחזרה', {
        type:'tel', id:'phone', placeholder:'לדוגמה: 0501234567', required:true, autocomplete:'tel', inputmode:'tel'
      });
      const notes = Chat.inputRow('הערות (לא חובה)', {
        textarea:true, id:'lead_notes', placeholder:'כל דבר שחשוב שנדע'
      });

      const next = Chat.button('המשך', async ()=>{
        Chat.userBubble('המשך');

        const fn  = (fullName.value||'').trim();
        const tel = Chat.normalizeILPhone(phone.value||'');

        if(!fn){  Chat.botText('יש להזין שם מלא ✏️').classList.add('err'); fullName.focus(); return; }
        if(!Chat.validILPhone(tel)){ Chat.botText('מספר טלפון לא תקין 📞').classList.add('err'); phone.focus(); return; }

        const stop = Chat.showProcessing('שומר למזכירות…');

        const ok = await Chat.sendLeadToSheet({
          path: 'מנוי חודשי – התעניינות',
          fullName: fn,
          phone: tel,
          message: (notes.value||'').trim(),
          extraNotes: '',
          cta: 'התעניינות במנוי חודשי',
          source: 'יוסטון – אתר',
          status: 'לטיפול',
          createdAt: new Date().toISOString()
        });

        stop();
        if(ok){
          Chat.botText('הפרטים נשמרו בהצלחה ✅').classList.add('ok');
          setTimeout(stepAbout, 500);
        }else{
          Chat.botText('לא הצלחנו לשמור את הפרטים ❌ אפשר לנסות שוב או לפנות אלינו בוואטסאפ 050‑9570866.').classList.add('err');
          next.disabled = false;
        }
      }, 'btn primary');

      // הפעלה מחדש של הכפתור אחרי תיקון קלט
      ;[fullName, phone, notes].forEach(el=>{
        el.addEventListener('input', ()=>{ next.disabled = false; });
      });
    }

    // שלב 2 — איך עובדים
    function stepAbout(){
      setHelpContext('plan');
      Chat.clear(); Chat.push(stepAbout);

      Chat.botHTML(
        '<strong>איך זה עובד אצלנו?</strong><br>' +
        '• כל שיעור נמשך <strong>50 דקות</strong> ומתחיל בשעה עגולה.<br>' +
        '• משלבים חיזוק חומר כיתתי, שיעורי בית, הכנה למבחנים ובניית ביטחון.<br>' +
        '• אפשר להתקדם בקצב האישי, ואנו מתאימים את הרמה לכל תלמיד/ה 🎯'
      );

      Chat.button('המשך', stepPrices, 'btn primary');
      Chat.button('חזרה', ()=>Chat.goBack?.() || history.back());
    }

    // שלב 3 — מסלולים ומחירים (נמשך מהקונפיג אם קיים)
    function stepPrices(){
      setHelpContext('plan');
      Chat.clear(); Chat.push(stepPrices);

      const P = Chat.cfg?.PRICES || { group: 295, triple: 385, private: 0 };

      Chat.botHTML(
        '<strong>מסלולים ומחירים</strong><br>' +
        `• קבוצתי (עד 5 תלמידים): <strong>${P.group} ₪ / חודש</strong><br>` +
        `• טריפל (עד 3 תלמידים): <strong>${P.triple} ₪ / חודש</strong><br><br>` +
        'רוצה לטעום לפני שמתחייבים?<br>' +
        '<strong>שיעור חד־פעמי</strong> על בסיס מקום פנוי: 80 ₪ (קבוצתי) / 100 ₪ (טריפל).'
      );

      Chat.button('המשך', stepRegister, 'btn primary');
      Chat.button('חזרה', ()=>Chat.goBack?.() || history.back());
    }

    // שלב 4 — הרשמה / חלופות
    function stepRegister(){
      setHelpContext('review');   // ב‑FAQ יש גם פרק Review/הרשמה
      Chat.clear(); Chat.push(stepRegister);

      Chat.botText('להצטרפות מהירה למנוי – פתחי את טופס הרישום (למילוי קצר):');

      Chat.button('פתח/י את טופס הרישום 📝', ()=>{
        Chat.userBubble('פתח/י את טופס הרישום');
        window.open(REG_LINK, '_blank', 'noopener,noreferrer');
      }, 'btn primary');

      Chat.button('אשלים/ה את הטופס מאוחר יותר ⏳', ()=>{
        Chat.userBubble('אשלים/ה מאוחר יותר');
        Chat.typingThen('סגור 🙂 שמרתי את הפרטים ונחזור אלייך בהקדם.', 650, true);
      });

      Chat.button('במקום זאת: שיעור חד־פעמי עכשיו', ()=>{
        Chat.userBubble('שיעור חד־פעמי');
        setTimeout(()=> location.href='./branch1.html', 200);
      });

      // קישור לתקנון – אופציונלי
      const s = document.createElement('div'); s.className='summary';
      s.appendChild(Chat.chip('קישור לתקנון'));
      const a = document.createElement('a');
      a.href = TERMS_LINK; a.target='_blank'; a.rel='noopener';
      a.textContent = 'תנאי התקנון';
      a.style.marginInlineStart = '6px';
      const wrap = document.createElement('div'); wrap.className='bubble bot'; wrap.appendChild(a);
      document.getElementById('area').appendChild(s);
      document.getElementById('area').appendChild(wrap);
      (function(){ const a=document.getElementById('area'); a.scrollTop=a.scrollHeight; })();

      Chat.button('חזרה', ()=>Chat.goBack?.() || history.back());
    }

    // הפעלה
    start();
  </script>
</body>
</html>