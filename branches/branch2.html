<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>×× ×•×™ ×—×•×“×©×™ â€“ ×¤×¨×˜×™× ×•×”×¨×©××”</title>

  <link rel="stylesheet" href="../styles.css?v=3" />
  <meta name="theme-color" content="#2563eb" />
  <style>
    /* ××‘×˜×™×— ×’×œ×™×œ×” ×‘×¤×•×¢×œ ×œ××–×•×¨ ×”×©×™×—×” */
    #area { overflow-y:auto; max-height:70vh; scroll-behavior:smooth; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <!-- ×›×•×ª×¨×ª -->
      <div class="head">
        <div class="brand">
          <div class="logo">HB</div>
          <div class="title">×× ×•×™ ×—×•×“×©×™ â€“ ×¤×¨×˜×™×</div>
        </div>
      </div>

      <!-- ××–×•×¨ ×”×ª×•×›×Ÿ -->
      <div class="body chat-body" id="area" role="log" aria-live="polite" aria-atomic="false"></div>

      <!-- ×›×¤×ª×•×¨×™ × ×™×•×•×˜ ×ª×—×ª×•× ×™× -->
      <div class="footer">
        <button id="backBtn" class="btn" disabled>×—×–×¨×”</button>
        <button id="homeBtn" class="btn primary" onclick="location.href='../index.html'">×œ×ª×¤×¨×™×˜ ×¨××©×™</button>
      </div>
    </div>
  </div>

  <script>
    /* ===== ×§×•× ×¤×™×’ ===== */
    const SHEETS_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbwnNKY0BeO5N2O9oWmr8ltCHr9fVdDdrXsL_3erastx4qdEqhCz1mYAhkvZETF-86CGnw/exec';
    const ORIGAMI_URL = 'https://wordpress-1184560-4777160.cloudwaysapps.com/';

    /* ===== DOM/State ===== */
    const area    = document.getElementById('area');
    const backBtn = document.getElementById('backBtn');

    const state = {
      history: [],
      lead: { fullName: null, phone: null, message: '' }
    };

    // ×‘×™×˜×•×œ ×˜×™×™××¨×™× ×–×•××‘×™× + ×©×œ×™×˜×” ×‘×’×œ×™×œ×”
    let runToken = 0;
    let autoScrollEnabled = true;
    const enableAutoScroll  = () => (autoScrollEnabled = true);
    const disableAutoScroll = () => (autoScrollEnabled = false);

    const last = () => state.history[state.history.length - 1];
    const push = fn => { state.history.push(fn); updateBack(); };
    const goBack = () => {
      if (state.history.length > 1) {
        state.history.pop();
        updateBack();
        runToken++;     // ××‘×˜×œ timeouts ×©×œ ××¡×›×™× ×§×•×“××™×
        last()();
      }
    };
    backBtn.onclick = goBack;
    function updateBack(){ backBtn.disabled = state.history.length <= 1; }

    /* ===== UI helpers ===== */
    const clear       = () => { runToken++; area.innerHTML = ''; };
    const autoscroll  = () => { if (autoScrollEnabled) area.scrollTop = area.scrollHeight; };
    const scrollStart = el => el?.scrollIntoView({ block:'start', behavior:'smooth' });
    const waitP       = ms => new Promise(r=>setTimeout(r, ms));

    // ×”×•×“×¢×•×ª ×‘×•×˜ ×××™× ×•×ª (HTML ×©×œ× ×•) ××•×œ ×˜×§×¡×˜ ×‘×˜×•×—
    function botHTML(html){
      const d=document.createElement('div'); d.className='bubble bot';
      d.innerHTML=html; area.appendChild(d); autoscroll(); return d;
    }
    function botText(text){
      const d=document.createElement('div'); d.className='bubble bot';
      d.textContent=text; area.appendChild(d); autoscroll(); return d;
    }
    function userText(text){
      const d=document.createElement('div'); d.className='bubble user';
      d.textContent=text; area.appendChild(d); autoscroll(); return d;
    }

    function button(text, onClick, cls='btn'){
      const b=document.createElement('button');
      b.className=cls; b.textContent=text;
      b.onclick=()=>{ b.disabled=true; onClick(); };   // ××•× ×¢ ×“××‘×œ-×§×œ×™×§ ×œ×™×—×™×“
      area.appendChild(b); autoscroll(); return b;
    }

    function inputRow(label, {type='text', id, placeholder='', required=false, autocomplete, inputmode} = {}){
      const wrap=document.createElement('div'); wrap.className='input-wrap bubble bot';
      const l=document.createElement('label'); l.textContent=label; if(id) l.htmlFor=id;
      const el=document.createElement('input');
      el.type=type; el.className='input'; el.id=id; el.placeholder=placeholder; el.dir='rtl';
      if(required) el.required=true;
      if(autocomplete) el.autocomplete=autocomplete;
      if(inputmode) el.setAttribute('inputmode', inputmode);
      wrap.append(l, el); area.appendChild(wrap); autoscroll(); return el;
    }
    function textareaRow(label, {id, placeholder=''} = {}){
      const wrap=document.createElement('div'); wrap.className='input-wrap bubble bot';
      const l=document.createElement('label'); l.textContent=label; if(id) l.htmlFor=id;
      const el=document.createElement('textarea'); el.className='textarea'; el.id=id; el.placeholder=placeholder; el.dir='rtl';
      wrap.append(l, el); area.appendChild(wrap); autoscroll(); return el;
    }

    // typing -> ×”×•×“×¢×ª ×‘×•×˜ (××›×‘×“ ×‘×™×˜×•×œ×™×)
    function typingThenP(html, delay=800, trusted=true){
      const myToken = runToken;
      return new Promise(resolve=>{
        const t=document.createElement('div');
        t.className='typing-indicator';
        t.innerHTML='<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
        area.appendChild(t); autoscroll();
        setTimeout(()=>{
          if(myToken!==runToken) return resolve();
          t.remove();
          trusted ? botHTML(html) : botText(html);
          resolve();
        }, delay);
      });
    }

    // â€œ×©×•××¨â€¦â€ ×¢× ×¤×¡ ×”×ª×§×“××•×ª
    function showProcessing(text='×©×•××¨ ×œ××–×›×™×¨×•×ªâ€¦'){
      const d=document.createElement('div'); d.className='bubble bot processing';
      d.innerHTML=`<strong>${text}</strong><div class="progress"><div class="progress-bar"></div></div>`;
      area.appendChild(d); autoscroll(); return ()=>d.remove();
    }

    /* ===== Utils ===== */
    const normalizeILPhone = raw => {
      let p=(raw||'').toString().trim().replace(/[^\d+]/g,'');
      if(p.startsWith('+972')) p='0'+p.slice(4);
      if(p.startsWith('972'))  p='0'+p.slice(3);
      return p;
    };
    const validILPhone = p => /^0\d{8,9}$/.test(p||'');

    async function sendToSheet(payload){
      const ctrl=new AbortController();
      const timer=setTimeout(()=>ctrl.abort(),10000);
      try{
        const res=await fetch(SHEETS_WEBAPP_URL,{
          method:'POST',
          headers:{'Content-Type':'text/plain'}, // simple request (×‘×œ×™ preflight)
          body:JSON.stringify(payload),
          signal:ctrl.signal
        });
        let ok=false;
        try{ const j=await res.json(); ok = j?.ok===true; } catch{ ok = res.ok; }
        return ok;
      }catch(e){
        console.error('Sheets error', e);
        return false;
      }finally{
        clearTimeout(timer);
      }
    }

    /* ===== ×–×¨×™××” ===== */

    // ×©×œ×‘ 0 â€“ ×¤×ª×™×—×” + ×˜×•×¤×¡ ×§×¦×¨ (×©×+×˜×œ×¤×•×Ÿ+×”×¢×¨×•×ª ×¨×©×•×ª)
    async function start(){
      clear(); push(start);

      await typingThenP(
        '××¢×•×œ×”! ××©××— ×œ×¢×–×•×¨ ×œ×š ×œ×”×§×™× ×× ×•×™ ×‘××¨×›×– ×”×œ××™×“×” ×©×œ ×—×Ÿ ×‘×¨××•× ×©×˜×™×™×Ÿ ğŸ‘¨â€ğŸš€<br>' +
        '×œ×¤× ×™ ×©× ×ª×—×™×œ â€“ ××©××•×¨ ×¤×¨×˜×™ ×§×©×¨ ×›×“×™ ×©× ×•×›×œ ×œ×—×–×•×¨ ××œ×™×™×š:',
        800, /* trusted */ true
      );

      // ×× ×˜×™-×§×¤×™×¦×”: × ×¦×™×’ ×›×•×ª×¨×ª/×”× ×—×™×”, × ×’×œ×•×œ ×œ×¨××©, ×•××– × ×‘× ×” ××ª ×”×©×“×•×ª ×‘×”×“×¨×’×”
      disableAutoScroll();
      const anchor = botHTML('<span class="muted">×¤×¨×˜×™ ×§×©×¨</span>');
      scrollStart(anchor);
      setTimeout(()=> enableAutoScroll(), 450);

      await waitP(250);
      const name  = inputRow('×©× ××œ×',      { id:'fullName', placeholder:'×œ×“×•×’××”: ×“× ×” ×œ×•×™', required:true, autocomplete:'name' });
      await waitP(150);
      const phone = inputRow('×˜×œ×¤×•×Ÿ ×œ×—×–×¨×”', { type:'tel', id:'phone', placeholder:'×œ×“×•×’××”: 0501234567', required:true, autocomplete:'tel', inputmode:'tel' });
      await waitP(150);
      const notes = textareaRow('×”×¢×¨×•×ª (×¨×©×•×ª)', { id:'lead_notes', placeholder:'×›×œ ×“×‘×¨ ×©×—×©×•×‘ ×©× ×“×¢' });

      // ×¤×•×§×•×¡ ×‘×œ×™ ×œ×’×œ×•×œ
      name.focus({ preventScroll:true });

      await waitP(120);
      const nextBtn = button('×”××©×š', async ()=>{
        userText('×”××©×š');

        const fullName  = (name.value||'').trim();
        const phoneNorm = normalizeILPhone((phone.value||'').trim());
        const message   = (notes.value||'').trim();

        if(!fullName){ botText('×™×© ×œ×”×–×™×Ÿ ×©× ××œ× âœï¸').classList.add('err'); return; }
        if(!validILPhone(phoneNorm)){ botText('××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ× ×ª×§×™×Ÿ ğŸ“ (×œ××©×œ 0501234567)').classList.add('err'); return; }

        state.lead.fullName = fullName;
        state.lead.phone    = phoneNorm;
        state.lead.message  = message;

        nextBtn.disabled = true;
        const stopProcessing = showProcessing();

        const ok = await sendToSheet({
          path: '×× ×•×™ ×—×•×“×©×™ â€“ ×”×ª×¢× ×™×™× ×•×ª',
          fullName: state.lead.fullName,
          phone: state.lead.phone,
          message: state.lead.message,   // <<< ×™×™×›× ×¡ ×œ×¢××•×“×ª message
          extraNotes: '',                // ×¢×§×‘×™×•×ª ×¢××•×“×•×ª
          cta: '×”×ª×¢× ×™×™× ×•×ª ×‘×× ×•×™ ×—×•×“×©×™',
          source: '×™×•×¡×˜×•×Ÿ â€“ ××ª×¨',
          status: '×œ×˜×™×¤×•×œ',
          createdAt: new Date().toISOString()
        });

        stopProcessing();

        if(ok){
          botText('×”×¤×¨×˜×™× × ×©××¨×• ×‘×”×¦×œ×—×” âœ…');
          setTimeout(()=> stepAbout(), 600);
        }else{
          botText('×œ× ×”×¦×œ×—× ×• ×œ×©××•×¨ ××ª ×”×¤×¨×˜×™× âŒ ××¤×©×¨ ×œ× ×¡×•×ª ×©×•×‘ ××• ×œ×¤× ×•×ª ××œ×™× ×• ×‘×•×•××˜×¡××¤ 050-9570866.').classList.add('err');
          nextBtn.disabled = false;
        }
      }, 'btn primary');

      button('×—×–×¨×”', goBack);
    }

    // ×©×œ×‘ 1 â€“ ××™×š ×¢×•×‘×“×™×
    function stepAbout(){
      clear(); push(stepAbout);

      botHTML(
        '<strong>×›××” ××™×œ×™× ×¢×œ ××™×š ×× ×—× ×• ×¢×•×‘×“×™×:</strong><br>' +
        'â€¢ ×›×œ ×©×™×¢×•×¨ × ××©×š <strong>50 ×“×§×•×ª</strong> ×•××ª×—×™×œ ×‘×©×¢×” ×¢×’×•×œ×”.<br>' +
        'â€¢ ×œ×•××“×™× ××ª ×—×•××¨ ×”×›×™×ª×”, ××©×œ×™××™× ×¤×¢×¨×™×, ×¢×•×–×¨×™× ×‘×©×™×¢×•×¨×™ ×‘×™×ª, ××›×™× ×™× ×œ××‘×—× ×™×,<br>' +
        '  ×‘×•× ×™× ×‘×™×˜×—×•×Ÿ â€” ×•××¤×™×œ×• ××ª×§×“××™× ×‘×—×•××¨ ××¢×‘×¨ ×œ×›×™×ª×” ğŸ¯'
      );

      button('×”××©×š', stepPrices, 'btn primary');
      button('×—×–×¨×”', goBack);
    }

    // ×©×œ×‘ 2 â€“ ××¡×œ×•×œ×™× ×•××—×™×¨×™×
    function stepPrices(){
      clear(); push(stepPrices);

      botHTML(
        '<strong>××¡×œ×•×œ×™× ×•××—×™×¨×™×</strong><br>' +
        'â€¢ ×§×‘×•×¦×ª×™ (×¢×“ 5 ×ª×œ××™×“×™×): <strong>295 â‚ª / ×—×•×“×©</strong><br>' +
        'â€¢ ×˜×¨×™×¤×œ (×¢×“ 3 ×ª×œ××™×“×™×): <strong>385 â‚ª / ×—×•×“×©</strong><br><br>' +
        '×•×× ×ª×¨×¦×™ ×œ×”×ª×—×™×œ ×‘×§×˜×Ÿ â€“ <strong>×©×™×¢×•×¨ ×—×“Ö¾×¤×¢××™</strong> ×¢×œ ×‘×¡×™×¡ ××§×•× ×¤× ×•×™:<br>' +
        '80 â‚ª (×§×‘×•×¦×ª×™) / 100 â‚ª (×˜×¨×™×¤×œ)'
      );

      button('×”××©×š', stepRegister, 'btn primary');
      button('×—×–×¨×”', goBack);
    }

    // ×©×œ×‘ 3 â€“ ×§×™×©×•×¨ ×œ×˜×•×¤×¡ ×”×¨×©××” + ×—×œ×•×¤×•×ª
    function stepRegister(){
      clear(); push(stepRegister);

      botText('×›×“×™ ×œ×”×™×›× ×¡ ×œ×¨×©×™××ª ×”×”××ª× ×” ×•×œ×©×¨×™×™×Ÿ ××§×•×, × ×©××— ×©×ª××œ××™ ××ª ×˜×•×¤×¡ ×”×¨×™×©×•×:');

      button('×¤×ª×—×™ ××ª ×˜×•×¤×¡ ×”×”×¨×©××” ğŸ“', ()=>{
        userText('×¤×ª×—×ª×™ ××ª ×˜×•×¤×¡ ×”×”×¨×©××”');
        window.open(ORIGAMI_URL, '_blank', 'noopener,noreferrer');
      }, 'btn primary');

      button('××©×œ×™× ××ª ×”×˜×•×¤×¡ ×××•×—×¨ ×™×•×ª×¨ â³', ()=>{
        userText('××©×œ×™× ××ª ×”×˜×•×¤×¡ ×××•×—×¨ ×™×•×ª×¨');
        typingThenP('×¡×’×•×¨ ğŸ™‚ ×›×‘×¨ ×©××¨×ª×™ ××ª ×”×¤×¨×˜×™× ×©×œ×š ×•× ×™×¦×•×¨ ×§×©×¨ ×‘×”×§×“×.', 700, true);
      });

      button('×‘××§×•× ×–××ª: ×©×™×¢×•×¨ ×—×“Ö¾×¤×¢××™ ×¢×›×©×™×•', ()=>{
        userText('×©×™×¢×•×¨ ×—×“Ö¾×¤×¢××™ ×¢×›×©×™×•');
        setTimeout(()=> location.href='./branch1.html', 200);
      });

      button('×—×–×¨×”', goBack);
    }

    // ×”×¤×¢×œ×”
    start();
  </script>
</body>
</html>