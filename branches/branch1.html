<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>שיעור על בסיס מקום פנוי</title>

  <link rel="stylesheet" href="../styles.css?v=3" />
  <meta name="theme-color" content="#2563eb" />
  <style>#area{overflow-y:auto;max-height:70vh;scroll-behavior:smooth}</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <!-- כותרת -->
      <div class="head">
        <div class="brand">
          <div class="logo">HB</div>
          <div class="title">שיעור על בסיס מקום פנוי</div>
        </div>
      </div>

      <!-- אזור התוכן -->
      <div class="body chat-body" id="area" role="log" aria-live="polite" aria-atomic="false"></div>

      <!-- תחתית -->
      <div class="footer">
        <button id="backBtn" class="btn" disabled>חזרה</button>
        <button class="btn primary" onclick="location.href='../index.html'">לתפריט ראשי</button>
      </div>
    </div>
  </div>

  <!-- סקריפטים משותפים -->
  <script src="./js/config.js?v=2"></script>
  <script src="./js/chat-helpers.js?v=2"></script>

  <script>
    function start(){
      Chat.clear(); Chat.push(start);

      Chat.typingThen(
        'נשמח לעזור לתאם שיעור חד־פעמי 🗓️<br><br>' +
        'במרכז בראונשטיין, גם בשיעור קבוצתי כל תלמיד/ה מקבל/ת יחס אישי ותכנית לימוד מותאמת — ללא תלות בקצב של אחרים.',
        900, true
      );

      setTimeout(()=> Chat.typingThen('<strong>איזה סוג שיעור מתאים?</strong>', 800, true), 2000);

      setTimeout(()=>{
        const P = Chat.cfg.PRICES;

        Chat.button(`קבוצה – עד 5 תלמידים – ${P.group}₪`, ()=>{
          Chat.userBubble(`קבוצה – עד 5 תלמידים – ${P.group}₪`);
          Chat.State.data.planType='group';
          Chat.State.data.price=P.group;
          stepSubject();
        }, 'btn primary');

        Chat.button(`טריפל – עד 3 תלמידים – ${P.triple}₪`, ()=>{
          Chat.userBubble(`טריפל – עד 3 תלמידים – ${P.triple}₪`);
          Chat.State.data.planType='triple';
          Chat.State.data.price=P.triple;
          stepSubject();
        });

        Chat.button(`פרטי – ${P.private}₪`, ()=>{
          Chat.userBubble(`פרטי – ${P.private}₪`);
          Chat.State.data.planType='private';
          Chat.State.data.price=P.private;
          stepSubject();
        });
      }, 3000);
    }

    function stepSubject(){
      Chat.clear(); Chat.push(stepSubject);
      Chat.typingThen('<strong>באיזה מקצוע תרצו את השיעור? 📖</strong>', 800, true);

      setTimeout(()=>{
        Chat.cfg.SUBJECTS.forEach(s => Chat.button(s, ()=>{
          Chat.userBubble(s);
          Chat.State.data.subject = s;
          stepDetails();
        }));
        // צ׳יפס מסלול+מחיר
        const s = document.createElement('div'); s.className='summary';
        if (Chat.State.data.planType)
          s.appendChild(Chat.chip(`מסלול: ${Chat.cfg.PLAN_HE[Chat.State.data.planType]} (${Chat.State.data.price}₪)`));
        document.getElementById('area').appendChild(s);
      }, 1500);
    }

    async function stepDetails(){
      Chat.clear(); Chat.push(stepDetails);

      // נועל אוטו-סקרול קצר כדי לא "לקפוץ" לתחתית
      Chat.State.autoScroll = false;
      const header = Chat.botHTML('<strong>פרטי תיאום</strong><br><span class="muted">נמלא כמה פרטים ואז נסכם 📋</span>');

      const chips = document.createElement('div'); chips.className='summary';
      if (Chat.State.data.planType) chips.appendChild(Chat.chip(`מסלול: ${Chat.cfg.PLAN_HE[Chat.State.data.planType]} (${Chat.State.data.price}₪)`));
      if (Chat.State.data.subject)  chips.appendChild(Chat.chip(`מקצוע: ${Chat.State.data.subject}`));
      document.getElementById('area').appendChild(chips);

      Chat.scrollStartOf(header);
      setTimeout(()=> Chat.State.autoScroll = true, 450);

      // שעות פעילות + בקשת ימי/שעות
      Chat.typingThen(
        'שעות הפעילות שלנו: <strong>א׳–ה׳, 14:00–21:00</strong> ⏰<br>' +
        'מהם הימים והשעות שנוחים לשיעור?',
        700, true
      );

      // שדות
      await waitP(300);
      const availability = Chat.inputRow('ימים ושעות מועדפים', {
        textarea:true, id:'availability',
        placeholder:'לדוגמה: א׳–ג׳ 16:00–19:00 / שישי בוקר', required:true
      });

      await waitP(150);
      const message = Chat.inputRow('הערות למזכירות (לא חובה)', {
        textarea:true, id:'message', placeholder:'רמה/יעד/העדפות מיוחדות'
      });

      await waitP(150);
      const fullName = Chat.inputRow('שם מלא', {
        id:'fullName', placeholder:'לדוגמה: דנה לוי', required:true, autocomplete:'name'
      });

      await waitP(150);
      const phone = Chat.inputRow('טלפון לחזרה', {
        type:'tel', id:'phone', placeholder:'לדוגמה: 0501234567',
        required:true, autocomplete:'tel', inputmode:'tel'
      });

      availability.focus({ preventScroll:true });

      await waitP(120);
      Chat.button('המשך לסיכום', ()=>{
        Chat.userBubble('המשך לסיכום');

        const avail = (availability.value||'').trim();
        const note  = (message.value||'').trim();
        const name  = (fullName.value||'').trim();
        const tel   = Chat.normalizeILPhone(phone.value||'');

        if(!avail){ Chat.botText('נא לציין זמינות (ימים ושעות) 🕒').classList.add('err'); availability.focus(); return; }
        if(!name){  Chat.botText('נא להזין שם מלא ✏️').classList.add('err'); fullName.focus(); return; }
        if(!Chat.validILPhone(tel)){ Chat.botText('מספר טלפון לא תקין 📞').classList.add('err'); phone.focus(); return; }

        Chat.State.data.availability = avail;
        Chat.State.data.message      = note;
        Chat.State.data.fullName     = name;
        Chat.State.data.phone        = tel;

        stepReview();
      }, 'btn primary');

      Chat.button('חזרה', Chat.goBack);

      function waitP(ms){ return new Promise(r=>setTimeout(r, ms)); }
    }

    function stepReview(){
      Chat.clear(); Chat.push(stepReview);

      const h = Chat.botHTML('<strong>סיכום הבקשה</strong><br><span class="muted">בדקו שהכול נכון לפני שליחה.</span>');
      Chat.scrollStartOf(h);

      const card = document.createElement('div'); card.className='bubble bot';

      const chips = document.createElement('div'); chips.className='summary';
      if (Chat.State.data.planType) chips.appendChild(Chat.chip(`מסלול: ${Chat.cfg.PLAN_HE[Chat.State.data.planType]} (${Chat.State.data.price}₪)`));
      if (Chat.State.data.subject)  chips.appendChild(Chat.chip(`מקצוע: ${Chat.State.data.subject}`));
      card.appendChild(chips);

      const details = document.createElement('div'); details.style.lineHeight='1.9';
      const addLine = (label, value)=>{
        const line=document.createElement('div');
        const b=document.createElement('strong'); b.textContent=label+' ';
        const span=document.createElement('span'); span.textContent=value;
        line.append(b, span); details.appendChild(line);
      };
      addLine('ימים ושעות מועדפים:', Chat.State.data.availability);
      if (Chat.State.data.message) addLine('הערות:', Chat.State.data.message);
      addLine('שם מלא:', Chat.State.data.fullName);
      addLine('טלפון לחזרה:', Chat.State.data.phone);

      card.appendChild(details);
      document.getElementById('area').appendChild(card);
      (function(){ const a=document.getElementById('area'); a.scrollTop=a.scrollHeight; })();

      Chat.button('אישור ושליחה למזכירות 📤', async ()=>{
        const stopProcessing = Chat.showProcessing();

        const ok = await Chat.sendLeadToSheet({
          path: 'שיעור על בסיס מקום פנוי',
          planType: Chat.cfg.PLAN_HE[Chat.State.data.planType],
          price: `${Chat.State.data.price}₪`,
          subject: Chat.State.data.subject,
          availability: Chat.State.data.availability,
          message: Chat.State.data.message,
          extraNotes: 'שעות פעילות: א׳–ה׳ 14:00–21:00',
          fullName: Chat.State.data.fullName,
          phone: Chat.State.data.phone,
          cta: 'שיעור חד־פעמי',
          source: 'יוסטון – אתר',
          status: 'לטיפול',
          createdAt: new Date().toISOString()
        });

        stopProcessing();
        Chat.clear();

        if(ok){
          Chat.botText('הבקשה נשלחה למזכירות ✅ נחזור בהקדם לבדוק זמינות ולהשריין מועד 📅').classList.add('ok');
        }else{
          Chat.botText('לא הצלחנו לשמור את הבקשה ❌ אפשר לנסות שוב או לפנות בוואטסאפ 050‑9570866.').classList.add('err');
        }
        const home = Chat.button('חזרה לתפריט הראשי', ()=> location.href='../index.html', 'btn primary');
        home.focus();
      }, 'btn primary');

      Chat.button('עריכה', ()=> stepDetails());
    }

    // הפעלה
    start();
  </script>
</body>
</html>