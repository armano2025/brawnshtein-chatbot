<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>×©×™×¢×•×¨ ×¢×œ ×‘×¡×™×¡ ××§×•× ×¤× ×•×™</title>

  <link rel="stylesheet" href="../styles.css?v=3" />
  <meta name="theme-color" content="#2563eb" />
  <style>#area{overflow-y:auto;max-height:70vh;scroll-behavior:smooth}</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <!-- ×›×•×ª×¨×ª -->
      <div class="head">
        <div class="brand">
          <div class="logo">HB</div>
          <div class="title">×©×™×¢×•×¨ ×¢×œ ×‘×¡×™×¡ ××§×•× ×¤× ×•×™</div>
        </div>
      </div>

      <!-- ××–×•×¨ ×”×ª×•×›×Ÿ -->
      <div class="body chat-body" id="area" role="log" aria-live="polite" aria-atomic="false"></div>

      <!-- ×ª×—×ª×™×ª -->
      <div class="footer">
        <button id="backBtn" class="btn" disabled>×—×–×¨×”</button>
        <!-- ×ª××™×“ ×œ×‘×Ÿ ×›××• ×—×–×¨×” -->
        <button class="btn" onclick="location.href='../index.html'">×œ×ª×¤×¨×™×˜ ×¨××©×™</button>
      </div>
    </div>
  </div>

  <!-- ×¡×§×¨×™×¤×˜×™× ××©×•×ª×¤×™× -->
  <script src="./js/config.js?v=2"></script>
  <script src="./js/chat-helpers.js?v=2"></script>

  <script>
    // ==== ×”×ª×—×œ×”: ×§×•×¤×¦×™× ×™×©×¨ ×œ××§×¦×•×¢; ××ª ×¤×ª×™×— "× ×©××— ×œ×¢×–×•×¨..." ××©×•×œ×‘ ×‘×›×•×ª×¨×ª ×©×œ×‘ ×”××§×¦×•×¢ ====
    function start(){
      Chat.clear(); Chat.push(start);
      stepSubject();
    }

    // ==== ×©×œ×‘ 1: ××§×¦×•×¢ ====
    function stepSubject(){
      Chat.clear(); Chat.push(stepSubject);

      Chat.typingThen(
        '<strong>× ×©××— ×œ×¢×–×•×¨ ×‘×ª×™××•× ×©×™×¢×•×¨ ×—×“Ö¾×¤×¢××™ ğŸ—“ï¸ğŸ‘¨â€ğŸš€</strong><br>' +
        '<span class="muted">×‘××¨×›×– ×‘×¨××•× ×©×˜×™×™×Ÿ, ×’× ×‘×©×™×¢×•×¨ ×§×‘×•×¦×ª×™ ×›×œ ×ª×œ××™×“ ××§×‘×œ ×™×—×¡ ××™×©×™ ×•×ª×›× ×™×ª ×œ×™××•×“ ××•×ª×××ª.</span><br><br>' +
        '<strong>×‘××™×–×” ××§×¦×•×¢ ×ª×¨×¦×• ××ª ×”×©×™×¢×•×¨? ğŸ“–</strong> ğŸ‘¨â€ğŸš€',
        700, true
      );

      setTimeout(()=>{
        Chat.cfg.SUBJECTS.forEach(s => Chat.button(s, ()=>{
          Chat.userBubble(s);
          Chat.State.data.subject = s;
          stepGrade();
        }));

        const s = document.createElement('div'); s.className='summary';
        s.appendChild(Chat.chip('×©×™×¢×•×¨ ×—×“Ö¾×¤×¢××™'));
        document.getElementById('area').appendChild(s);
      }, 1000);
    }

    // ==== ×©×œ×‘ 2: ×›×™×ª×” / ×¨××” ====
    function stepGrade(){
      Chat.clear(); Chat.push(stepGrade);

      Chat.typingThen('<strong>×‘××™×–×• ×›×™×ª×” ××• ×¨××”?</strong> ğŸ‘¨â€ğŸš€', 700, true);

      const grades = ['×','×‘','×’','×“','×”','×•','×–','×—','×˜','×™','×™×','×™×‘','×—×™× ×•×š ×‘×™×ª×™','×¡×˜×•×“× ×˜/×™×ª','××—×¨'];
      setTimeout(()=>{
        grades.forEach(g => Chat.button(g, ()=>{
          Chat.userBubble(g);
          Chat.State.data.grade = g;
          if (['×™','×™×','×™×‘'].includes(g)) { stepUnits(); }
          else { stepPlan(); }
        }));

        // ×¦×³×™×¤×™×
        const s = document.createElement('div'); s.className='summary';
        if (Chat.State.data.subject) s.appendChild(Chat.chip(`××§×¦×•×¢: ${Chat.State.data.subject}`));
        document.getElementById('area').appendChild(s);
      }, 1000);
    }

    // ==== ×©×œ×‘ 2b: ×™×—×™×“×•×ª (×œ×ª×™×›×•×Ÿ) ====
    function stepUnits(){
      Chat.clear(); Chat.push(stepUnits);

      Chat.typingThen('<strong>×›××” ×™×—×™×“×•×ª ×‘×’×¨×•×ª?</strong> ğŸ‘¨â€ğŸš€', 600, true);

      setTimeout(()=>{
        ['3','4','5'].forEach(u => Chat.button(u, ()=>{
          Chat.userBubble(u);
          Chat.State.data.units = u;
          stepPlan();
        }));
        const s = document.createElement('div'); s.className='summary';
        s.appendChild(Chat.chip(`×›×™×ª×”: ${Chat.State.data.grade}`));
        if (Chat.State.data.subject) s.appendChild(Chat.chip(`××§×¦×•×¢: ${Chat.State.data.subject}`));
        document.getElementById('area').appendChild(s);
      }, 900);
    }

    // ==== ×©×œ×‘ 3: ××¡×œ×•×œ (××—×™×¨) ====
    function stepPlan(){
      Chat.clear(); Chat.push(stepPlan);

      const P = Chat.cfg.PRICES, H = Chat.cfg.PLAN_HE;
      Chat.typingThen('<strong>×‘×—×™×¨×ª ××¡×œ×•×œ</strong><br><span class="muted">× × ×œ×‘×—×•×¨ ××¡×œ×•×œ ××ª××™×:</span> ğŸ‘¨â€ğŸš€', 600, true);

      setTimeout(()=>{
        // ×× × ×‘×—×¨: ×™×´×/×™×´×‘ + 5 ×™×—×´×œ ××ª××˜×™×§×” â†’ ×œ×”×¡×ª×™×¨ ×§×‘×•×¦×”
        const isMath = (Chat.State.data.subject || '').trim() === '××ª××˜×™×§×”';
        const isHighGrade = ['×™×','×™×‘'].includes(Chat.State.data.grade);
        const isFiveUnits = (Chat.State.data.units || '') === '5';
        const allowGroup = !(isMath && isHighGrade && isFiveUnits);

        if (allowGroup){
          Chat.button(`×§×‘×•×¦×” â€“ ×¢×“ 5 ×ª×œ××™×“×™× â€“ ${P.group}â‚ª`, ()=>{
            Chat.userBubble(`×§×‘×•×¦×” â€“ ×¢×“ 5 ×ª×œ××™×“×™× â€“ ${P.group}â‚ª`);
            Chat.State.data.planType='group';
            Chat.State.data.price=P.group;
            stepAvailability();
          }, 'btn primary');
        }

        Chat.button(`×˜×¨×™×¤×œ â€“ ×¢×“ 3 ×ª×œ××™×“×™× â€“ ${P.triple}â‚ª`, ()=>{
          Chat.userBubble(`×˜×¨×™×¤×œ â€“ ×¢×“ 3 ×ª×œ××™×“×™× â€“ ${P.triple}â‚ª`);
          Chat.State.data.planType='triple';
          Chat.State.data.price=P.triple;
          stepAvailability();
        });

        Chat.button(`×¤×¨×˜×™ â€“ ${P.private}â‚ª`, ()=>{
          Chat.userBubble(`×¤×¨×˜×™ â€“ ${P.private}â‚ª`);
          Chat.State.data.planType='private';
          Chat.State.data.price=P.private;
          stepAvailability();
        });

        // ×¦×³×™×¤×™×
        const s = document.createElement('div'); s.className='summary';
        if (Chat.State.data.subject) s.appendChild(Chat.chip(`××§×¦×•×¢: ${Chat.State.data.subject}`));
        if (Chat.State.data.grade)   s.appendChild(Chat.chip(`×›×™×ª×”: ${Chat.State.data.grade}${Chat.State.data.units?` â€¢ ${Chat.State.data.units} ×™×—×³`:''}`));
        document.getElementById('area').appendChild(s);
      }, 900);
    }

    // ==== ×©×œ×‘ 4: ×©×¢×•×ª ×¤×ª×™×—×” + ×™××™×/×©×¢×•×ª × ×•×—×™× ====
    function stepAvailability(){
      Chat.clear(); Chat.push(stepAvailability);

      Chat.typingThen(
        '<strong>×©×¢×•×ª ×¤×ª×™×—×”</strong><br>' +
        '<span class="muted">×× ×—× ×• ×¤×ª×•×—×™× ×‘×™××™× ××³â€“×”×³ ×‘×™×Ÿ 14:00â€“21:00.</span><br><br>' +
        '<strong>×‘××™×œ×• ×™××™× ×•×©×¢×•×ª × ×•×— ×œ×§×‘×•×¢?</strong> ğŸ‘¨â€ğŸš€',
        700, true
      );

      setTimeout(()=>{
        const availability = Chat.inputRow('×™××™× ×•×©×¢×•×ª ××•×¢×“×¤×™×', {
          textarea:true, id:'availability',
          placeholder:'×œ×“×•×’××”: ××³â€“×“×³ 16:00â€“19:00; ×©×™×©×™ ×‘×•×§×¨', required:true
        });

        Chat.button('×”××©×š', ()=>{
          Chat.userBubble('×”××©×š');

          const avail = (availability.value||'').trim();
          if(!avail){
            Chat.botText('× ×“×¨×© ×œ×¦×™×™×Ÿ ×™××™× ×•×©×¢×•×ª ××•×¢×“×¤×™× ğŸ•’').classList.add('err');
            availability.focus(); return;
          }
          Chat.State.data.availability = avail;
          stepNotes();
        }, 'btn primary');

        Chat.button('×—×–×¨×”', Chat.goBack);

        // ×¡×™×›×•× ×§×˜×Ÿ
        const s = document.createElement('div'); s.className='summary';
        if (Chat.State.data.planType) s.appendChild(Chat.chip(`××¡×œ×•×œ: ${Chat.cfg.PLAN_HE[Chat.State.data.planType]} (${Chat.State.data.price}â‚ª)`));
        if (Chat.State.data.grade)    s.appendChild(Chat.chip(`×›×™×ª×”: ${Chat.State.data.grade}${Chat.State.data.units?` â€¢ ${Chat.State.data.units} ×™×—×³`:''}`));
        document.getElementById('area').appendChild(s);
      }, 1000);
    }

    // ==== ×©×œ×‘ 5: ×”×¢×¨×•×ª (××•×¤×¦×™×•× ×œ×™) ====
    function stepNotes(){
      Chat.clear(); Chat.push(stepNotes);

      Chat.typingThen('<strong>×”×¢×¨×•×ª ×œ××–×›×™×¨×•×ª</strong><br><span class="muted">××¤×©×¨ ×œ×¦×™×™×Ÿ ×”×¢×“×¤×” ×œ××•×¨×”, ×¨××”, ××• ×‘×§×©×” ××™×•×—×“×ª (×œ× ×—×•×‘×”)</span> ğŸ‘¨â€ğŸš€', 600, true);

      setTimeout(()=>{
        const message = Chat.inputRow('×”×¢×¨×•×ª (×œ× ×—×•×‘×”)', {
          textarea:true, id:'message', placeholder:'×œ×“×•×’××”: ×¨×¢× ×•×Ÿ ×œ×§×¨××ª ××‘×—×Ÿ / ×”×¢×“×¤×” ×œ×©×¢×ª ×¢×¨×‘'
        });

        // ××¡×™×¨×™× ×›×¤×™×œ×•×ª: ×¨×§ ×”××©×š + ×—×–×¨×”
        Chat.button('×”××©×š', ()=>{
          Chat.userBubble('×”××©×š');
          Chat.State.data.message = (message.value||'').trim();
          stepContact();
        }, 'btn primary');

        Chat.button('×—×–×¨×”', Chat.goBack);
      }, 900);
    }

    // ==== ×©×œ×‘ 6: ×¤×¨×˜×™ ×§×©×¨ (×©× ×¤×¨×˜×™ + ×©× ××©×¤×—×” + ×˜×œ×¤×•×Ÿ) ====
    async function stepContact(){
      Chat.clear(); Chat.push(stepContact);

      // ×”×›×•×ª×¨×ª ×”×¢×œ×™×•× ×” ×—×™×™×‘×ª ×œ×”×™×•×ª ×”×›×™ ×œ××¢×œ×”
      const header = Chat.botHTML('<strong>×¤×¨×˜×™ ×§×©×¨ ×œ×ª×™××•×</strong><br><span class="muted">× ×©××— ×œ×©× ×¤×¨×˜×™, ×©× ××©×¤×—×” ×•××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ×—×–×¨×”</span> ğŸ‘¨â€ğŸš€');
      Chat.scrollStartOf(header);

      await waitP(300);
      const firstName = Chat.inputRow('×©× ×¤×¨×˜×™', {
        id:'firstName', placeholder:'×œ×“×•×’××”: ×“× ×”', required:true, autocomplete:'given-name'
      });

      await waitP(120);
      const lastName = Chat.inputRow('×©× ××©×¤×—×”', {
        id:'lastName', placeholder:'×œ×“×•×’××”: ×œ×•×™', required:true, autocomplete:'family-name'
      });

      await waitP(120);
      const phone = Chat.inputRow('×˜×œ×¤×•×Ÿ ×œ×—×–×¨×”', {
        type:'tel', id:'phone', placeholder:'×œ×“×•×’××”: 0501234567', required:true, autocomplete:'tel', inputmode:'tel'
      });

      await waitP(120);
      Chat.button('×”××©×š ×œ×¡×™×›×•×', ()=>{
        Chat.userBubble('×”××©×š ×œ×¡×™×›×•×');

        const fn  = (firstName.value||'').trim();
        const ln  = (lastName.value||'').trim();
        const tel = Chat.normalizeILPhone(phone.value||'');

        if(!fn){  Chat.botText('× ×“×¨×© ×©× ×¤×¨×˜×™ âœï¸').classList.add('err'); firstName.focus(); return; }
        if(!ln){  Chat.botText('× ×“×¨×© ×©× ××©×¤×—×” âœï¸').classList.add('err'); lastName.focus(); return; }
        if(!Chat.validILPhone(tel)){ Chat.botText('××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ× ×ª×§×™×Ÿ ğŸ“').classList.add('err'); phone.focus(); return; }

        Chat.State.data.firstName = fn;
        Chat.State.data.lastName  = ln;
        Chat.State.data.phone     = tel;

        stepReview();
      }, 'btn primary');

      Chat.button('×—×–×¨×”', Chat.goBack);

      function waitP(ms){ return new Promise(r=>setTimeout(r, ms)); }
    }

    // ==== ×©×œ×‘ 7: ×¡×™×›×•× ×•×©×œ×™×—×” ====
    function stepReview(){
      Chat.clear(); Chat.push(stepReview);

      const h = Chat.botHTML('<strong>×¡×™×›×•× ×”×‘×§×©×”</strong><br><span class="muted">× × ×œ×•×•×“× ×©×”×›×•×œ × ×›×•×Ÿ ×œ×¤× ×™ ×©×œ×™×—×”.</span> ğŸ‘¨â€ğŸš€');
      Chat.scrollStartOf(h);

      const card = document.createElement('div'); card.className='bubble bot';

      // ×¦×³×™×¤×™× ×¢×œ×™×•× ×™×
      const chips = document.createElement('div'); chips.className='summary';
      if (Chat.State.data.subject)   chips.appendChild(Chat.chip(`××§×¦×•×¢: ${Chat.State.data.subject}`));
      if (Chat.State.data.grade)     chips.appendChild(Chat.chip(`×›×™×ª×”: ${Chat.State.data.grade}${Chat.State.data.units?` â€¢ ${Chat.State.data.units} ×™×—×³`:''}`));
      if (Chat.State.data.planType)  chips.appendChild(Chat.chip(`××¡×œ×•×œ: ${Chat.cfg.PLAN_HE[Chat.State.data.planType]} (${Chat.State.data.price}â‚ª)`));
      card.appendChild(chips);

      // ×“×•"×— ×¡×™×›×•× ×‘×©×¤×” ××—×™×“×”
      const d = Chat.State.data;
      const details = document.createElement('div'); details.style.lineHeight='1.9';
      const addLine = (label, value)=>{
        const line=document.createElement('div');
        const b=document.createElement('strong'); b.textContent=label+' ';
        const span=document.createElement('span'); span.textContent=value;
        line.append(b, span); details.appendChild(line);
      };
      addLine('×©×:', `${d.firstName||''}`);
      addLine('×©× ××©×¤×—×”:', `${d.lastName||''}`);
      addLine('××§×¦×•×¢:', `${d.subject||''}`);
      addLine('×›×™×ª×”:', `${d.grade||''}${d.units?` â€¢ ${d.units} ×™×—×³`:''}`);
      addLine('××¡×œ×•×œ:', `${(Chat.cfg.PLAN_HE[d.planType]||'')}${d.price?` â€“ ${d.price}â‚ª`:''}`);
      addLine('×™××™× ×•×©×¢×•×ª ××•×¢×“×¤×™×:', d.availability||'');
      if (d.message) addLine('×”×¢×¨×•×ª ×œ××–×›×™×¨×•×ª:', d.message);
      addLine('×˜×œ×¤×•×Ÿ ×œ×—×–×¨×”:', d.phone||'');

      card.appendChild(details);
      document.getElementById('area').appendChild(card);
      (function(){ const a=document.getElementById('area'); a.scrollTop=a.scrollHeight; })();

      Chat.button('××™×©×•×¨ ×•×©×œ×™×—×” ×œ××–×›×™×¨×•×ª ğŸ“¤', async ()=>{
        const stopProcessing = Chat.showProcessing();

        const fullName = `${Chat.State.data.firstName||''} ${Chat.State.data.lastName||''}`.trim();

        const ok = await Chat.sendLeadToSheet({
          path: '×©×™×¢×•×¨ ×¢×œ ×‘×¡×™×¡ ××§×•× ×¤× ×•×™',
          planType: Chat.cfg.PLAN_HE[Chat.State.data.planType],
          price: `${Chat.State.data.price}â‚ª`,
          subject: Chat.State.data.subject,
          grade: Chat.State.data.grade,
          units: Chat.State.data.units || '',
          availability: Chat.State.data.availability,
          message: Chat.State.data.message || '',
          extraNotes: '',
          fullName,                 // ×ª××™××•×ª ×œ××—×•×¨
          firstName: Chat.State.data.firstName,
          lastName:  Chat.State.data.lastName,
          phone: Chat.State.data.phone,
          cta: '×©×™×¢×•×¨ ×—×“Ö¾×¤×¢××™',
          source: '×™×•×¡×˜×•×Ÿ â€“ ××ª×¨',
          status: '×œ×˜×™×¤×•×œ',
          createdAt: new Date().toISOString()
        });

        stopProcessing();
        Chat.clear();

        if(ok){
          Chat.botText('×”××™×“×¢ × ×©×œ×— ×œ××–×›×™×¨×•×ª âœ… × ×™×¦×•×¨ ×§×©×¨ ×‘×”×§×“× ×‘×•×•××˜×¡××¤ ×œ×ª×™××•× ×©×™×¢×•×¨ ×¢×œ ×‘×¡×™×¡ ××§×•× ×¤× ×•×™ ğŸ‘¨â€ğŸš€').classList.add('ok');
        }else{
          Chat.botText('×œ× ×”×¦×œ×—× ×• ×œ×©××•×¨ ××ª ×”×‘×§×©×” ×œ×’×™×œ×™×•×Ÿ âŒ × ×™×ª×Ÿ ×œ× ×¡×•×ª ×©×•×‘ ××• ×œ×¤× ×•×ª ×‘×•×•××˜×¡××¤ 050â€‘9570866.').classList.add('err');
        }
        const home = Chat.button('×—×–×¨×” ×œ×ª×¤×¨×™×˜ ×”×¨××©×™', ()=> location.href='../index.html', 'btn primary');
        home.focus();
      }, 'btn primary');

      Chat.button('×¢×¨×™×›×”', ()=> stepContact());
    }

    // ×”×¤×¢×œ×”
    start();
  </script>
</body>
</html>