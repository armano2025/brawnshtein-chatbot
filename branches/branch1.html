<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>שיעור חד פעמי על בסיס מקום פנוי</title>

  <!-- שים לב: branch1.html נמצא ב-branches/, אז קובץ ה-CSS בשורש = ../ -->
  <link rel="stylesheet" href="../styles.light.css?v=1" />
  <meta name="theme-color" content="#5b7cfa" />

  <style>
    :root{
      --radius:16px;
      --gap:14px;
      --card-bg: rgba(255,255,255,0.75);
      --card-brd:#e6eaf3;
      --shadow: 0 8px 24px rgba(15,23,42,0.08);
      --shadow-hover: 0 12px 36px rgba(15,23,42,0.12);
      --text: #0f172a;
      --muted:#6b7280;
      --soft-1:#eef6ff; --soft-1-b:#cfe3ff;
      --soft-2:#ecfdf5; --soft-2-b:#c7f2e1;
      --soft-3:#fff1f2; --soft-3-b:#ffd7dc;
      --soft-4:#f5f3ff; --soft-4-b:#e3ddff;
      --gradient: radial-gradient(900px 520px at 100% -10%, #8ea5ff33, transparent 60%),
                  radial-gradient(700px 460px at 0% 100%, #8bffd933, transparent 60%);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --card-bg: rgba(18,22,33,0.6);
        --card-brd:#2a3142;
        --shadow: 0 6px 18px rgba(0,0,0,0.35);
        --shadow-hover: 0 10px 28px rgba(0,0,0,0.45);
        --text:#e5e7eb; --muted:#9ca3af;
        --soft-1:#0b2447; --soft-1-b:#1b3a6c;
        --soft-2:#0f2f27; --soft-2-b:#174538;
        --soft-3:#3a1820; --soft-3-b:#5b2230;
        --soft-4:#241a3d; --soft-4-b:#3a2b61;
      }
    }

    body{
      font-family:'Rubik', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        linear-gradient(180deg, #f8fafc 0%, #f4f7ff 60%, #f9fafb 100%),
        var(--gradient);
      background-attachment: fixed;
    }
    @media (prefers-color-scheme: dark){
      body{ background:
        linear-gradient(180deg, #0b1220 0%, #0e1424 60%, #0b1220 100%),
        var(--gradient);
      }
    }

    .wrap{ padding: clamp(12px, 2.5vw, 24px) }
    .card{
      border:1px solid var(--card-brd);
      border-radius: clamp(16px, 2vw, 22px);
      box-shadow: var(--shadow);
      backdrop-filter: saturate(140%) blur(8px);
      background: var(--card-bg);
      overflow:hidden;
      max-width: 980px;
      margin: 0 auto;
    }

    .topbar{
      padding: clamp(10px, 1.8vw, 14px);
      border-bottom:1px solid var(--card-brd);
      display:flex; gap:8px; align-items:center;
      background: linear-gradient(180deg, transparent, rgba(0,0,0,0.02));
    }

    .head{
      padding: clamp(16px, 2.4vw, 24px);
      border-bottom:1px solid var(--card-brd);
      display:flex; align-items:center; justify-content:space-between; gap:8px;
    }
    .brand{ display:flex; align-items:center; gap:12px }
    .logo{
      width:40px; height:40px; border-radius:12px;
      display:grid; place-items:center; font-weight:700;
      background: linear-gradient(135deg,#5b7cfa, #6be6b3);
      color:white; box-shadow: 0 6px 16px rgba(91,124,250,0.35);
    }
    .title{ font-weight:700; letter-spacing:0.2px }

    .body.chat-body{ padding: clamp(14px, 2.2vw, 20px); min-height: 40vh }
    #area{ overflow-y:auto; max-height:70vh; scroll-behavior:smooth }

    /* ניטרול עדיפות צבעונית */
    .btn.primary {
      background: var(--btn-bg, #f3f4f6) !important;
      color: var(--btn-fg, #111827) !important;
      border-color: var(--btn-border, #e5e7eb) !important;
    }
    .btn.next-arrow::after{ content:""; }
    @media (prefers-reduced-motion: reduce){
      .btn{ transition:none }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <!-- טופ־בר -->
      <div class="topbar">
        <button class="btn" onclick="location.href='../index.html'">לתפריט ראשי</button>
      </div>

      <!-- כותרת -->
      <div class="head">
        <div class="brand">
          <div class="logo">HB</div>
          <div class="title">שיעור חד פעמי על בסיס מקום פנוי</div>
        </div>
      </div>

      <!-- אזור התוכן -->
      <div class="body chat-body" id="area" role="log" aria-live="polite" aria-atomic="false"></div>

      <!-- תחתית -->
      <div class="footer">
        <button id="backBtn" class="btn" disabled>חזרה</button>
        <!-- faq בשורש => ../ -->
        <a id="faqBtn" class="btn ghost" href="../faq.html" target="_blank" rel="noopener">יש לי שאלות</a>
        <span class="spacer"></span>
      </div>
    </div>
  </div>

  <!-- קבצים משותפים:
       כאן branch1.html יושב ב-branches/, וה‑helpers ב-branches/js => הנתיב הוא ./js/... -->
  <script src="./js/config.js?v=3"></script>
  <script src="./js/chat-helpers.js?v=3"></script>

  <script>
    /* ===== קונטקסט ל-FAQ ===== */
    (function setHelpContext(ctx){
      const btn = document.getElementById('faqBtn');
      if(!btn) return;
      const base = '../faq.html';
      btn.href = ctx ? `${base}?ctx=${encodeURIComponent(ctx)}` : base;
    })('branch1-oneoff');

    /* ===== ניווט אחורה דרך ההיסטוריה של ה-Chat ===== */
    const backBtn = document.getElementById('backBtn');
    if (backBtn) backBtn.onclick = ()=> Chat.goBack?.();

    /* ===== עזר ל-select (אם צריך בתוך השלבים) ===== */
    function selectRow(label, options, id){
      const wrap = document.createElement('div');
      wrap.className = 'input-wrap bubble bot';
      const l = document.createElement('label');
      l.textContent = label;
      if(id) l.htmlFor = id;

      const sel = document.createElement('select');
      sel.id = id;
      sel.className = 'input';
      sel.style.direction = 'rtl';

      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = 'בחר/י...';
      sel.appendChild(opt0);

      options.forEach(v=>{
        const o=document.createElement('option');
        o.value=v; o.textContent=v;
        sel.appendChild(o);
      });

      wrap.append(l, sel);
      document.getElementById('area').appendChild(wrap);
      const a=document.getElementById('area'); a.scrollTop = a.scrollHeight;
      return sel;
    }

    /* ===== התחלה ===== */
    function start(){
      Chat.clear(); Chat.push(start);
      stepContactFirst();
    }

    /* ===== שלב 0: פרטי קשר (משתמשים ב-askContact האחיד כדי לשמור שפה אחידה עם הענף החדש) ===== */
    function stepContactFirst(){
      Chat.clear(); Chat.push(stepContactFirst);

      Chat.askContact({
        titleHtml: '<strong>כדי שנתאם שיעור על בסיס מקום פנוי</strong><br><span class="muted">נשמור שם פרטי, משפחה וטלפון לחזרה</span> 👨‍🚀',
        nextText: 'המשך',
        requireLast: true,
        showBack: false
      }).then(contact=>{
        if(!contact) return;
        Chat.State.data.firstName = contact.firstName;
        Chat.State.data.lastName  = contact.lastName;
        Chat.State.data.phone     = contact.phone;
        stepSubject();
      });
    }

    /* ===== שלב 1: מקצוע ===== */
    function stepSubject(){
      setHelpCtx('subject');
      Chat.clear(); Chat.push(stepSubject);

      const name = Chat.State.data.firstName ? ` ${Chat.State.data.firstName}` : '';
      Chat.typingThen(
        `<strong>מעולה${name}! נתקדם לתאם שיעור חד־פעמי על בסיס מקום פנוי 👨‍🚀</strong><br><strong>איזה מקצוע תרצו?</strong> 📖`,
        600, true
      );

      setTimeout(()=>{
        const fromCfg = (Chat.cfg.SUBJECTS || []).map(s => s === 'אנגלית מדוברת' ? 'אנגלית מדוברת לקטנטנים' : s);
        if (!fromCfg.includes('ביולוגיה')) fromCfg.push('ביולוגיה');

        fromCfg.forEach(s => Chat.button(s, ()=>{
          Chat.userBubble(s);
          Chat.State.data.subject = s;
          stepGrade();
        }));

        const s = document.createElement('div'); s.className='summary';
        s.appendChild(Chat.chip('שיעור חד־פעמי'));
        document.getElementById('area').appendChild(s);
      }, 800);
    }

    /* ===== שלב 2: כיתה ===== */
    function stepGrade(){
      setHelpCtx('grade');
      Chat.clear(); Chat.push(stepGrade);

      Chat.typingThen(`<strong>באיזו כיתה?</strong> 👨‍🚀`, 550, true);

      setTimeout(()=>{
        const grades = ['א','ב','ג','ד','ה','ו','ז','ח','ט','י','יא','יב','חינוך ביתי','סטודנט/ית','אחר'];
        const gradeSelect = selectRow('כיתה', grades, 'grade');

        const btnNext = Chat.button('המשך', ()=>{
          Chat.userBubble('המשך');

          const g = gradeSelect.value;
          if(!g){
            Chat.inlineError('נדרש לבחור כיתה ✏️', gradeSelect);
            return;
          }
          Chat.State.data.grade = g;
          if (['י','יא','יב'].includes(g)) { stepUnits(); }
          else { stepPlan(); }
        }, 'btn');

        gradeSelect.addEventListener('change', ()=>{ btnNext.disabled = false; });
      }, 700);
    }

    /* ===== שלב 2b: יחידות ===== */
    function stepUnits(){
      setHelpCtx('units');
      Chat.clear(); Chat.push(stepUnits);

      Chat.typingThen('<strong>כמה יחידות בגרות?</strong> 👨‍🚀', 550, true);

      setTimeout(()=>{
        ['3','4','5'].forEach(u => Chat.button(`${u} יחידות`, ()=>{
          Chat.userBubble(`${u} יחידות`);
          Chat.State.data.units = u;
          stepPlan();
        }));

        const s = document.createElement('div'); s.className='summary';
        s.appendChild(Chat.chip(`כיתה: ${Chat.State.data.grade}`));
        if (Chat.State.data.subject) s.appendChild(Chat.chip(`מקצוע: ${Chat.State.data.subject}`));
        document.getElementById('area').appendChild(s);
      }, 650);
    }

    /* ===== שלב 3: מסלול ===== */
    function stepPlan(){
      setHelpCtx('plan');
      Chat.clear(); Chat.push(stepPlan);

      const P = Chat.cfg.PRICES, H = Chat.cfg.PLAN_HE;
      Chat.typingThen('<strong>בחירת מסלול</strong><br><span class="muted">נא לבחור מסלול מתאים:</span> 👨‍🚀', 600, true);

      setTimeout(()=>{
        const isMath       = (Chat.State.data.subject || '').trim() === 'מתמטיקה';
        const isHighGrade  = ['יא','יב'].includes(Chat.State.data.grade);
        const isFiveUnits  = (Chat.State.data.units || '') === '5';
        const allowGroup   = !(isMath && isHighGrade && isFiveUnits);

        if (allowGroup){
          Chat.button(`קבוצה – עד 5 תלמידים – ${P.group}₪`, ()=>{
            Chat.userBubble(`קבוצה – עד 5 תלמידים – ${P.group}₪`);
            Chat.State.data.planType='group';
            Chat.State.data.price=P.group;
            stepAvailability();
          }, 'btn');
        }

        Chat.button(`טריפל – עד 3 תלמידים – ${P.triple}₪`, ()=>{
          Chat.userBubble(`טריפל – עד 3 תלמידים – ${P.triple}₪`);
          Chat.State.data.planType='triple';
          Chat.State.data.price=P.triple;
          stepAvailability();
        }, 'btn');

        Chat.button(`פרטי – ${P.private}₪`, ()=>{
          Chat.userBubble(`פרטי – ${P.private}₪`);
          Chat.State.data.planType='private';
          Chat.State.data.price=P.private;
          stepAvailability();
        }, 'btn');

        const s = document.createElement('div'); s.className='summary';
        if (Chat.State.data.subject) s.appendChild(Chat.chip(`מקצוע: ${Chat.State.data.subject}`));
        if (Chat.State.data.grade)   s.appendChild(Chat.chip(`כיתה: ${Chat.State.data.grade}${Chat.State.data.units?` • ${Chat.State.data.units} יחידות`:''}`));
        document.getElementById('area').appendChild(s);
      }, 700);
    }

    /* ===== שלב 4: זמינות – בורר שורה אחת + צ׳יפים (מ-helpers) ===== */
    function stepAvailability(){
      setHelpCtx('availability');
      Chat.clear(); Chat.push(stepAvailability);

      const name = Chat.State.data.firstName ? `, ${Chat.State.data.firstName}` : '';
      Chat.typingThen(
        '<strong>שעות פתיחה</strong><br>' +
        '<span class="muted">אנחנו פתוחים בימים א׳–ה׳ בין 14:00–21:00.</span><br><br>' +
        `<strong>בחירת ימים ושעות מועדפים${name}</strong> 👨‍🚀`,
        600, true
      );

      setTimeout(async ()=>{
        const chosen = await Chat.pickAvailability({
          tipText: 'בחרו כמה שיותר אפשרויות שנוחות לכם',
          continueText: 'המשך',
          allowBack: true
        });
        if(!chosen) return;
        Chat.State.data.availability = chosen.join('; ');
        stepNotes();
      }, 650);
    }

    /* ===== שלב 5: הערות חופשיות (אפשר ריק) ===== */
    function stepNotes(){
      setHelpCtx('notes');
      Chat.clear(); Chat.push(stepNotes);

      const name = Chat.State.data.firstName ? `, ${Chat.State.data.firstName}` : '';
      Chat.typingThen(`<strong>הערות למזכירות</strong><br><span class="muted">אפשר לציין העדפה למורה, רמה, או בקשה מיוחדת (לא חובה)${name}</span> 👨‍🚀`, 550, true);

      setTimeout(()=>{
        const message = Chat.inputRow('הערות (לא חובה)', { textarea:true, id:'message', placeholder:'לדוגמה: רענון לקראת מבחן / העדפה לשעת ערב' });

        Chat.button('המשך', ()=>{
          Chat.userBubble('המשך');
          Chat.State.data.message = (message.value||'').trim();
          stepReview();
        }, 'btn');

      }, 650);
    }

    /* ===== שלב 6: סיכום ושליחה ===== */
    function stepReview(){
      setHelpCtx('review');
      Chat.clear(); Chat.push(stepReview);

      Chat.botHTML('<strong>סיכום הבקשה</strong><br><span class="muted">נא לוודא שהכול נכון לפני שליחה.</span> 👨‍🚀');

      const d = Chat.State.data;

      // שבבונים עליונים (context)
      const chips = document.createElement('div'); chips.className='summary';
      if (d.subject)   chips.appendChild(Chat.chip(`מקצוע: ${d.subject}`));
      if (d.grade)     chips.appendChild(Chat.chip(`כיתה: ${d.grade}${d.units?` • ${d.units} יחידות`:''}`));
      if (d.planType)  chips.appendChild(Chat.chip(`מסלול: ${Chat.cfg.PLAN_HE[d.planType]}${d.price?` – ${d.price}₪`:''}`));
      document.getElementById('area').appendChild(chips);

      // כרטיס סיכום
      Chat.summaryCard([
        ['שם:', d.firstName || ''],
        ['שם משפחה:', d.lastName || ''],
        ['מקצוע:', d.subject || ''],
        ['כיתה:', `${d.grade||''}${d.units?` • ${d.units} יחידות`:''}`],
        ['מסלול:', (Chat.cfg.PLAN_HE[d.planType]||'') + (d.price?` – ${d.price}₪`: '')],
        ['ימים ושעות מועדפים:', d.availability || ''],
        ['הערות למזכירות:', d.message || ''],
        ['טלפון לחזרה:', d.phone || '']
      ]);

      Chat.button('אישור ושליחה למזכירות 📤', submitOneOff, 'btn');
      Chat.button('עריכה', ()=> Chat.goBack?.(), 'btn');
    }

    async function submitOneOff(){
      const d=Chat.State.data;

      // ולידציה סופית
      const errs=[];
      if(!d.firstName || !d.lastName) errs.push('name');
      if(!Chat.validILPhone(d.phone)) errs.push('phone');
      if(!d.subject) errs.push('subject');
      if(!d.grade) errs.push('grade');
      if(!d.planType) errs.push('plan');
      if(!d.availability) errs.push('availability');

      if(errs.length){
        Chat.botText('חסר שדה נדרש. אנא בדקו ונסו שוב.').classList.add('err');
        return;
      }

      const stopProcessing = Chat.showProcessing('שולח למזכירות…');
      const ok = await Chat.sendLeadToSheet({
        path: 'שיעור על בסיס מקום פנוי',
        cta: 'שיעור חד־פעמי',
        planType: Chat.cfg.PLAN_HE[d.planType],
        price: `${d.price||''}₪`,
        subject: d.subject,
        grade: d.grade,
        units: d.units || '',
        availability: d.availability,
        message: d.message || '',
        extraNotes: '',
        fullName: `${d.firstName||''} ${d.lastName||''}`.trim(),
        firstName: d.firstName,
        lastName:  d.lastName,
        phone: d.phone,
        source: 'יוסטון – אתר',
        status: 'לטיפול',
        createdAt: new Date().toISOString()
      });
      stopProcessing();

      Chat.clear();
      if(ok){
        Chat.botText('המידע נשלח למזכירות ✅ ניצור קשר בהקדם בוואטסאפ לתיאום שיעור על בסיס מקום פנוי 👨‍🚀').classList.add('ok');
      }else{
        Chat.botText('לא הצלחנו לשמור את הבקשה ❌ ניתן לנסות שוב או לפנות בוואטסאפ 050‑9570866.').classList.add('err');
      }
      const home = Chat.button('חזרה לתפריט הראשי', ()=> location.href='../index.html', 'btn');
      home.focus();
    }

    function setHelpCtx(ctx){
      const btn = document.getElementById('faqBtn');
      if(!btn) return;
      const base = '../faq.html';
      btn.href = ctx ? `${base}?ctx=${encodeURIComponent(ctx)}` : base;
    }

    // הפעלה
    start();
  </script>
</body>
</html>