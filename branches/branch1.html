<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>שיעור חד פעמי על בסיס מקום פנוי</title>

  <link rel="stylesheet" href="../styles.css?v=3" />
  <meta name="theme-color" content="#2563eb" />
  <style>
    #area{overflow-y:auto;max-height:70vh;scroll-behavior:smooth}
    /* הרחבה עדינה של בועות תוכן רחבות (בעיקר למסך זמינות) */
    .bubble.bot.wide { max-width: 960px; width: 100%; margin-inline: auto; }
    .slots-grid { display:grid; gap:8px; }
    .slot-row { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; }
    .slot-preview { margin-top:8px; font-size:.95rem; line-height:1.6; }
    .slot-preview .chip { margin:4px 6px 0 0; }
    .muted.small { font-size:.9rem; opacity:.8; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <!-- כותרת -->
      <div class="head">
        <div class="brand">
          <div class="logo">HB</div>
          <div class="title">שיעור חד פעמי על בסיס מקום פנוי</div>
        </div>
      </div>

      <!-- אזור התוכן -->
      <div class="body chat-body" id="area" role="log" aria-live="polite" aria-atomic="false"></div>

      <!-- תחתית -->
      <div class="footer">
        <button id="backBtn" class="btn" disabled>חזרה</button>
        <button class="btn" onclick="location.href='../index.html'">לתפריט ראשי</button>
      </div>
    </div>
  </div>

  <!-- סקריפטים משותפים -->
  <script src="./js/config.js?v=2"></script>
  <script src="./js/chat-helpers.js?v=2"></script>

  <script>
    // ===== עזר קטן ל-select =====
    function selectRow(label, options, id){
      const wrap = document.createElement('div');
      wrap.className = 'input-wrap bubble bot';
      const l = document.createElement('label');
      l.textContent = label;
      if(id) l.htmlFor = id;

      const sel = document.createElement('select');
      sel.id = id;
      sel.className = 'input';
      sel.style.direction = 'rtl';

      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = 'בחר/י...';
      sel.appendChild(opt0);

      options.forEach(v=>{
        const o=document.createElement('option');
        o.value=v; o.textContent=v;
        sel.appendChild(o);
      });

      wrap.append(l, sel);
      document.getElementById('area').appendChild(wrap);
      const a=document.getElementById('area'); a.scrollTop = a.scrollHeight;
      return sel;
    }

    // ===== התחלה: קודם אוספים פרטי קשר =====
    function start(){
      Chat.clear(); Chat.push(start);
      stepContactFirst();
    }

    // ===== שלב 0: פרטי קשר (בהתחלה) =====
    async function stepContactFirst(){
      Chat.clear(); Chat.push(stepContactFirst);

      const header = Chat.botHTML('<strong>כדי שנתאם שיעור על בסיס מקום פנוי</strong><br><span class="muted">נשמח לשם פרטי, שם משפחה ומספר טלפון לחזרה</span> 👨‍🚀');
      Chat.scrollStartOf(header);

      await waitP(300);
      const firstName = Chat.inputRow('שם פרטי', {
        id:'firstName', placeholder:'לדוגמה: דנה', required:true, autocomplete:'given-name'
      });

      await waitP(120);
      const lastName = Chat.inputRow('שם משפחה', {
        id:'lastName', placeholder:'לדוגמה: לוי', required:true, autocomplete:'family-name'
      });

      await waitP(120);
      const phone = Chat.inputRow('טלפון לחזרה', {
        type:'tel', id:'phone', placeholder:'לדוגמה: 0501234567', required:true, autocomplete:'tel', inputmode:'tel'
      });

      await waitP(120);
      Chat.button('המשך', ()=>{
        Chat.userBubble('המשך');

        const fn  = (firstName.value||'').trim();
        const ln  = (lastName.value||'').trim();
        const tel = Chat.normalizeILPhone(phone.value||'');

        if(!fn){  Chat.botText('נדרש שם פרטי ✏️').classList.add('err'); firstName.focus(); return; }
        if(!ln){  Chat.botText('נדרש שם משפחה ✏️').classList.add('err'); lastName.focus(); return; }
        if(!Chat.validILPhone(tel)){ Chat.botText('מספר טלפון לא תקין 📞').classList.add('err'); phone.focus(); return; }

        Chat.State.data.firstName = fn;
        Chat.State.data.lastName  = ln;
        Chat.State.data.phone     = tel;

        stepSubject();
      }, 'btn primary');

      function waitP(ms){ return new Promise(r=>setTimeout(r, ms)); }
    }

    // ===== שלב 1: מקצוע (עם פנייה אישית בשם פרטי) =====
    function stepSubject(){
      Chat.clear(); Chat.push(stepSubject);

      const name = Chat.State.data.firstName ? ` ${Chat.State.data.firstName}` : '';
      Chat.typingThen(
        `<strong>מעולה${name}! אשמח לעזור לתאם שיעור חד פעמי, על בסיס מקום פנוי 👨‍🚀</strong><br>` +
        `<strong>איזה מקצוע תרצו?</strong> 📖`,
        650, true
      );

      setTimeout(()=>{
        // הוספת ביולוגיה + שינוי ניסוח "אנגלית מדוברת"
        const fromCfg = (Chat.cfg.SUBJECTS || []).map(s => s === 'אנגלית מדוברת' ? 'אנגלית מדוברת לקטנטנים' : s);
        if (!fromCfg.includes('ביולוגיה')) fromCfg.push('ביולוגיה');

        fromCfg.forEach(s => Chat.button(s, ()=>{
          Chat.userBubble(s);
          Chat.State.data.subject = s;
          stepGrade();
        }));

        const s = document.createElement('div'); s.className='summary';
        s.appendChild(Chat.chip('שיעור חד־פעמי'));
        document.getElementById('area').appendChild(s);
      }, 900);
    }

    // ===== שלב 2: כיתה =====
    function stepGrade(){
      Chat.clear(); Chat.push(stepGrade);

      const name = Chat.State.data.firstName ? `, ${Chat.State.data.firstName}` : '';
      Chat.typingThen(`<strong>באיזו כיתה?</strong> 👨‍🚀<br><span class="muted small">נשתדל להתאים הכי טוב שאפשר${name}</span>`, 600, true);

      setTimeout(()=>{
        const grades = ['א','ב','ג','ד','ה','ו','ז','ח','ט','י','יא','יב','חינוך ביתי','סטודנט/ית','אחר'];
        const gradeSelect = selectRow('כיתה', grades, 'grade');

        Chat.button('המשך', ()=>{
          Chat.userBubble('המשך');

          const g = gradeSelect.value;
          if(!g){
            Chat.botText('נדרש לבחור כיתה ✏️').classList.add('err');
            gradeSelect.focus(); return;
          }
          Chat.State.data.grade = g;
          if (['י','יא','יב'].includes(g)) { stepUnits(); }
          else { stepPlan(); }
        }, 'btn primary');

      }, 800);
    }

    // ===== שלב 2b: יחידות (לתיכון) =====
    function stepUnits(){
      Chat.clear(); Chat.push(stepUnits);

      Chat.typingThen('<strong>כמה יחידות בגרות?</strong> 👨‍🚀', 600, true);

      setTimeout(()=>{
        ['3','4','5'].forEach(u => Chat.button(u, ()=>{
          Chat.userBubble(u);
          Chat.State.data.units = u;
          stepPlan();
        }));

        const s = document.createElement('div'); s.className='summary';
        s.appendChild(Chat.chip(`כיתה: ${Chat.State.data.grade}`));
        if (Chat.State.data.subject) s.appendChild(Chat.chip(`מקצוע: ${Chat.State.data.subject}`));
        document.getElementById('area').appendChild(s);
      }, 700);
    }

    // ===== שלב 3: מסלול =====
    function stepPlan(){
      Chat.clear(); Chat.push(stepPlan);

      const P = Chat.cfg.PRICES, H = Chat.cfg.PLAN_HE;
      Chat.typingThen('<strong>בחירת מסלול</strong><br><span class="muted">נא לבחור מסלול מתאים:</span> 👨‍🚀', 600, true);

      setTimeout(()=>{
        const isMath = (Chat.State.data.subject || '').trim() === 'מתמטיקה';
        const isHighGrade = ['יא','יב'].includes(Chat.State.data.grade);
        const isFiveUnits = (Chat.State.data.units || '') === '5';
        const allowGroup = !(isMath && isHighGrade && isFiveUnits);

        if (allowGroup){
          Chat.button(`קבוצה – עד 5 תלמידים – ${P.group}₪`, ()=>{
            Chat.userBubble(`קבוצה – עד 5 תלמידים – ${P.group}₪`);
            Chat.State.data.planType='group';
            Chat.State.data.price=P.group;
            stepAvailability();
          }, 'btn primary');
        }

        Chat.button(`טריפל – עד 3 תלמידים – ${P.triple}₪`, ()=>{
          Chat.userBubble(`טריפל – עד 3 תלמידים – ${P.triple}₪`);
          Chat.State.data.planType='triple';
          Chat.State.data.price=P.triple;
          stepAvailability();
        });

        Chat.button(`פרטי – ${P.private}₪`, ()=>{
          Chat.userBubble(`פרטי – ${P.private}₪`);
          Chat.State.data.planType='private';
          Chat.State.data.price=P.private;
          stepAvailability();
        });

        const s = document.createElement('div'); s.className='summary';
        if (Chat.State.data.subject) s.appendChild(Chat.chip(`מקצוע: ${Chat.State.data.subject}`));
        if (Chat.State.data.grade)   s.appendChild(Chat.chip(`כיתה: ${Chat.State.data.grade}${Chat.State.data.units?` • ${Chat.State.data.units} יח׳`:''}`));
        document.getElementById('area').appendChild(s);
      }, 800);
    }

    // ===== שלב 4: בחירת זמינות (רחב + פתיחת "הוסף" רק אחרי מילוי קודם) =====
    function stepAvailability(){
      Chat.clear(); Chat.push(stepAvailability);

      const name = Chat.State.data.firstName ? `, ${Chat.State.data.firstName}` : '';
      Chat.typingThen(
        '<strong>שעות פתיחה</strong><br>' +
        '<span class="muted">אנחנו פתוחים בימים א׳–ה׳ בין 14:00–21:00.</span><br><br>' +
        `<strong>בחירת ימים ושעות מועדפים${name}</strong> 👨‍🚀`,
        650, true
      );

      setTimeout(()=>{
        const area = document.getElementById('area');

        // מעטפת רחבה
        const pickerWrap = document.createElement('div');
        pickerWrap.className = 'bubble bot wide';

        const grid = document.createElement('div');
        grid.className = 'slots-grid';

        const rowsWrap = document.createElement('div');
        rowsWrap.id = 'rowsWrap';
        rowsWrap.className = 'slots-grid';

        // תצוגה מקדימה חיה של המועדים התקינים
        const preview = document.createElement('div');
        preview.className = 'slot-preview';

        function toNum(s){ return parseInt(String(s||'').replace(':',''),10) || 0; }
        const TIMES = ['','14:00','15:00','16:00','17:00','18:00','19:00','20:00'];
        const DAYS  = ['','א','ב','ג','ד','ה'];

        function makeSelect(placeholder, values){
          const sel = document.createElement('select');
          sel.className = 'input';
          values.forEach(v=>{
            const o = document.createElement('option');
            o.value = v;
            o.textContent = v ? (placeholder ? `${placeholder} ${v}` : v) : placeholder || 'בחר/י...';
            sel.appendChild(o);
          });
          return sel;
        }

        // הפעלת/כיבוי כפתור הוספה בהתאם למילוי השורה האחרונה
        function lastRowFilled(){
          const rows = Array.from(rowsWrap.children);
          if (!rows.length) return false;
          const last = rows[rows.length - 1];
          const [dSel, fSel, tSel] = last.querySelectorAll('select');
          const d = dSel.value, f = fSel.value, t = tSel.value;
          if(!(d && f && t)) return false;
          return toNum(f) < toNum(t);
        }

        function refreshPreview(){
          preview.innerHTML = '';
          const rows = Array.from(rowsWrap.children);
          const chosen = [];
          for(const r of rows){
            const [dSel, fSel, tSel] = r.querySelectorAll('select');
            const d = dSel.value, f = fSel.value, t = tSel.value;
            if(d && f && t && toNum(f) < toNum(t)){
              chosen.push({d,f,t});
            }
          }
          if(!chosen.length){
            const tip = document.createElement('div');
            tip.className = 'muted small';
            tip.textContent = 'נבחרים מוצגים כאן לאחר מילוי תקין של יום/משעה/עד שעה.';
            preview.appendChild(tip);
            return;
          }
          const chips = document.createElement('div');
          chosen.forEach(c => chips.appendChild(Chat.chip(`יום ${c.d} ${c.f}–${c.t}`)));
          preview.appendChild(chips);
        }

        function wireRow(row){
          const inputs = row.querySelectorAll('select');
          inputs.forEach(sel=>{
            sel.addEventListener('change', ()=>{
              // סדר זמנים תקין? אם לא – הודעת שגיאה חד־פעמית לשורה
              const [dSel, fSel, tSel] = row.querySelectorAll('select');
              const d = dSel.value, f = fSel.value, t = tSel.value;
              const errPrev = row.querySelector('.row-error');
              if (errPrev) errPrev.remove();

              if (f && t && toNum(f) >= toNum(t)){
                const err = document.createElement('div');
                err.className = 'row-error muted small';
                err.textContent = '״עד שעה״ חייב להיות אחרי ״משעה״';
                row.appendChild(err);
              }
              addBtn.disabled = !lastRowFilled();
              refreshPreview();
            });
          });
        }

        function addRow(force=false){
          // אם לא הכריחו (force=false), מותר להוסיף רק אם השורה האחרונה מלאה
          if (!force && !lastRowFilled()){
            Chat.botText('ניתן להוסיף מועד נוסף רק לאחר שמילאת את המועד הקודם.').classList.add('err');
            return;
          }
          const row = document.createElement('div');
          row.className = 'slot-row';

          const daySel  = makeSelect('בחר/י יום', DAYS);
          const fromSel = makeSelect('משעה', TIMES);
          const toSel   = makeSelect('עד שעה', TIMES);

          row.append(daySel, fromSel, toSel);
          rowsWrap.appendChild(row);
          wireRow(row);
          addBtn.disabled = true;       // עד שימולא
          refreshPreview();
          area.scrollTop = area.scrollHeight;
          return row;
        }

        const title = document.createElement('div');
        title.className='muted';
        title.innerHTML = 'ניתן להוסיף יותר ממועד אחד. <span class="small">הוספת מועד נוסף תתאפשר רק לאחר מילוי המועד הנוכחי.</span>';

        const addBtn = document.createElement('button');
        addBtn.className='btn';
        addBtn.textContent = '+ הוספת מועד נוסף';
        addBtn.disabled = true;
        addBtn.onclick = ()=> addRow(false);

        const actions = document.createElement('div');
        actions.style.display='flex';
        actions.style.gap='8px';
        actions.style.marginTop='4px';

        grid.append(title, rowsWrap, addBtn, preview);
        pickerWrap.appendChild(grid);
        area.appendChild(pickerWrap);

        // שורה ראשונה חובה (force=true כדי שתיפתח גם בלי מילוי קודם)
        addRow(true);

        // כפתור המשך
        Chat.button('המשך', ()=>{
          Chat.userBubble('המשך');

          // איסוף הבחירות התקינות
          const rows = Array.from(rowsWrap.children);
          const chosen = [];
          for(const r of rows){
            const [daySel, fromSel, toSel] = r.querySelectorAll('select');
            const d = daySel.value, f = fromSel.value, t = toSel.value;
            if(d && f && t){
              if (toNum(f) >= toNum(t)){
                Chat.botText(`במועד יום ${d}: "עד שעה" חייב להיות אחרי "משעה" ⏱️`).classList.add('err');
                return;
              }
              chosen.push(`יום ${d} ${f}–${t}`);
            }
          }
          if (!chosen.length){
            Chat.botText('נדרש לבחור לפחות מועד אחד 🕒').classList.add('err');
            return;
          }

          Chat.State.data.availability = chosen.join('; ');
          stepNotes();
        }, 'btn primary');

      }, 900);
    }

    // ===== שלב 5: הערות (אופציונלי) =====
    function stepNotes(){
      Chat.clear(); Chat.push(stepNotes);

      const name = Chat.State.data.firstName ? `, ${Chat.State.data.firstName}` : '';
      Chat.typingThen(`<strong>הערות למזכירות</strong><br><span class="muted">אפשר לציין העדפה למורה, רמה, או בקשה מיוחדת (לא חובה)${name}</span> 👨‍🚀`, 600, true);

      setTimeout(()=>{
        const message = Chat.inputRow('הערות (לא חובה)', {
          textarea:true, id:'message', placeholder:'לדוגמה: רענון לקראת מבחן / העדפה לשעת ערב'
        });

        Chat.button('המשך', ()=>{
          Chat.userBubble('המשך');
          Chat.State.data.message = (message.value||'').trim();
          stepReview();
        }, 'btn primary');

      }, 800);
    }

    // ===== שלב 6: סיכום ושליחה =====
    function stepReview(){
      Chat.clear(); Chat.push(stepReview);

      const h = Chat.botHTML('<strong>סיכום הבקשה</strong><br><span class="muted">נא לוודא שהכול נכון לפני שליחה.</span> 👨‍🚀');
      Chat.scrollStartOf(h);

      const card = document.createElement('div'); card.className='bubble bot';

      // צ׳יפים
      const chips = document.createElement('div'); chips.className='summary';
      if (Chat.State.data.subject)   chips.appendChild(Chat.chip(`מקצוע: ${Chat.State.data.subject}`));
      if (Chat.State.data.grade)     chips.appendChild(Chat.chip(`כיתה: ${Chat.State.data.grade}${Chat.State.data.units?` • ${Chat.State.data.units} יח׳`:''}`));
      if (Chat.State.data.planType)  chips.appendChild(Chat.chip(`מסלול: ${Chat.cfg.PLAN_HE[Chat.State.data.planType]} (${Chat.State.data.price}₪)`));
      card.appendChild(chips);

      // דו"ח סיכום בשפה אחידה
      const d = Chat.State.data;
      const details = document.createElement('div'); details.style.lineHeight='1.9';
      const addLine = (label, value)=>{
        const line=document.createElement('div');
        const b=document.createElement('strong'); b.textContent=label+' ';
        const span=document.createElement('span'); span.textContent=value;
        line.append(b, span); details.appendChild(line);
      };
      addLine('שם:', `${d.firstName||''}`);
      addLine('שם משפחה:', `${d.lastName||''}`);
      addLine('מקצוע:', `${d.subject||''}`);
      addLine('כיתה:', `${d.grade||''}${d.units?` • ${d.units} יח׳`:''}`);
      addLine('מסלול:', `${(Chat.cfg.PLAN_HE[d.planType]||'')}${d.price?` – ${d.price}₪`:''}`);
      addLine('ימים ושעות מועדפים:', d.availability||'');
      if (d.message) addLine('הערות למזכירות:', d.message);
      addLine('טלפון לחזרה:', d.phone||'');

      card.appendChild(details);
      document.getElementById('area').appendChild(card);
      (function(){ const a=document.getElementById('area'); a.scrollTop=a.scrollHeight; })();

      Chat.button('אישור ושליחה למזכירות 📤', async ()=>{
        const stopProcessing = Chat.showProcessing();

        const fullName = `${Chat.State.data.firstName||''} ${Chat.State.data.lastName||''}`.trim();

        const ok = await Chat.sendLeadToSheet({
          path: 'שיעור על בסיס מקום פנוי',
          planType: Chat.cfg.PLAN_HE[Chat.State.data.planType],
          price: `${Chat.State.data.price}₪`,
          subject: Chat.State.data.subject,
          grade: Chat.State.data.grade,
          units: Chat.State.data.units || '',
          availability: Chat.State.data.availability,
          message: Chat.State.data.message || '',
          extraNotes: '',
          fullName,
          firstName: Chat.State.data.firstName,
          lastName:  Chat.State.data.lastName,
          phone: Chat.State.data.phone,
          cta: 'שיעור חד־פעמי',
          source: 'יוסטון – אתר',
          status: 'לטיפול',
          createdAt: new Date().toISOString()
        });

        stopProcessing();
        Chat.clear();

        if(ok){
          Chat.botText('המידע נשלח למזכירות ✅ ניצור קשר בהקדם בוואטסאפ לתיאום שיעור על בסיס מקום פנוי 👨‍🚀').classList.add('ok');
        }else{
          Chat.botText('לא הצלחנו לשמור את הבקשה לגיליון ❌ ניתן לנסות שוב או לפנות בוואטסאפ 050‑9570866.').classList.add('err');
        }
        const home = Chat.button('חזרה לתפריט הראשי', ()=> location.href='../index.html', 'btn');
        home.focus();
      }, 'btn primary');
    }

    // הפעלה
    start();
  </script>
</body>
</html>