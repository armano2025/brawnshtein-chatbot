<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>×©×™×¢×•×¨ ×¢×œ ×‘×¡×™×¡ ××§×•× ×¤× ×•×™</title>

  <!-- ×‘×¢× ×¤×™× ×‘×ª×•×š /branches/ ×—×™×™×‘×™× ../ -->
  <link rel="stylesheet" href="../styles.css?v=3" />
  <meta name="theme-color" content="#2563eb" />
  <style>
    /* ×—×™×–×•×§ ××§×•××™ ×œ×’×œ×™×œ×” ×‘××–×•×¨ ×”×©×™×—×” */
    #area { overflow-y:auto; max-height:70vh; scroll-behavior:smooth; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <!-- ×›×•×ª×¨×ª -->
      <div class="head">
        <div class="brand">
          <div class="logo">HB</div>
          <div class="title">×©×™×¢×•×¨ ×¢×œ ×‘×¡×™×¡ ××§×•× ×¤× ×•×™</div>
        </div>
      </div>

      <!-- ××–×•×¨ ×”×ª×•×›×Ÿ -->
      <div class="body chat-body" id="area" role="log" aria-live="polite" aria-atomic="false"></div>

      <!-- ×›×¤×ª×•×¨×™ × ×™×•×•×˜ -->
      <div class="footer">
        <button id="backBtn" class="btn" disabled>×—×–×¨×”</button>
        <button id="homeBtn" class="btn primary" onclick="location.href='../index.html'">×œ×ª×¤×¨×™×˜ ×¨××©×™</button>
      </div>
    </div>
  </div>

  <script>
    /* ===== ×§×•× ×¤×™×’ ===== */
    const SHEETS_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbwnNKY0BeO5N2O9oWmr8ltCHr9fVdDdrXsL_3erastx4qdEqhCz1mYAhkvZETF-86CGnw/exec';
    const PRICES   = { group: 80, triple: 100, private: 160 };
    const PLAN_HE  = { group: '×§×‘×•×¦×”', triple: '×˜×¨×™×¤×œ', private: '×¤×¨×˜×™' };
    const SUBJECTS = ['×× ×’×œ×™×ª','××ª××˜×™×§×”','×¤×™×–×™×§×”','×©×¤×”','×× ×’×œ×™×ª ××“×•×‘×¨×ª'];

    /* ===== DOM/State ===== */
    const area    = document.getElementById('area');
    const backBtn = document.getElementById('backBtn');

    const state = {
      history: [],
      data: {
        planType: null, price: null, subject: null,
        availability: null, message: '', fullName: null, phone: null
      }
    };

    // × ×™×”×•×œ ×˜×™×™××¨×™× â€œ×–×•××‘×™×â€ + ××•×˜×•â€‘×¡×§Ö°×¨×•Ö¹×œ
    let runToken = 0;
    let autoScrollEnabled = true;
    const enableAutoScroll  = () => (autoScrollEnabled = true);
    const disableAutoScroll = () => (autoScrollEnabled = false);

    const last = () => state.history[state.history.length - 1];
    const push = fn => { state.history.push(fn); updateBack(); };
    const goBack = () => {
      if (state.history.length > 1) {
        state.history.pop();
        updateBack();
        runToken++;
        last()();
      }
    };
    backBtn.onclick = goBack;
    function updateBack(){ backBtn.disabled = state.history.length <= 1; }

    /* ===== UI helpers ===== */
    const clear = () => { runToken++; area.innerHTML = ''; };
    const autoscroll = () => { if (autoScrollEnabled) area.scrollTop = area.scrollHeight; };
    const scrollStartOf = el => el?.scrollIntoView({ block:'start', behavior:'smooth' });

    function botHTML(html){
      const d = document.createElement('div');
      d.className = 'bubble bot';
      d.innerHTML = html;
      area.appendChild(d);
      autoscroll();
      return d;
    }
    function botText(text){
      const d = document.createElement('div');
      d.className = 'bubble bot';
      d.textContent = text;
      area.appendChild(d);
      autoscroll();
      return d;
    }
    function user(text){
      const d = document.createElement('div');
      d.className = 'bubble user';
      d.textContent = text;
      area.appendChild(d);
      autoscroll();
      return d;
    }
    function button(text, onClick, cls='btn'){
      const b = document.createElement('button');
      b.className = cls;
      b.textContent = text;
      b.onclick = ()=>{
        b.disabled = true; // ××•× ×¢ ×“××‘×œ-×§×œ×™×§
        onClick();
      };
      area.appendChild(b);
      autoscroll();
      return b;
    }
    function chip(text){ const c = document.createElement('div'); c.className='chip'; c.textContent=text; return c; }

    function inputRow(label, {type='text', id, textarea=false, placeholder='', required=false, autocomplete, inputmode} = {}){
      const wrap = document.createElement('div');
      wrap.className = 'input-wrap bubble bot';

      const l = document.createElement('label');
      l.textContent = label;
      if(id) l.htmlFor = id;

      let el = textarea ? document.createElement('textarea') : document.createElement('input');
      if(!textarea) el.type = type;
      el.className = textarea ? 'textarea' : 'input';
      el.id = id; el.placeholder = placeholder; el.dir='rtl';
      if(required) el.required = true;
      if(autocomplete) el.autocomplete = autocomplete;
      if(inputmode) el.setAttribute('inputmode', inputmode);

      wrap.append(l, el);
      area.appendChild(wrap);
      autoscroll();
      return el;
    }

    // ××™× ×“×™×§×¦×™×™×ª ×”×§×œ×“×” -> ×”×•×“×¢×ª ×‘×•×˜ (××›×‘×“ ×‘×™×˜×•×œ×™×)
    function typingThen(html, delay=900, trusted=true){
      const myToken = runToken;
      const t = document.createElement('div');
      t.className = 'typing-indicator';
      t.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
      area.appendChild(t);
      autoscroll();
      setTimeout(()=>{
        if(myToken!==runToken) return;
        t.remove();
        trusted ? botHTML(html) : botText(html);
      }, delay);
    }

    // â€œ×©×•×œ×—â€¦â€ ×¢× ×¤×¡ ×”×ª×§×“××•×ª
    function showProcessing(text='×©×•×œ×— ×œ××–×›×™×¨×•×ªâ€¦'){
      const d = document.createElement('div');
      d.className = 'bubble bot processing';
      d.innerHTML = `<strong>${text}</strong><div class="progress"><div class="progress-bar"></div></div>`;
      area.appendChild(d); autoscroll();
      return () => d.remove();
    }

    /* ===== Utils ===== */
    const normalizeILPhone = raw => {
      let p=(raw||'').toString().trim().replace(/[^\d+]/g,'');
      if(p.startsWith('+972')) p='0'+p.slice(4);
      if(p.startsWith('972'))  p='0'+p.slice(3);
      return p;
    };
    const validILPhone = p => /^0\d{8,9}$/.test(p||'');

    async function sendLeadToSheet(payload){
      const ctrl = new AbortController();
      const timeout = setTimeout(()=>ctrl.abort(), 10000);
      try{
        const res = await fetch(SHEETS_WEBAPP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' }, // simple request (×œ×œ× preflight)
          body: JSON.stringify(payload),
          signal: ctrl.signal
        });
        try{
          const j = await res.json();
          return j && j.ok === true;
        }catch(_){
          return res.ok;
        }
      }catch(e){
        console.error('Sheets error', e);
        return false;
      }finally{ clearTimeout(timeout); }
    }

    /* ===== ×–×¨×™××” ===== */
    function start(){
      clear(); push(start);

      typingThen(
        '××©××— ×œ×¢×–×•×¨ ×œ×š ×œ×§×‘×•×¢ ×©×™×¢×•×¨ ×—×“Ö¾×¤×¢××™ ğŸ—“ï¸<br><br>' +
        '×‘××¨×›×– ×‘×¨××•× ×©×˜×™×™×Ÿ, ×’× ×‘×©×™×¢×•×¨ ×§×‘×•×¦×ª×™ ×›×œ ×ª×œ××™×“ ××§×‘×œ ×™×—×¡ ××™×©×™ ×•×ª×›× ×™×ª ×œ×™××•×“ ××•×ª×××ª ×œ×¦×¨×›×™× ×©×œ×• â€” ×‘×œ×™ ×§×©×¨ ×œ×§×¦×‘ ×©×œ ××—×¨×™×.',
        900, true
      );

      setTimeout(()=> typingThen('<strong>××™×–×” ×¡×•×’ ×©×™×¢×•×¨ ×ª×¨×¦×™?</strong>', 800, true), 2000);

      setTimeout(()=>{
        button('×§×‘×•×¦×” â€“ ×¢×“ 5 ×ª×œ××™×“×™× â€“ 80â‚ª', ()=>{
          user('×§×‘×•×¦×” â€“ ×¢×“ 5 ×ª×œ××™×“×™× â€“ 80â‚ª');
          state.data.planType='group'; state.data.price=PRICES.group; stepSubject();
        }, 'btn primary');

        button('×˜×¨×™×¤×œ â€“ ×¢×“ 3 ×ª×œ××™×“×™× â€“ 100â‚ª', ()=>{
          user('×˜×¨×™×¤×œ â€“ ×¢×“ 3 ×ª×œ××™×“×™× â€“ 100â‚ª');
          state.data.planType='triple'; state.data.price=PRICES.triple; stepSubject();
        });

        button('×¤×¨×˜×™ â€“ 160â‚ª', ()=>{
          user('×¤×¨×˜×™ â€“ 160â‚ª');
          state.data.planType='private'; state.data.price=PRICES.private; stepSubject();
        });
      }, 3000);
    }

    function stepSubject(){
      clear(); push(stepSubject);
      typingThen('<strong>×‘××™×–×” ××§×¦×•×¢ ×ª×¨×¦×™ ××ª ×”×©×™×¢×•×¨? ğŸ“–</strong>', 800, true);

      setTimeout(()=>{
        SUBJECTS.forEach(s => button(s, ()=>{
          user(s);
          state.data.subject = s;
          stepDetails();
        }));
        // ××¦×™×’×™× ×¦×³×™×¤×¡ ××¡×œ×•×œ+××—×™×¨ ×›×‘×¨ ×›××Ÿ (×—×™×–×•×§ ×”×§×©×¨ ×”×•×™×–×•××œ×™)
        const s = document.createElement('div'); s.className='summary';
        if (state.data.planType) s.appendChild(chip(`××¡×œ×•×œ: ${PLAN_HE[state.data.planType]} (${state.data.price}â‚ª)`));
        area.appendChild(s); autoscroll();
      }, 1500);
    }

    // ×©×œ×‘ ×¤×¨×˜×™× â€” ×¨×™× ×“×•×¨ ××“×•×¨×’ ×•××‘×•×§×¨ (×œ×œ× ×§×¤×™×¦×” ×œ×ª×—×ª×™×ª)
    async function stepDetails(){
      clear(); push(stepDetails);

      // 1) × ×•×¢×œ ××•×˜×•-×¡×§Ö°×¨×•Ö¹×œ ×œ×–××Ÿ ×§×¦×¨ ×›×“×™ ×œ×× ×•×¢ ×§×¤×™×¦×”
      disableAutoScroll();
      const header = botHTML('<strong>×¤×¨×˜×™ ×©×™×‘×•×¥</strong><br><span class="muted">× ××œ× ×¨×’×¢ ×¤×¨×˜×™× ×•××– × ×¡×›× ğŸ“‹</span>');
      // ××¦×™×’×™× ×¦×³×™×¤×¡×™×
      const chips = document.createElement('div'); chips.className='summary';
      if (state.data.planType) chips.appendChild(chip(`××¡×œ×•×œ: ${PLAN_HE[state.data.planType]} (${state.data.price}â‚ª)`));
      if (state.data.subject)  chips.appendChild(chip(`××§×¦×•×¢: ${state.data.subject}`));
      area.appendChild(chips);

      // ××’×œ×’×œ ×‘×¢×“×™× ×•×ª ×œ×¨××© ×”×§×˜×¢, ×œ× ×œ×ª×—×ª×™×ª
      scrollStartOf(header);

      // ××—×¨×™ 450ms ××—×–×™×¨×™× ××•×˜×•-×¡×§Ö°×¨×•Ö¹×œ (×”××¡×š ×›×‘×¨ ×™×©×‘)
      setTimeout(()=> enableAutoScroll(), 450);

      // 2) ×¨×™× ×“×•×¨ ×©×“×•×ª ×‘×”×©×”×™×” ×§×œ×” ×‘×™×Ÿ ××—×“ ×œ×©× ×™ (×§×¨×™× ×™×•×ª×¨)
      await waitP(300);
      const availability = inputRow('×™××™ ×•×©×¢×•×ª ×–××™× ×•×ª', {
        textarea:true, id:'availability',
        placeholder:'×œ×“×•×’××”: ××³â€“×’×³ 15:00â€“19:00; ×•×³ ×‘×•×§×¨', required:true
      });

      await waitP(150);
      const message = inputRow('×”×•×“×¢×” ×—×•×¤×©×™×ª (×œ× ×—×•×‘×”)', {
        textarea:true, id:'message', placeholder:'×”×¢×“×¤×” ×œ××•×¨×” / ×¨××” / ×”×¢×¨×•×ª'
      });

      await waitP(150);
      const fullName = inputRow('×©× ××œ×', {
        id:'fullName', placeholder:'×œ×“×•×’××”: ×“× ×” ×œ×•×™', required:true, autocomplete:'name'
      });

      await waitP(150);
      const phone = inputRow('×˜×œ×¤×•×Ÿ ×œ×—×–×¨×”', {
        type:'tel', id:'phone', placeholder:'×œ×“×•×’××”: 0501234567',
        required:true, autocomplete:'tel', inputmode:'tel'
      });

      // × ×•×ª×Ÿ ×¤×•×§×•×¡ ×œ×©×“×” ×”×¨××©×•×Ÿ â€“ ×”××©×ª××© ××™×“ ×¨×•××” ××™×¤×” ×œ×”×ª×—×™×œ
      availability.focus({ preventScroll:true });

      await waitP(120);
      const next = button('×”××©×š ×œ×¡×™×›×•×', ()=>{
        user('×”××©×š ×œ×¡×™×›×•×');

        const avail = (availability.value||'').trim();
        const note  = (message.value||'').trim();
        const name  = (fullName.value||'').trim();
        const tel   = normalizeILPhone(phone.value||'');

        if(!avail){ botText('×× × ×›×ª×‘×™ ×–××™× ×•×ª (×™××™× ×•×©×¢×•×ª) ğŸ•’').classList.add('err'); availability.focus(); return; }
        if(!name){  botText('×™×© ×œ×”×–×™×Ÿ ×©× ××œ× âœï¸').classList.add('err'); fullName.focus(); return; }
        if(!validILPhone(tel)){ botText('××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ× ×ª×§×™×Ÿ ğŸ“').classList.add('err'); phone.focus(); return; }

        state.data.availability = avail;
        state.data.message      = note;
        state.data.fullName     = name;
        state.data.phone        = tel;

        stepReview();
      }, 'btn primary');

      button('×—×–×¨×”', goBack);

      // ×¢×•×–×¨ ×§×˜×Ÿ ×œ×”×©×”×™×•×ª
      function waitP(ms){ return new Promise(r=>setTimeout(r, ms)); }
    }

    function stepReview(){
      clear(); push(stepReview);

      const h = botHTML('<strong>×¡×™×›×•× ×”×‘×§×©×”</strong><br><span class="muted">×‘×“×§×™ ×©×”×›×•×œ × ×›×•×Ÿ ×œ×¤× ×™ ×©×œ×™×—×”.</span>');
      scrollStartOf(h); // ×’×•×œ×œ ×œ×¨××© ×”×¡×™×›×•×, ×œ× ×œ×ª×—×ª×™×ª

      const card = document.createElement('div'); card.className = 'bubble bot';

      const chips = document.createElement('div'); chips.className='summary';
      if (state.data.planType) chips.appendChild(chip(`××¡×œ×•×œ: ${PLAN_HE[state.data.planType]} (${state.data.price}â‚ª)`));
      if (state.data.subject)  chips.appendChild(chip(`××§×¦×•×¢: ${state.data.subject}`));
      card.appendChild(chips);

      const details = document.createElement('div'); details.style.lineHeight = '1.9';
      const addLine = (label, value) => {
        const line = document.createElement('div');
        const b = document.createElement('strong'); b.textContent = label + ' ';
        const span = document.createElement('span'); span.textContent = value;
        line.append(b, span);
        details.appendChild(line);
      };
      addLine('×–××™× ×•×ª:', state.data.availability);
      if (state.data.message) addLine('×”×•×“×¢×”:', state.data.message);
      addLine('×©× ××œ×:', state.data.fullName);
      addLine('×˜×œ×¤×•×Ÿ ×œ×—×–×¨×”:', state.data.phone);

      card.appendChild(details);
      area.appendChild(card);
      autoscroll();

      const sendBtn = button('××™×©×•×¨ ×•×©×œ×™×—×” ×œ××–×›×™×¨×•×ª ğŸ“¤', async ()=>{
        sendBtn.disabled = true;
        const stopProcessing = showProcessing();

        const ok = await sendLeadToSheet({
          path: '×©×™×¢×•×¨ ×¢×œ ×‘×¡×™×¡ ××§×•× ×¤× ×•×™',
          planType: PLAN_HE[state.data.planType],
          price: `${state.data.price}â‚ª`,
          subject: state.data.subject,
          availability: state.data.availability,
          message: state.data.message,
          extraNotes: '',
          fullName: state.data.fullName,
          phone: state.data.phone,
          cta: '×©×™×¢×•×¨ ×—×“Ö¾×¤×¢××™',
          source: '×™×•×¡×˜×•×Ÿ â€“ ××ª×¨',
          status: '×œ×˜×™×¤×•×œ',
          createdAt: new Date().toISOString()
        });

        stopProcessing();
        clear();

        if(ok){
          botText('×”×‘×§×©×” × ×¨×©××” ×•×”×•×¢×‘×¨×” ×œ××–×›×™×¨×•×ª âœ… × ×—×–×•×¨ ××œ×™×™×š ×‘×§×¨×•×‘ ×›×“×™ ×œ×‘×“×•×§ ×–××™× ×•×ª ×•×œ×”×©×¨×™×™×Ÿ ×©×™×¢×•×¨ ğŸ“…').classList.add('ok');
        }else{
          botText('×œ× ×”×¦×œ×—× ×• ×œ×©××•×¨ ××ª ×”×‘×§×©×” ×œ×’×™×œ×™×•×Ÿ âŒ ××¤×©×¨ ×œ× ×¡×•×ª ×©×•×‘ ××• ×œ×¤× ×•×ª ××œ×™× ×• ×‘×•×•××˜×¡××¤ 050â€‘9570866.').classList.add('err');
        }
        const home = button('×—×–×¨×” ×œ×ª×¤×¨×™×˜ ×”×¨××©×™', ()=> location.href='../index.html', 'btn primary');
        home.focus();
      }, 'btn primary');

      button('×¢×¨×™×›×”', ()=> stepDetails());
    }

    // ×”×¤×¢×œ×”
    start();
  </script>
</body>
</html>