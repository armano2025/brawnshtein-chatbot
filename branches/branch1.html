<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>×©×™×¢×•×¨ ×—×“ ×¤×¢××™ ×¢×œ ×‘×¡×™×¡ ××§×•× ×¤× ×•×™</title>

  <link rel="stylesheet" href="../styles.css?v=3" />
  <meta name="theme-color" content="#5b7cfa" />

  <!-- ×©×“×¨×•×’ ×¢×™×¦×•×‘ × ×§×™ ×•××•×“×¨× ×™ ××¢×œ ×”-CSS ×”×§×™×™× -->
  <style>
    :root{
      --bg1:#0f172a;          /* slate-900 */
      --bg2:#1e293b;          /* slate-800 */
      --card:#0b1226cc;       /* glass */
      --border:#243043;
      --primary:#5b7cfa;      /* ××™× ×“×™×’×•-×›×—×•×œ ×¨×š */
      --primary-2:#7c5bfa;    /* ××™× ×“×™×’×•-×¡×’×œ×’×œ ×œ××¢×‘×¨×™ ×¦×‘×¢ */
      --text:#e5e7eb;
      --muted:#9aa6b2;
      --chip-bg:#18233a;
      --chip-br:#31425d;
      --accent-chip:#ffe8a3;
      --accent-br:#f7c948;
      --danger:#e11d48;
      --ok:#16a34a;
      --radius:16px;
      --radius-sm:12px;
      --shadow:0 10px 30px rgba(0,0,0,.35);
    }

    /* ×¨×§×¢ ×’×¨×“×™×× ×˜ ××•×“×¨× ×™ */
    body{
      background: radial-gradient(1200px 600px at 100% -10%, #1a2a6c 0%, transparent 60%),
                  radial-gradient(900px 500px at -10% 110%, #2a4858 0%, transparent 60%),
                  linear-gradient(140deg, var(--bg1), var(--bg2));
      color: var(--text);
    }

    /* ×›×¨×˜×™×¡ ×–×›×•×›×™×ª×™ */
    .card{
      position:relative;
      background: var(--card);
      border:1px solid var(--border);
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    /* ×¤×¡ ×¢×œ×™×•×Ÿ ××•×¤×¨×“ ×¢× ×›×¤×ª×•×¨ ×ª×¤×¨×™×˜ */
    .topbar{
      display:flex; align-items:center; justify-content:flex-start;
      padding:10px 12px;
      background: linear-gradient(90deg, #0b1226 0%, #0f1833 100%);
      border-bottom:1px solid var(--border);
    }
    .topbar .btn{
      background: transparent;
      border:1px solid var(--chip-br);
      color: var(--text);
      border-radius: 999px;
      padding: 6px 12px;
    }
    .topbar .btn:hover{ border-color: var(--primary); }

    /* ×›×•×ª×¨×ª ×¤× ×™××™×ª ×©××—×¨×™ ×”×˜×•×¤-×‘×¨ â€“ ×™×© ×¨×™×•×•×—, ××™×Ÿ ×—×¤×™×¤×” */
    .head{
      padding-top: 10px;
      background: linear-gradient(135deg, rgba(91,124,250,.12), rgba(124,91,250,.08));
      border-bottom:1px solid var(--border);
    }
    .brand .logo{
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      color:#0b1020;
      border: none;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.35);
    }
    .brand .title{ color:var(--text); }

    /* ××–×•×¨ ×”×ª×•×›×Ÿ */
    #area{overflow-y:auto;max-height:70vh;scroll-behavior:smooth}
    .bubble.bot{ background:#0f172acc; border-color:var(--border); }
    .bubble.user{ background:#101a33; border-color:#223250; }
    .summary .chip{
      background: var(--chip-bg) !important;
      border-color: var(--chip-br) !important;
      color: var(--text) !important;
    }

    /* ×›×¤×ª×•×¨×™× */
    .btn{
      border-radius: 10px;
      border:1px solid var(--chip-br);
      background:#111a31;
      color:var(--text);
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
    }
    .btn:hover{ transform: translateY(-1px); border-color: var(--primary); }
    .btn.primary{
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      border:none; color:#0b1020; font-weight:600;
    }
    .btn.primary:hover{ filter:brightness(1.05); transform: translateY(-1px); }

    /* ×”×¨×—×‘×” ×œ××¡×š ×–××™× ×•×ª */
    .bubble.bot.wide { max-width: 960px; width: 100%; margin-inline: auto; }
    .slots-grid { display:grid; gap:10px; }
    .slot-row { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    .slot-preview {
      margin-top:6px; display:flex; flex-wrap:wrap; gap:8px;
      padding-top:4px; border-top:1px dashed var(--border);
    }
    /* ×©×‘×‘×™ ×¡×™×›×•× ××•×“×’×©×™× + ×›×¤×ª×•×¨ ××—×™×§×” */
    .chip.emph{
      background: var(--accent-chip) !important;
      color:#2f2a00 !important;
      border:1px solid var(--accent-br) !important;
      display:inline-flex; align-items:center; gap:6px;
      padding-inline:10px;
    }
    .chip.emph .x{
      display:inline-flex; align-items:center; justify-content:center;
      width:20px; height:20px; border-radius:50%;
      border:1px solid rgba(0,0,0,.25);
      background:#fff3cd;
      font-size:14px; line-height:1; cursor:pointer;
    }
    .chip.emph .x:hover{ background:#ffe69a; }

    .muted.small { font-size:.9rem; color: var(--muted); }
    .row-error { color: var(--danger); margin-top:4px; }

    /* ××–×•×¨ ×¤×¢×•×œ×•×ª ×‘×ª×—×ª×™×ª ××¡×š ×”×–××™× ×•×ª */
    .slots-actions{
      display:flex; gap:8px; align-items:center; justify-content:flex-start;
      margin-top:12px; padding-top:12px; border-top:1px solid var(--border);
    }

    /* ×§×œ×˜×™× */
    .input, .input-wrap select, .input-wrap textarea{
      background:#0b142a; color:var(--text); border:1px solid var(--chip-br);
      border-radius: 10px;
    }
    label{ color:var(--muted); }

    /* ×¤×•×˜×¨ */
    .footer{
      border-top:1px solid var(--border);
      background: linear-gradient(180deg, rgba(16,24,48,.3), rgba(16,24,48,.5));
    }

    /* ×”×•×“×¢×•×ª ok/err */
    .bubble.ok{ border-color: rgba(22,163,74,.6); background: rgba(22,163,74,.15); }
    .bubble.err{ border-color: rgba(225,29,72,.6); background: rgba(225,29,72,.15); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <!-- ×¤×¡ ×¢×œ×™×•×Ÿ × ×¤×¨×“: ×›×¤×ª×•×¨ ×œ×ª×¤×¨×™×˜ -->
      <div class="topbar">
        <button class="btn" onclick="location.href='../index.html'">×œ×ª×¤×¨×™×˜ ×¨××©×™</button>
      </div>

      <!-- ×›×•×ª×¨×ª -->
      <div class="head">
        <div class="brand">
          <div class="logo">HB</div>
          <div class="title">×©×™×¢×•×¨ ×—×“ ×¤×¢××™ ×¢×œ ×‘×¡×™×¡ ××§×•× ×¤× ×•×™</div>
        </div>
      </div>

      <!-- ××–×•×¨ ×”×ª×•×›×Ÿ -->
      <div class="body chat-body" id="area" role="log" aria-live="polite" aria-atomic="false"></div>

      <!-- ×ª×—×ª×™×ª -->
      <div class="footer">
        <button id="backBtn" class="btn" disabled>×—×–×¨×”</button>
      </div>
    </div>
  </div>

  <!-- ×¡×§×¨×™×¤×˜×™× ××©×•×ª×¤×™× -->
  <script src="./js/config.js?v=2"></script>
  <script src="./js/chat-helpers.js?v=2"></script>

  <script>
    // ===== ×¢×–×¨ ×§×˜×Ÿ ×œ-select =====
    function selectRow(label, options, id){
      const wrap = document.createElement('div');
      wrap.className = 'input-wrap bubble bot';
      const l = document.createElement('label');
      l.textContent = label;
      if(id) l.htmlFor = id;

      const sel = document.createElement('select');
      sel.id = id;
      sel.className = 'input';
      sel.style.direction = 'rtl';

      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = '×‘×—×¨/×™...';
      sel.appendChild(opt0);

      options.forEach(v=>{
        const o=document.createElement('option');
        o.value=v; o.textContent=v;
        sel.appendChild(o);
      });

      wrap.append(l, sel);
      document.getElementById('area').appendChild(wrap);
      const a=document.getElementById('area'); a.scrollTop = a.scrollHeight;
      return sel;
    }

    // ===== ×”×ª×—×œ×”: ×§×•×“× ××•×¡×¤×™× ×¤×¨×˜×™ ×§×©×¨ =====
    function start(){
      Chat.clear(); Chat.push(start);
      stepContactFirst();
    }

    // ===== ×©×œ×‘ 0: ×¤×¨×˜×™ ×§×©×¨ (×‘×”×ª×—×œ×”) =====
    async function stepContactFirst(){
      Chat.clear(); Chat.push(stepContactFirst);

      const header = Chat.botHTML('<strong>×›×“×™ ×©× ×ª×× ×©×™×¢×•×¨ ×¢×œ ×‘×¡×™×¡ ××§×•× ×¤× ×•×™</strong><br><span class="muted">× ×©××— ×œ×©× ×¤×¨×˜×™, ×©× ××©×¤×—×” ×•××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ×—×–×¨×”</span> ğŸ‘¨â€ğŸš€');
      Chat.scrollStartOf(header);

      await waitP(300);
      const firstName = Chat.inputRow('×©× ×¤×¨×˜×™', {
        id:'firstName', placeholder:'×œ×“×•×’××”: ×“× ×”', required:true, autocomplete:'given-name'
      });

      await waitP(120);
      const lastName = Chat.inputRow('×©× ××©×¤×—×”', {
        id:'lastName', placeholder:'×œ×“×•×’××”: ×œ×•×™', required:true, autocomplete:'family-name'
      });

      await waitP(120);
      const phone = Chat.inputRow('×˜×œ×¤×•×Ÿ ×œ×—×–×¨×”', {
        type:'tel', id:'phone', placeholder:'×œ×“×•×’××”: 0501234567', required:true, autocomplete:'tel', inputmode:'tel'
      });

      await waitP(120);
      const btnNext = Chat.button('×”××©×š', ()=>{
        Chat.userBubble('×”××©×š');

        const fn  = (firstName.value||'').trim();
        const ln  = (lastName.value||'').trim();
        const tel = Chat.normalizeILPhone(phone.value||'');

        if(!fn){  showInlineError('× ×“×¨×© ×©× ×¤×¨×˜×™ âœï¸', firstName); return; }
        if(!ln){  showInlineError('× ×“×¨×© ×©× ××©×¤×—×” âœï¸', lastName); return; }
        if(!Chat.validILPhone(tel)){ showInlineError('××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ× ×ª×§×™×Ÿ ğŸ“', phone); return; }

        Chat.State.data.firstName = fn;
        Chat.State.data.lastName  = ln;
        Chat.State.data.phone     = tel;

        stepSubject();
      }, 'btn primary');

      ;[firstName, lastName, phone].forEach(el=>{
        el.addEventListener('input', ()=>{
          removeErrBubblesNear();
          btnNext.disabled = false;
        });
      });

      function showInlineError(msg, el){
        Chat.botText(msg).classList.add('err');
        el.focus();
      }
      function removeErrBubblesNear(){
        const area = document.getElementById('area');
        const lastErr = [...area.querySelectorAll('.bubble.err, .err')].pop();
        if(lastErr) lastErr.remove();
      }
      function waitP(ms){ return new Promise(r=>setTimeout(r, ms)); }
    }

    // ===== ×©×œ×‘ 1: ××§×¦×•×¢ (×¢× ×¤× ×™×™×” ××™×©×™×ª ×‘×©× ×¤×¨×˜×™) =====
    function stepSubject(){
      Chat.clear(); Chat.push(stepSubject);

      const name = Chat.State.data.firstName ? ` ${Chat.State.data.firstName}` : '';
      Chat.typingThen(
        `<strong>××¢×•×œ×”${name}! ××©××— ×œ×¢×–×•×¨ ×œ×ª×× ×©×™×¢×•×¨ ×—×“ ×¤×¢××™, ×¢×œ ×‘×¡×™×¡ ××§×•× ×¤× ×•×™ ğŸ‘¨â€ğŸš€</strong><br>` +
        `<strong>××™×–×” ××§×¦×•×¢ ×ª×¨×¦×•?</strong> ğŸ“–`,
        650, true
      );

      setTimeout(()=>{
        const fromCfg = (Chat.cfg.SUBJECTS || []).map(s => s === '×× ×’×œ×™×ª ××“×•×‘×¨×ª' ? '×× ×’×œ×™×ª ××“×•×‘×¨×ª ×œ×§×˜× ×˜× ×™×' : s);
        if (!fromCfg.includes('×‘×™×•×œ×•×’×™×”')) fromCfg.push('×‘×™×•×œ×•×’×™×”');

        fromCfg.forEach(s => Chat.button(s, ()=>{
          Chat.userBubble(s);
          Chat.State.data.subject = s;
          stepGrade();
        }));

        const s = document.createElement('div'); s.className='summary';
        s.appendChild(Chat.chip('×©×™×¢×•×¨ ×—×“Ö¾×¤×¢××™'));
        document.getElementById('area').appendChild(s);
      }, 900);
    }

    // ===== ×©×œ×‘ 2: ×›×™×ª×” (×œ×œ× ×”×–×›×¨×ª ×©×) =====
    function stepGrade(){
      Chat.clear(); Chat.push(stepGrade);

      Chat.typingThen(`<strong>×‘××™×–×• ×›×™×ª×”?</strong> ğŸ‘¨â€ğŸš€`, 600, true);

      setTimeout(()=>{
        const grades = ['×','×‘','×’','×“','×”','×•','×–','×—','×˜','×™','×™×','×™×‘','×—×™× ×•×š ×‘×™×ª×™','×¡×˜×•×“× ×˜/×™×ª','××—×¨'];
        const gradeSelect = selectRow('×›×™×ª×”', grades, 'grade');

        const btnNext = Chat.button('×”××©×š', ()=>{
          Chat.userBubble('×”××©×š');

          const g = gradeSelect.value;
          if(!g){
            Chat.botText('× ×“×¨×© ×œ×‘×—×•×¨ ×›×™×ª×” âœï¸').classList.add('err');
            gradeSelect.focus(); return;
          }
          Chat.State.data.grade = g;
          if (['×™','×™×','×™×‘'].includes(g)) { stepUnits(); }
          else { stepPlan(); }
        }, 'btn primary');

        gradeSelect.addEventListener('change', ()=>{
          removeLastErr();
          btnNext.disabled = false;
        });

        function removeLastErr(){
          const area = document.getElementById('area');
          const lastErr = [...area.querySelectorAll('.err')].pop();
          if(lastErr) lastErr.remove();
        }
      }, 800);
    }

    // ===== ×©×œ×‘ 2b: ×™×—×™×“×•×ª (×œ×ª×™×›×•×Ÿ) =====
    function stepUnits(){
      Chat.clear(); Chat.push(stepUnits);

      Chat.typingThen('<strong>×›××” ×™×—×™×“×•×ª ×‘×’×¨×•×ª?</strong> ğŸ‘¨â€ğŸš€', 600, true);

      setTimeout(()=>{
        ['3','4','5'].forEach(u => Chat.button(`${u} ×™×—×™×“×•×ª`, ()=>{
          Chat.userBubble(`${u} ×™×—×™×“×•×ª`);
          Chat.State.data.units = u;
          stepPlan();
        }));

        const s = document.createElement('div'); s.className='summary';
        s.appendChild(Chat.chip(`×›×™×ª×”: ${Chat.State.data.grade}`));
        if (Chat.State.data.subject) s.appendChild(Chat.chip(`××§×¦×•×¢: ${Chat.State.data.subject}`));
        document.getElementById('area').appendChild(s);
      }, 700);
    }

    // ===== ×©×œ×‘ 3: ××¡×œ×•×œ =====
    function stepPlan(){
      Chat.clear(); Chat.push(stepPlan);

      const P = Chat.cfg.PRICES, H = Chat.cfg.PLAN_HE;
      Chat.typingThen('<strong>×‘×—×™×¨×ª ××¡×œ×•×œ</strong><br><span class="muted">× × ×œ×‘×—×•×¨ ××¡×œ×•×œ ××ª××™×:</span> ğŸ‘¨â€ğŸš€', 600, true);

      setTimeout(()=>{
        const isMath = (Chat.State.data.subject || '').trim() === '××ª××˜×™×§×”';
        const isHighGrade = ['×™×','×™×‘'].includes(Chat.State.data.grade);
        const isFiveUnits = (Chat.State.data.units || '') === '5';
        const allowGroup = !(isMath && isHighGrade && isFiveUnits);

        if (allowGroup){
          Chat.button(`×§×‘×•×¦×” â€“ ×¢×“ 5 ×ª×œ××™×“×™× â€“ ${P.group}â‚ª`, ()=>{
            Chat.userBubble(`×§×‘×•×¦×” â€“ ×¢×“ 5 ×ª×œ××™×“×™× â€“ ${P.group}â‚ª`);
            Chat.State.data.planType='group';
            Chat.State.data.price=P.group;
            stepAvailability();
          }, 'btn primary');
        }

        Chat.button(`×˜×¨×™×¤×œ â€“ ×¢×“ 3 ×ª×œ××™×“×™× â€“ ${P.triple}â‚ª`, ()=>{
          Chat.userBubble(`×˜×¨×™×¤×œ â€“ ×¢×“ 3 ×ª×œ××™×“×™× â€“ ${P.triple}â‚ª`);
          Chat.State.data.planType='triple';
          Chat.State.data.price=P.triple;
          stepAvailability();
        });

        Chat.button(`×¤×¨×˜×™ â€“ ${P.private}â‚ª`, ()=>{
          Chat.userBubble(`×¤×¨×˜×™ â€“ ${P.private}â‚ª`);
          Chat.State.data.planType='private';
          Chat.State.data.price=P.private;
          stepAvailability();
        });

        const s = document.createElement('div'); s.className='summary';
        if (Chat.State.data.subject) s.appendChild(Chat.chip(`××§×¦×•×¢: ${Chat.State.data.subject}`));
        if (Chat.State.data.grade)   s.appendChild(Chat.chip(`×›×™×ª×”: ${Chat.State.data.grade}${Chat.State.data.units?` â€¢ ${Chat.State.data.units} ×™×—×™×“×•×ª`:''}`));
        document.getElementById('area').appendChild(s);
      }, 800);
    }

    // ===== ×©×œ×‘ 4: ×‘×—×™×¨×ª ×–××™× ×•×ª (×›×¤×ª×•×¨ ×”×”××©×š ×‘×ª×—×ª×™×ª + âœ–ï¸ ×œ×”×¡×¨×”) =====
    function stepAvailability(){
      Chat.clear(); Chat.push(stepAvailability);

      const name = Chat.State.data.firstName ? `, ${Chat.State.data.firstName}` : '';
      Chat.typingThen(
        '<strong>×©×¢×•×ª ×¤×ª×™×—×”</strong><br>' +
        '<span class="muted">×× ×—× ×• ×¤×ª×•×—×™× ×‘×™××™× ××³â€“×”×³ ×‘×™×Ÿ 14:00â€“21:00.</span><br><br>' +
        `<strong>×‘×—×™×¨×ª ×™××™× ×•×©×¢×•×ª ××•×¢×“×¤×™×${name}</strong> ğŸ‘¨â€ğŸš€`,
        650, true
      );

      setTimeout(()=>{
        const area = document.getElementById('area');

        const pickerWrap = document.createElement('div');
        pickerWrap.className = 'bubble bot wide';

        const grid = document.createElement('div');
        grid.className = 'slots-grid';

        const rowsWrap = document.createElement('div');
        rowsWrap.id = 'rowsWrap';
        rowsWrap.className = 'slots-grid';

        const preview = document.createElement('div');
        preview.className = 'slot-preview';

        function toNum(s){ return parseInt(String(s||'').replace(':',''),10) || 0; }
        const TIMES = ['','14:00','15:00','16:00','17:00','18:00','19:00','20:00'];
        const DAYS  = ['','×','×‘','×’','×“','×”'];

        function makeSelect(placeholder, values){
          const sel = document.createElement('select');
          sel.className = 'input';
          values.forEach(v=>{
            const o = document.createElement('option');
            o.value = v;
            o.textContent = v ? (placeholder ? `${placeholder} ${v}` : v) : placeholder || '×‘×—×¨/×™...';
            sel.appendChild(o);
          });
          return sel;
        }

        function lastRowFilled(){
          const rows = Array.from(rowsWrap.children);
          if (!rows.length) return false;
          const last = rows[rows.length - 1];
          const [dSel, fSel, tSel] = last.querySelectorAll('select');
          const d = dSel.value, f = fSel.value, t = tSel.value;
          if(!(d && f && t)) return false;
          return toNum(f) < toNum(t);
        }

        function refreshPreview(){
          preview.innerHTML = '';
          const rows = Array.from(rowsWrap.children);
          const chosen = [];
          for(const r of rows){
            const [dSel, fSel, tSel] = r.querySelectorAll('select');
            const d = dSel.value, f = fSel.value, t = tSel.value;
            if(d && f && t && toNum(f) < toNum(t)){
              chosen.push({d,f,t,row:r});
            }
          }
          chosen.forEach(c => {
            // ×¦'×™×¤ ×¢× âœ– ×œ×”×¡×¨×”
            const chip = Chat.chip(`×™×•× ${c.d} ${c.f}â€“${c.t}`);
            chip.classList.add('emph');
            const x = document.createElement('button');
            x.type='button'; x.className='x'; x.title='×”×¡×¨ ××•×¢×“'; x.setAttribute('aria-label','×”×¡×¨ ××•×¢×“');
            x.textContent='âœ–';
            x.addEventListener('click', ()=>{
              // ×”×¡×¨×”: ××•×—×§×™× ××ª ×”×©×•×¨×” ×”×ª×•×××ª, ××¨×¢× × ×™× ×ª×¦×•×’×”
              c.row.remove();
              addBtn.disabled = !lastRowFilled();
              refreshPreview();
            });
            chip.appendChild(x);
            preview.appendChild(chip);
          });
        }

        function wireRow(row, btnContinueRef){
          const inputs = row.querySelectorAll('select');
          inputs.forEach(sel=>{
            sel.addEventListener('change', ()=>{
              const [dSel, fSel, tSel] = row.querySelectorAll('select');
              const f = fSel.value, t = tSel.value;

              const errPrev = row.querySelector('.row-error');
              if (errPrev) errPrev.remove();

              if (f && t && toNum(f) >= toNum(t)){
                const err = document.createElement('div');
                err.className = 'row-error';
                err.textContent = '×´×¢×“ ×©×¢×”×´ ×—×™×™×‘ ×œ×”×™×•×ª ××—×¨×™ ×´××©×¢×”×´';
                row.appendChild(err);
              }

              addBtn.disabled = !lastRowFilled();
              btnContinueRef.disabled = false; // ×—×•×–×¨ ×œ×¤×¢×™×œ ××—×¨×™ ×ª×™×§×•×Ÿ
              refreshPreview();
            });
          });
        }

        function addRow(force=false, btnContinueRef){
          if (!force && !lastRowFilled()){
            Chat.botText('× ×™×ª×Ÿ ×œ×”×•×¡×™×£ ××•×¢×“ × ×•×¡×£ ×¨×§ ×œ××—×¨ ×©××™×œ××ª ××ª ×”××•×¢×“ ×”×§×•×“×.').classList.add('err');
            return;
          }
          const row = document.createElement('div');
          row.className = 'slot-row';

          const daySel  = makeSelect('×‘×—×¨/×™ ×™×•×', DAYS);
          const fromSel = makeSelect('××©×¢×”', TIMES);
          const toSel   = makeSelect('×¢×“ ×©×¢×”', TIMES);

          row.append(daySel, fromSel, toSel);
          rowsWrap.appendChild(row);
          wireRow(row, btnContinue);
          addBtn.disabled = true;
          refreshPreview();
          area.scrollTop = area.scrollHeight;
          return row;
        }

        const title = document.createElement('div');
        title.className='muted';
        title.textContent = '× ×™×ª×Ÿ ×œ×”×•×¡×™×£ ×™×•×ª×¨ ×××•×¢×“ ××—×“';

        const addBtn = document.createElement('button');
        addBtn.className='btn';
        addBtn.textContent = '+ ×”×•×¡×¤×ª ××•×¢×“ × ×•×¡×£';
        addBtn.disabled = true;

        // ×¤×¢×•×œ×•×ª ×‘×ª×—×ª×™×ª (×›××Ÿ ×™××•×§× "×”××©×š")
        const actions = document.createElement('div');
        actions.className = 'slots-actions';

        // ×›×¤×ª×•×¨ ×”××©×š ×‘×ª×—×ª×™×ª
        const btnContinue = document.createElement('button');
        btnContinue.className = 'btn primary';
        btnContinue.textContent = '×”××©×š';
        btnContinue.addEventListener('click', ()=>{
          Chat.userBubble('×”××©×š');

          const rows = Array.from(rowsWrap.children);
          const chosen = [];
          for(const r of rows){
            const [daySel, fromSel, toSel] = r.querySelectorAll('select');
            const d = daySel.value, f = fromSel.value, t = toSel.value;
            if(d && f && t){
              if (toNum(f) >= toNum(t)){
                Chat.botText(`×‘××•×¢×“ ×™×•× ${d}: "×¢×“ ×©×¢×”" ×—×™×™×‘ ×œ×”×™×•×ª ××—×¨×™ "××©×¢×”" â±ï¸`).classList.add('err');
                return;
              }
              chosen.push(`×™×•× ${d} ${f}â€“${t}`);
            }
          }
          if (!chosen.length){
            Chat.botText('× ×“×¨×© ×œ×‘×—×•×¨ ×œ×¤×—×•×ª ××•×¢×“ ××—×“ ğŸ•’').classList.add('err');
            return;
          }
          Chat.State.data.availability = chosen.join('; ');
          stepNotes();
        });

        addBtn.onclick = ()=> addRow(false, btnContinue);

        grid.append(title, rowsWrap, addBtn, preview);
        pickerWrap.appendChild(grid);

        // ×›×¤×ª×•×¨ ×”×”××©×š ×‘×ª×—×ª×™×ª ×”-bubble ×”×¨×—×‘
        actions.appendChild(btnContinue);
        pickerWrap.appendChild(actions);

        area.appendChild(pickerWrap);

        // ×©×•×¨×” ×¨××©×•× ×” ×—×•×‘×”
        addRow(true, btnContinue);
      }, 900);
    }

    // ===== ×©×œ×‘ 5: ×”×¢×¨×•×ª (××•×¤×¦×™×•× ×œ×™) =====
    function stepNotes(){
      Chat.clear(); Chat.push(stepNotes);

      const name = Chat.State.data.firstName ? `, ${Chat.State.data.firstName}` : '';
      Chat.typingThen(
        `<strong>×”×¢×¨×•×ª ×œ××–×›×™×¨×•×ª</strong><br><span class="muted">××¤×©×¨ ×œ×¦×™×™×Ÿ ×”×¢×“×¤×” ×œ××•×¨×”, ×¨××”, ××• ×‘×§×©×” ××™×•×—×“×ª (×œ× ×—×•×‘×”)${name}</span> ğŸ‘¨â€ğŸš€`,
        600, true
      );

      setTimeout(()=>{
        const message = Chat.inputRow('×”×¢×¨×•×ª (×œ× ×—×•×‘×”)', {
          textarea:true, id:'message', placeholder:'×œ×“×•×’××”: ×¨×¢× ×•×Ÿ ×œ×§×¨××ª ××‘×—×Ÿ / ×”×¢×“×¤×” ×œ×©×¢×ª ×¢×¨×‘'
        });

        const btnNext = Chat.button('×”××©×š', ()=>{
          Chat.userBubble('×”××©×š');
          Chat.State.data.message = (message.value||'').trim();
          stepReview();
        }, 'btn primary');

        message.addEventListener('input', ()=>{ btnNext.disabled = false; });
      }, 800);
    }

    // ===== ×©×œ×‘ 6: ×¡×™×›×•× ×•×©×œ×™×—×” =====
    function stepReview(){
      Chat.clear(); Chat.push(stepReview);

      const h = Chat.botHTML('<strong>×¡×™×›×•× ×”×‘×§×©×”</strong><br><span class="muted">× × ×œ×•×•×“× ×©×”×›×•×œ × ×›×•×Ÿ ×œ×¤× ×™ ×©×œ×™×—×”.</span> ğŸ‘¨â€ğŸš€');
      Chat.scrollStartOf(h);

      const card = document.createElement('div'); card.className='bubble bot';

      const chips = document.createElement('div'); chips.className='summary';
      if (Chat.State.data.subject)   chips.appendChild(Chat.chip(`××§×¦×•×¢: ${Chat.State.data.subject}`));
      if (Chat.State.data.grade)     chips.appendChild(Chat.chip(`×›×™×ª×”: ${Chat.State.data.grade}${Chat.State.data.units?` â€¢ ${Chat.State.data.units} ×™×—×™×“×•×ª`:''}`));
      if (Chat.State.data.planType)  chips.appendChild(Chat.chip(`××¡×œ×•×œ: ${Chat.cfg.PLAN_HE[Chat.State.data.planType]} (${Chat.State.data.price}â‚ª)`));
      card.appendChild(chips);

      const d = Chat.State.data;
      const details = document.createElement('div'); details.style.lineHeight='1.9';
      const addLine = (label, value)=>{
        const line=document.createElement('div');
        const b=document.createElement('strong'); b.textContent=label+' ';
        const span=document.createElement('span'); span.textContent=value;
        line.append(b, span); details.appendChild(line);
      };
      addLine('×©×:', `${d.firstName||''}`);
      addLine('×©× ××©×¤×—×”:', `${d.lastName||''}`);
      addLine('××§×¦×•×¢:', `${d.subject||''}`);
      addLine('×›×™×ª×”:', `${d.grade||''}${d.units?` â€¢ ${d.units} ×™×—×™×“×•×ª`:''}`);
      addLine('××¡×œ×•×œ:', `${(Chat.cfg.PLAN_HE[d.planType]||'')}${d.price?` â€“ ${d.price}â‚ª`:''}`);
      addLine('×™××™× ×•×©×¢×•×ª ××•×¢×“×¤×™×:', d.availability||'');
      if (d.message) addLine('×”×¢×¨×•×ª ×œ××–×›×™×¨×•×ª:', d.message);
      addLine('×˜×œ×¤×•×Ÿ ×œ×—×–×¨×”:', d.phone||'');

      card.appendChild(details);
      document.getElementById('area').appendChild(card);
      (function(){ const a=document.getElementById('area'); a.scrollTop=a.scrollHeight; })();

      Chat.button('××™×©×•×¨ ×•×©×œ×™×—×” ×œ××–×›×™×¨×•×ª ğŸ“¤', async ()=>{
        const stopProcessing = Chat.showProcessing();

        const fullName = `${Chat.State.data.firstName||''} ${Chat.State.data.lastName||''}`.trim();

        const ok = await Chat.sendLeadToSheet({
          path: '×©×™×¢×•×¨ ×¢×œ ×‘×¡×™×¡ ××§×•× ×¤× ×•×™',
          planType: Chat.cfg.PLAN_HE[Chat.State.data.planType],
          price: `${Chat.State.data.price}â‚ª`,
          subject: Chat.State.data.subject,
          grade: Chat.State.data.grade,
          units: Chat.State.data.units || '',
          availability: Chat.State.data.availability,
          message: Chat.State.data.message || '',
          extraNotes: '',
          fullName,
          firstName: Chat.State.data.firstName,
          lastName:  Chat.State.data.lastName,
          phone: Chat.State.data.phone,
          cta: '×©×™×¢×•×¨ ×—×“Ö¾×¤×¢××™',
          source: '×™×•×¡×˜×•×Ÿ â€“ ××ª×¨',
          status: '×œ×˜×™×¤×•×œ',
          createdAt: new Date().toISOString()
        });

        stopProcessing();
        Chat.clear();

        if(ok){
          Chat.botText('×”××™×“×¢ × ×©×œ×— ×œ××–×›×™×¨×•×ª âœ… × ×™×¦×•×¨ ×§×©×¨ ×‘×”×§×“× ×‘×•×•××˜×¡××¤ ×œ×ª×™××•× ×©×™×¢×•×¨ ×¢×œ ×‘×¡×™×¡ ××§×•× ×¤× ×•×™ ğŸ‘¨â€ğŸš€').classList.add('ok');
        }else{
          Chat.botText('×œ× ×”×¦×œ×—× ×• ×œ×©××•×¨ ××ª ×”×‘×§×©×” ×œ×’×™×œ×™×•×Ÿ âŒ × ×™×ª×Ÿ ×œ× ×¡×•×ª ×©×•×‘ ××• ×œ×¤× ×•×ª ×‘×•×•××˜×¡××¤ 050â€‘9570866.').classList.add('err');
        }
        const home = Chat.button('×—×–×¨×” ×œ×ª×¤×¨×™×˜ ×”×¨××©×™', ()=> location.href='../index.html', 'btn');
        home.focus();
      }, 'btn primary');
    }

    // ×”×¤×¢×œ×”
    start();
  </script>
</body>
</html>