<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>×©×™×¢×•×¨ ×—×“ ×¤×¢××™ ×¢×œ ×‘×¡×™×¡ ××§×•× ×¤× ×•×™</title>

  <!-- ×©×™× ×œ×‘: branch1.html × ××¦× ×‘-branches/, ××– ×§×•×‘×¥ ×”-CSS ×‘×©×•×¨×© = ../ -->
  <link rel="stylesheet" href="../styles.light.css?v=1" />
  <meta name="theme-color" content="#5b7cfa" />

  <style>
    :root{
      --radius:16px;
      --gap:14px;
      --card-bg: rgba(255,255,255,0.75);
      --card-brd:#e6eaf3;
      --shadow: 0 8px 24px rgba(15,23,42,0.08);
      --shadow-hover: 0 12px 36px rgba(15,23,42,0.12);
      --text: #0f172a;
      --muted:#6b7280;
      --soft-1:#eef6ff; --soft-1-b:#cfe3ff;
      --soft-2:#ecfdf5; --soft-2-b:#c7f2e1;
      --soft-3:#fff1f2; --soft-3-b:#ffd7dc;
      --soft-4:#f5f3ff; --soft-4-b:#e3ddff;
      --gradient: radial-gradient(900px 520px at 100% -10%, #8ea5ff33, transparent 60%),
                  radial-gradient(700px 460px at 0% 100%, #8bffd933, transparent 60%);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --card-bg: rgba(18,22,33,0.6);
        --card-brd:#2a3142;
        --shadow: 0 6px 18px rgba(0,0,0,0.35);
        --shadow-hover: 0 10px 28px rgba(0,0,0,0.45);
        --text:#e5e7eb; --muted:#9ca3af;
        --soft-1:#0b2447; --soft-1-b:#1b3a6c;
        --soft-2:#0f2f27; --soft-2-b:#174538;
        --soft-3:#3a1820; --soft-3-b:#5b2230;
        --soft-4:#241a3d; --soft-4-b:#3a2b61;
      }
    }

    body{
      font-family:'Rubik', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        linear-gradient(180deg, #f8fafc 0%, #f4f7ff 60%, #f9fafb 100%),
        var(--gradient);
      background-attachment: fixed;
    }
    @media (prefers-color-scheme: dark){
      body{ background:
        linear-gradient(180deg, #0b1220 0%, #0e1424 60%, #0b1220 100%),
        var(--gradient);
      }
    }

    .wrap{ padding: clamp(12px, 2.5vw, 24px) }
    .card{
      border:1px solid var(--card-brd);
      border-radius: clamp(16px, 2vw, 22px);
      box-shadow: var(--shadow);
      backdrop-filter: saturate(140%) blur(8px);
      background: var(--card-bg);
      overflow:hidden;
      max-width: 980px;
      margin: 0 auto;
    }

    .topbar{
      padding: clamp(10px, 1.8vw, 14px);
      border-bottom:1px solid var(--card-brd);
      display:flex; gap:8px; align-items:center;
      background: linear-gradient(180deg, transparent, rgba(0,0,0,0.02));
    }

    .head{
      padding: clamp(16px, 2.4vw, 24px);
      border-bottom:1px solid var(--card-brd);
      display:flex; align-items:center; justify-content:space-between; gap:8px;
    }
    .brand{ display:flex; align-items:center; gap:12px }
    .logo{
      width:40px; height:40px; border-radius:12px;
      display:grid; place-items:center; font-weight:700;
      background: linear-gradient(135deg,#5b7cfa, #6be6b3);
      color:white; box-shadow: 0 6px 16px rgba(91,124,250,0.35);
    }
    .title{ font-weight:700; letter-spacing:0.2px }

    .body.chat-body{ padding: clamp(14px, 2.2vw, 20px); min-height: 40vh }
    #area{ overflow-y:auto; max-height:70vh; scroll-behavior:smooth }

    /* × ×™×˜×¨×•×œ ×¢×“×™×¤×•×ª ×¦×‘×¢×•× ×™×ª */
    .btn.primary {
      background: var(--btn-bg, #f3f4f6) !important;
      color: var(--btn-fg, #111827) !important;
      border-color: var(--btn-border, #e5e7eb) !important;
    }
    .btn.next-arrow::after{ content:""; }
    @media (prefers-reduced-motion: reduce){
      .btn{ transition:none }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <!-- ×˜×•×¤Ö¾×‘×¨ -->
      <div class="topbar">
        <button class="btn" onclick="location.href='../index.html'">×œ×ª×¤×¨×™×˜ ×¨××©×™</button>
      </div>

      <!-- ×›×•×ª×¨×ª -->
      <div class="head">
        <div class="brand">
          <div class="logo">HB</div>
          <div class="title">×©×™×¢×•×¨ ×—×“ ×¤×¢××™ ×¢×œ ×‘×¡×™×¡ ××§×•× ×¤× ×•×™</div>
        </div>
      </div>

      <!-- ××–×•×¨ ×”×ª×•×›×Ÿ -->
      <div class="body chat-body" id="area" role="log" aria-live="polite" aria-atomic="false"></div>

      <!-- ×ª×—×ª×™×ª -->
      <div class="footer">
        <button id="backBtn" class="btn" disabled>×—×–×¨×”</button>
        <!-- faq ×‘×©×•×¨×© => ../ -->
        <a id="faqBtn" class="btn ghost" href="../faq.html" target="_blank" rel="noopener">×™×© ×œ×™ ×©××œ×•×ª</a>
        <span class="spacer"></span>
      </div>
    </div>
  </div>

  <!-- ×§×‘×¦×™× ××©×•×ª×¤×™×:
       ×›××Ÿ branch1.html ×™×•×©×‘ ×‘-branches/, ×•×”â€‘helpers ×‘-branches/js => ×”× ×ª×™×‘ ×”×•× ./js/... -->
  <script src="./js/config.js?v=3"></script>
  <script src="./js/chat-helpers.js?v=3"></script>

  <script>
    /* ===== ×§×•× ×˜×§×¡×˜ ×œ-FAQ ===== */
    (function setHelpContext(ctx){
      const btn = document.getElementById('faqBtn');
      if(!btn) return;
      const base = '../faq.html';
      btn.href = ctx ? `${base}?ctx=${encodeURIComponent(ctx)}` : base;
    })('branch1-oneoff');

    /* ===== × ×™×•×•×˜ ××—×•×¨×” ×“×¨×š ×”×”×™×¡×˜×•×¨×™×” ×©×œ ×”-Chat ===== */
    const backBtn = document.getElementById('backBtn');
    if (backBtn) backBtn.onclick = ()=> Chat.goBack?.();

    /* ===== ×¢×–×¨ ×œ-select (×× ×¦×¨×™×š ×‘×ª×•×š ×”×©×œ×‘×™×) ===== */
    function selectRow(label, options, id){
      const wrap = document.createElement('div');
      wrap.className = 'input-wrap bubble bot';
      const l = document.createElement('label');
      l.textContent = label;
      if(id) l.htmlFor = id;

      const sel = document.createElement('select');
      sel.id = id;
      sel.className = 'input';
      sel.style.direction = 'rtl';

      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = '×‘×—×¨/×™...';
      sel.appendChild(opt0);

      options.forEach(v=>{
        const o=document.createElement('option');
        o.value=v; o.textContent=v;
        sel.appendChild(o);
      });

      wrap.append(l, sel);
      document.getElementById('area').appendChild(wrap);
      const a=document.getElementById('area'); a.scrollTop = a.scrollHeight;
      return sel;
    }

    /* ===== ×”×ª×—×œ×” ===== */
    function start(){
      Chat.clear(); Chat.push(start);
      stepContactFirst();
    }

    /* ===== ×©×œ×‘ 0: ×¤×¨×˜×™ ×§×©×¨ (××©×ª××©×™× ×‘-askContact ×”××—×™×“ ×›×“×™ ×œ×©××•×¨ ×©×¤×” ××—×™×“×” ×¢× ×”×¢× ×£ ×”×—×“×©) ===== */
    function stepContactFirst(){
      Chat.clear(); Chat.push(stepContactFirst);

      Chat.askContact({
        titleHtml: '<strong>×›×“×™ ×©× ×ª×× ×©×™×¢×•×¨ ×¢×œ ×‘×¡×™×¡ ××§×•× ×¤× ×•×™</strong><br><span class="muted">× ×©××•×¨ ×©× ×¤×¨×˜×™, ××©×¤×—×” ×•×˜×œ×¤×•×Ÿ ×œ×—×–×¨×”</span> ğŸ‘¨â€ğŸš€',
        nextText: '×”××©×š',
        requireLast: true,
        showBack: false
      }).then(contact=>{
        if(!contact) return;
        Chat.State.data.firstName = contact.firstName;
        Chat.State.data.lastName  = contact.lastName;
        Chat.State.data.phone     = contact.phone;
        stepSubject();
      });
    }

    /* ===== ×©×œ×‘ 1: ××§×¦×•×¢ ===== */
    function stepSubject(){
      setHelpCtx('subject');
      Chat.clear(); Chat.push(stepSubject);

      const name = Chat.State.data.firstName ? ` ${Chat.State.data.firstName}` : '';
      Chat.typingThen(
        `<strong>××¢×•×œ×”${name}! × ×ª×§×“× ×œ×ª×× ×©×™×¢×•×¨ ×—×“Ö¾×¤×¢××™ ×¢×œ ×‘×¡×™×¡ ××§×•× ×¤× ×•×™ ğŸ‘¨â€ğŸš€</strong><br><strong>××™×–×” ××§×¦×•×¢ ×ª×¨×¦×•?</strong> ğŸ“–`,
        600, true
      );

      setTimeout(()=>{
        const fromCfg = (Chat.cfg.SUBJECTS || []).map(s => s === '×× ×’×œ×™×ª ××“×•×‘×¨×ª' ? '×× ×’×œ×™×ª ××“×•×‘×¨×ª ×œ×§×˜× ×˜× ×™×' : s);
        if (!fromCfg.includes('×‘×™×•×œ×•×’×™×”')) fromCfg.push('×‘×™×•×œ×•×’×™×”');

        fromCfg.forEach(s => Chat.button(s, ()=>{
          Chat.userBubble(s);
          Chat.State.data.subject = s;
          stepGrade();
        }));

        const s = document.createElement('div'); s.className='summary';
        s.appendChild(Chat.chip('×©×™×¢×•×¨ ×—×“Ö¾×¤×¢××™'));
        document.getElementById('area').appendChild(s);
      }, 800);
    }

    /* ===== ×©×œ×‘ 2: ×›×™×ª×” ===== */
    function stepGrade(){
      setHelpCtx('grade');
      Chat.clear(); Chat.push(stepGrade);

      Chat.typingThen(`<strong>×‘××™×–×• ×›×™×ª×”?</strong> ğŸ‘¨â€ğŸš€`, 550, true);

      setTimeout(()=>{
        const grades = ['×','×‘','×’','×“','×”','×•','×–','×—','×˜','×™','×™×','×™×‘','×—×™× ×•×š ×‘×™×ª×™','×¡×˜×•×“× ×˜/×™×ª','××—×¨'];
        const gradeSelect = selectRow('×›×™×ª×”', grades, 'grade');

        const btnNext = Chat.button('×”××©×š', ()=>{
          Chat.userBubble('×”××©×š');

          const g = gradeSelect.value;
          if(!g){
            Chat.inlineError('× ×“×¨×© ×œ×‘×—×•×¨ ×›×™×ª×” âœï¸', gradeSelect);
            return;
          }
          Chat.State.data.grade = g;
          if (['×™','×™×','×™×‘'].includes(g)) { stepUnits(); }
          else { stepPlan(); }
        }, 'btn');

        gradeSelect.addEventListener('change', ()=>{ btnNext.disabled = false; });
      }, 700);
    }

    /* ===== ×©×œ×‘ 2b: ×™×—×™×“×•×ª ===== */
    function stepUnits(){
      setHelpCtx('units');
      Chat.clear(); Chat.push(stepUnits);

      Chat.typingThen('<strong>×›××” ×™×—×™×“×•×ª ×‘×’×¨×•×ª?</strong> ğŸ‘¨â€ğŸš€', 550, true);

      setTimeout(()=>{
        ['3','4','5'].forEach(u => Chat.button(`${u} ×™×—×™×“×•×ª`, ()=>{
          Chat.userBubble(`${u} ×™×—×™×“×•×ª`);
          Chat.State.data.units = u;
          stepPlan();
        }));

        const s = document.createElement('div'); s.className='summary';
        s.appendChild(Chat.chip(`×›×™×ª×”: ${Chat.State.data.grade}`));
        if (Chat.State.data.subject) s.appendChild(Chat.chip(`××§×¦×•×¢: ${Chat.State.data.subject}`));
        document.getElementById('area').appendChild(s);
      }, 650);
    }

    /* ===== ×©×œ×‘ 3: ××¡×œ×•×œ ===== */
    function stepPlan(){
      setHelpCtx('plan');
      Chat.clear(); Chat.push(stepPlan);

      const P = Chat.cfg.PRICES, H = Chat.cfg.PLAN_HE;
      Chat.typingThen('<strong>×‘×—×™×¨×ª ××¡×œ×•×œ</strong><br><span class="muted">× × ×œ×‘×—×•×¨ ××¡×œ×•×œ ××ª××™×:</span> ğŸ‘¨â€ğŸš€', 600, true);

      setTimeout(()=>{
        const isMath       = (Chat.State.data.subject || '').trim() === '××ª××˜×™×§×”';
        const isHighGrade  = ['×™×','×™×‘'].includes(Chat.State.data.grade);
        const isFiveUnits  = (Chat.State.data.units || '') === '5';
        const allowGroup   = !(isMath && isHighGrade && isFiveUnits);

        if (allowGroup){
          Chat.button(`×§×‘×•×¦×” â€“ ×¢×“ 5 ×ª×œ××™×“×™× â€“ ${P.group}â‚ª`, ()=>{
            Chat.userBubble(`×§×‘×•×¦×” â€“ ×¢×“ 5 ×ª×œ××™×“×™× â€“ ${P.group}â‚ª`);
            Chat.State.data.planType='group';
            Chat.State.data.price=P.group;
            stepAvailability();
          }, 'btn');
        }

        Chat.button(`×˜×¨×™×¤×œ â€“ ×¢×“ 3 ×ª×œ××™×“×™× â€“ ${P.triple}â‚ª`, ()=>{
          Chat.userBubble(`×˜×¨×™×¤×œ â€“ ×¢×“ 3 ×ª×œ××™×“×™× â€“ ${P.triple}â‚ª`);
          Chat.State.data.planType='triple';
          Chat.State.data.price=P.triple;
          stepAvailability();
        }, 'btn');

        Chat.button(`×¤×¨×˜×™ â€“ ${P.private}â‚ª`, ()=>{
          Chat.userBubble(`×¤×¨×˜×™ â€“ ${P.private}â‚ª`);
          Chat.State.data.planType='private';
          Chat.State.data.price=P.private;
          stepAvailability();
        }, 'btn');

        const s = document.createElement('div'); s.className='summary';
        if (Chat.State.data.subject) s.appendChild(Chat.chip(`××§×¦×•×¢: ${Chat.State.data.subject}`));
        if (Chat.State.data.grade)   s.appendChild(Chat.chip(`×›×™×ª×”: ${Chat.State.data.grade}${Chat.State.data.units?` â€¢ ${Chat.State.data.units} ×™×—×™×“×•×ª`:''}`));
        document.getElementById('area').appendChild(s);
      }, 700);
    }

    /* ===== ×©×œ×‘ 4: ×–××™× ×•×ª â€“ ×‘×•×¨×¨ ×©×•×¨×” ××—×ª + ×¦×³×™×¤×™× (×-helpers) ===== */
    function stepAvailability(){
      setHelpCtx('availability');
      Chat.clear(); Chat.push(stepAvailability);

      const name = Chat.State.data.firstName ? `, ${Chat.State.data.firstName}` : '';
      Chat.typingThen(
        '<strong>×©×¢×•×ª ×¤×ª×™×—×”</strong><br>' +
        '<span class="muted">×× ×—× ×• ×¤×ª×•×—×™× ×‘×™××™× ××³â€“×”×³ ×‘×™×Ÿ 14:00â€“21:00.</span><br><br>' +
        `<strong>×‘×—×™×¨×ª ×™××™× ×•×©×¢×•×ª ××•×¢×“×¤×™×${name}</strong> ğŸ‘¨â€ğŸš€`,
        600, true
      );

      setTimeout(async ()=>{
        const chosen = await Chat.pickAvailability({
          tipText: '×‘×—×¨×• ×›××” ×©×™×•×ª×¨ ××¤×©×¨×•×™×•×ª ×©× ×•×—×•×ª ×œ×›×',
          continueText: '×”××©×š',
          allowBack: true
        });
        if(!chosen) return;
        Chat.State.data.availability = chosen.join('; ');
        stepNotes();
      }, 650);
    }

    /* ===== ×©×œ×‘ 5: ×”×¢×¨×•×ª ×—×•×¤×©×™×•×ª (××¤×©×¨ ×¨×™×§) ===== */
    function stepNotes(){
      setHelpCtx('notes');
      Chat.clear(); Chat.push(stepNotes);

      const name = Chat.State.data.firstName ? `, ${Chat.State.data.firstName}` : '';
      Chat.typingThen(`<strong>×”×¢×¨×•×ª ×œ××–×›×™×¨×•×ª</strong><br><span class="muted">××¤×©×¨ ×œ×¦×™×™×Ÿ ×”×¢×“×¤×” ×œ××•×¨×”, ×¨××”, ××• ×‘×§×©×” ××™×•×—×“×ª (×œ× ×—×•×‘×”)${name}</span> ğŸ‘¨â€ğŸš€`, 550, true);

      setTimeout(()=>{
        const message = Chat.inputRow('×”×¢×¨×•×ª (×œ× ×—×•×‘×”)', { textarea:true, id:'message', placeholder:'×œ×“×•×’××”: ×¨×¢× ×•×Ÿ ×œ×§×¨××ª ××‘×—×Ÿ / ×”×¢×“×¤×” ×œ×©×¢×ª ×¢×¨×‘' });

        Chat.button('×”××©×š', ()=>{
          Chat.userBubble('×”××©×š');
          Chat.State.data.message = (message.value||'').trim();
          stepReview();
        }, 'btn');

      }, 650);
    }

    /* ===== ×©×œ×‘ 6: ×¡×™×›×•× ×•×©×œ×™×—×” ===== */
    function stepReview(){
      setHelpCtx('review');
      Chat.clear(); Chat.push(stepReview);

      Chat.botHTML('<strong>×¡×™×›×•× ×”×‘×§×©×”</strong><br><span class="muted">× × ×œ×•×•×“× ×©×”×›×•×œ × ×›×•×Ÿ ×œ×¤× ×™ ×©×œ×™×—×”.</span> ğŸ‘¨â€ğŸš€');

      const d = Chat.State.data;

      // ×©×‘×‘×•× ×™× ×¢×œ×™×•× ×™× (context)
      const chips = document.createElement('div'); chips.className='summary';
      if (d.subject)   chips.appendChild(Chat.chip(`××§×¦×•×¢: ${d.subject}`));
      if (d.grade)     chips.appendChild(Chat.chip(`×›×™×ª×”: ${d.grade}${d.units?` â€¢ ${d.units} ×™×—×™×“×•×ª`:''}`));
      if (d.planType)  chips.appendChild(Chat.chip(`××¡×œ×•×œ: ${Chat.cfg.PLAN_HE[d.planType]}${d.price?` â€“ ${d.price}â‚ª`:''}`));
      document.getElementById('area').appendChild(chips);

      // ×›×¨×˜×™×¡ ×¡×™×›×•×
      Chat.summaryCard([
        ['×©×:', d.firstName || ''],
        ['×©× ××©×¤×—×”:', d.lastName || ''],
        ['××§×¦×•×¢:', d.subject || ''],
        ['×›×™×ª×”:', `${d.grade||''}${d.units?` â€¢ ${d.units} ×™×—×™×“×•×ª`:''}`],
        ['××¡×œ×•×œ:', (Chat.cfg.PLAN_HE[d.planType]||'') + (d.price?` â€“ ${d.price}â‚ª`: '')],
        ['×™××™× ×•×©×¢×•×ª ××•×¢×“×¤×™×:', d.availability || ''],
        ['×”×¢×¨×•×ª ×œ××–×›×™×¨×•×ª:', d.message || ''],
        ['×˜×œ×¤×•×Ÿ ×œ×—×–×¨×”:', d.phone || '']
      ]);

      Chat.button('××™×©×•×¨ ×•×©×œ×™×—×” ×œ××–×›×™×¨×•×ª ğŸ“¤', submitOneOff, 'btn');
      Chat.button('×¢×¨×™×›×”', ()=> Chat.goBack?.(), 'btn');
    }

    async function submitOneOff(){
      const d=Chat.State.data;

      // ×•×œ×™×“×¦×™×” ×¡×•×¤×™×ª
      const errs=[];
      if(!d.firstName || !d.lastName) errs.push('name');
      if(!Chat.validILPhone(d.phone)) errs.push('phone');
      if(!d.subject) errs.push('subject');
      if(!d.grade) errs.push('grade');
      if(!d.planType) errs.push('plan');
      if(!d.availability) errs.push('availability');

      if(errs.length){
        Chat.botText('×—×¡×¨ ×©×“×” × ×“×¨×©. ×× × ×‘×“×§×• ×•× ×¡×• ×©×•×‘.').classList.add('err');
        return;
      }

      const stopProcessing = Chat.showProcessing('×©×•×œ×— ×œ××–×›×™×¨×•×ªâ€¦');
      const ok = await Chat.sendLeadToSheet({
        path: '×©×™×¢×•×¨ ×¢×œ ×‘×¡×™×¡ ××§×•× ×¤× ×•×™',
        cta: '×©×™×¢×•×¨ ×—×“Ö¾×¤×¢××™',
        planType: Chat.cfg.PLAN_HE[d.planType],
        price: `${d.price||''}â‚ª`,
        subject: d.subject,
        grade: d.grade,
        units: d.units || '',
        availability: d.availability,
        message: d.message || '',
        extraNotes: '',
        fullName: `${d.firstName||''} ${d.lastName||''}`.trim(),
        firstName: d.firstName,
        lastName:  d.lastName,
        phone: d.phone,
        source: '×™×•×¡×˜×•×Ÿ â€“ ××ª×¨',
        status: '×œ×˜×™×¤×•×œ',
        createdAt: new Date().toISOString()
      });
      stopProcessing();

      Chat.clear();
      if(ok){
        Chat.botText('×”××™×“×¢ × ×©×œ×— ×œ××–×›×™×¨×•×ª âœ… × ×™×¦×•×¨ ×§×©×¨ ×‘×”×§×“× ×‘×•×•××˜×¡××¤ ×œ×ª×™××•× ×©×™×¢×•×¨ ×¢×œ ×‘×¡×™×¡ ××§×•× ×¤× ×•×™ ğŸ‘¨â€ğŸš€').classList.add('ok');
      }else{
        Chat.botText('×œ× ×”×¦×œ×—× ×• ×œ×©××•×¨ ××ª ×”×‘×§×©×” âŒ × ×™×ª×Ÿ ×œ× ×¡×•×ª ×©×•×‘ ××• ×œ×¤× ×•×ª ×‘×•×•××˜×¡××¤ 050â€‘9570866.').classList.add('err');
      }
      const home = Chat.button('×—×–×¨×” ×œ×ª×¤×¨×™×˜ ×”×¨××©×™', ()=> location.href='../index.html', 'btn');
      home.focus();
    }

    function setHelpCtx(ctx){
      const btn = document.getElementById('faqBtn');
      if(!btn) return;
      const base = '../faq.html';
      btn.href = ctx ? `${base}?ctx=${encodeURIComponent(ctx)}` : base;
    }

    // ×”×¤×¢×œ×”
    start();
  </script>
</body>
</html>