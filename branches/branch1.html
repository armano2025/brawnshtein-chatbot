<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>×©×™×¢×•×¨ ×—×“ ×¤×¢××™ ×¢×œ ×‘×¡×™×¡ ××§×•× ×¤× ×•×™</title>

  <link rel="stylesheet" href="../styles.light.css?v=1" />
  <meta name="theme-color" content="#5b7cfa" />
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <button class="btn" onclick="location.href='../index.html'">×œ×ª×¤×¨×™×˜ ×¨××©×™</button>
      </div>

      <div class="head">
        <div class="brand">
          <div class="logo">HB</div>
          <div class="title">×©×™×¢×•×¨ ×—×“ ×¤×¢××™ ×¢×œ ×‘×¡×™×¡ ××§×•× ×¤× ×•×™</div>
        </div>
      </div>

      <div class="body chat-body" id="area" role="log" aria-live="polite" aria-atomic="false"></div>

      <div class="footer">
        <button id="backBtn" class="btn" disabled>×—×–×¨×”</button>
        <a id="faqBtn" class="btn ghost" href="../faq.html" target="_blank" rel="noopener">×™×© ×œ×™ ×©××œ×•×ª</a>
        <span class="spacer"></span>
      </div>
    </div>
  </div>

  <!-- ×¡×§×¨×™×¤×˜×™×: × ×ª×™×‘×™× ××•×—×œ×˜×™× + cache-bust + defer -->
  <script defer src="/branches/js/config.js?v=3"></script>
  <script defer src="/branches/js/chat-helpers.js?v=3"></script>

  <script>
    /* ===== ×§×•× ×˜×§×¡×˜ ×œ×›×¤×ª×•×¨ ×”â€‘FAQ ===== */
    function setHelpContext(ctx){
      const btn = document.getElementById('faqBtn');
      if(!btn) return;
      const base = '../faq.html';
      btn.href = ctx ? `${base}?ctx=${encodeURIComponent(ctx)}` : base;
    }

    /* ===== ×¢×–×¨ ×œâ€‘select ×ª×•×š ×›×“×™ ×¦'××˜ ===== */
    function selectRow(label, options, id){
      const wrap = document.createElement('div');
      wrap.className = 'input-wrap bubble bot';

      const l = document.createElement('label');
      l.textContent = label;
      if(id) l.htmlFor = id;

      const sel = document.createElement('select');
      sel.id = id;
      sel.className = 'input';
      sel.style.direction = 'rtl';

      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = '×‘×—×¨/×™...';
      sel.appendChild(opt0);

      options.forEach(v=>{
        const o=document.createElement('option');
        o.value=v; o.textContent=v;
        sel.appendChild(o);
      });

      wrap.append(l, sel);
      document.getElementById('area').appendChild(wrap);
      document.getElementById('area').scrollTop = document.getElementById('area').scrollHeight;
      return sel;
    }

    /* ===== ×–×¨×™××” ===== */
    async function stepContactFirst(){
      setHelpContext('contact');
      Chat.clear(); Chat.push(stepContactFirst);

      const h = Chat.botHTML('<strong>×›×“×™ ×©× ×ª×× ×©×™×¢×•×¨ ×¢×œ ×‘×¡×™×¡ ××§×•× ×¤× ×•×™</strong><br><span class="muted">× ×©××— ×œ×©× ×¤×¨×˜×™, ×©× ××©×¤×—×” ×•××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ×—×–×¨×”</span> ğŸ‘¨â€ğŸš€');
      Chat.scrollStartOf(h);

      const firstName = Chat.inputRow('×©× ×¤×¨×˜×™',   { id:'firstName', placeholder:'×œ×“×•×’××”: ×“× ×”', required:true, autocomplete:'given-name' });
      const lastName  = Chat.inputRow('×©× ××©×¤×—×”',  { id:'lastName',  placeholder:'×œ×“×•×’××”: ×œ×•×™', required:true, autocomplete:'family-name' });
      const phone     = Chat.inputRow('×˜×œ×¤×•×Ÿ ×œ×—×–×¨×”', { type:'tel', id:'phone', placeholder:'×œ×“×•×’××”: 0501234567', required:true, autocomplete:'tel', inputmode:'tel' });

      Chat.button('×”××©×š', ()=>{
        Chat.userBubble('×”××©×š');

        const fn  = (firstName.value||'').trim();
        const ln  = (lastName.value||'').trim();
        const tel = Chat.normalizeILPhone(phone.value||'');

        if(!fn){  Chat.botText('× ×“×¨×© ×©× ×¤×¨×˜×™ âœï¸').classList.add('err'); firstName.focus(); return; }
        if(!ln){  Chat.botText('× ×“×¨×© ×©× ××©×¤×—×” âœï¸').classList.add('err'); lastName.focus(); return; }
        if(!Chat.validILPhone(tel)){ Chat.botText('××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ× ×ª×§×™×Ÿ ğŸ“').classList.add('err'); phone.focus(); return; }

        Chat.State.data.firstName = fn;
        Chat.State.data.lastName  = ln;
        Chat.State.data.phone     = tel;

        stepSubject();
      }, 'btn primary');
    }

    function stepSubject(){
      setHelpContext('subject');
      Chat.clear(); Chat.push(stepSubject);

      const name = Chat.State.data.firstName ? ` ${Chat.State.data.firstName}` : '';
      Chat.typingThen(
        `<strong>××¢×•×œ×”${name}! × ×ª×× ×©×™×¢×•×¨ ×—×“Ö¾×¤×¢××™ ×¢×œ ×‘×¡×™×¡ ××§×•× ×¤× ×•×™ ğŸ‘¨â€ğŸš€</strong><br><strong>××™×–×” ××§×¦×•×¢ ×ª×¨×¦×•?</strong> ğŸ“–`,
        500, true
      );

      setTimeout(()=>{
        const subjects = (Chat.cfg.SUBJECTS || []).map(s => s === '×× ×’×œ×™×ª ××“×•×‘×¨×ª' ? '×× ×’×œ×™×ª ××“×•×‘×¨×ª ×œ×§×˜× ×˜× ×™×' : s);
        if (!subjects.includes('×‘×™×•×œ×•×’×™×”')) subjects.push('×‘×™×•×œ×•×’×™×”');

        subjects.forEach(s => Chat.button(s, ()=>{
          Chat.userBubble(s);
          Chat.State.data.subject = s;
          stepGrade();
        }));

        const s = document.createElement('div'); s.className='summary';
        s.appendChild(Chat.chip('×©×™×¢×•×¨ ×—×“Ö¾×¤×¢××™'));
        document.getElementById('area').appendChild(s);
      }, 650);
    }

    function stepGrade(){
      setHelpContext('grade');
      Chat.clear(); Chat.push(stepGrade);

      Chat.typingThen('<strong>×‘××™×–×• ×›×™×ª×”?</strong> ğŸ‘¨â€ğŸš€', 450, true);

      setTimeout(()=>{
        const grades = ['×','×‘','×’','×“','×”','×•','×–','×—','×˜','×™','×™×','×™×‘','×—×™× ×•×š ×‘×™×ª×™','×¡×˜×•×“× ×˜/×™×ª','××—×¨'];
        const gradeSelect = selectRow('×›×™×ª×”', grades, 'grade');

        const btnNext = Chat.button('×”××©×š', ()=>{
          Chat.userBubble('×”××©×š');
          const g = gradeSelect.value;
          if(!g){ Chat.botText('× ×“×¨×© ×œ×‘×—×•×¨ ×›×™×ª×” âœï¸').classList.add('err'); gradeSelect.focus(); return; }
          Chat.State.data.grade = g;
          if (['×™','×™×','×™×‘'].includes(g)) stepUnits();
          else stepPlan();
        }, 'btn primary');

        gradeSelect.addEventListener('change', ()=>{ btnNext.disabled = false; });
      }, 500);
    }

    function stepUnits(){
      setHelpContext('units');
      Chat.clear(); Chat.push(stepUnits);

      Chat.typingThen('<strong>×›××” ×™×—×™×“×•×ª ×‘×’×¨×•×ª?</strong> ğŸ‘¨â€ğŸš€', 450, true);

      setTimeout(()=>{
        ['3','4','5'].forEach(u => Chat.button(`${u} ×™×—×™×“×•×ª`, ()=>{
          Chat.userBubble(`${u} ×™×—×™×“×•×ª`);
          Chat.State.data.units = u;
          stepPlan();
        }));

        const s = document.createElement('div'); s.className='summary';
        s.appendChild(Chat.chip(`×›×™×ª×”: ${Chat.State.data.grade}`));
        if (Chat.State.data.subject) s.appendChild(Chat.chip(`××§×¦×•×¢: ${Chat.State.data.subject}`));
        document.getElementById('area').appendChild(s);
      }, 450);
    }

    function stepPlan(){
      setHelpContext('plan');
      Chat.clear(); Chat.push(stepPlan);

      const P = Chat.cfg.PRICES;
      Chat.typingThen('<strong>×‘×—×™×¨×ª ××¡×œ×•×œ</strong><br><span class="muted">×‘×—×¨×• ××¡×œ×•×œ ××ª××™×:</span> ğŸ‘¨â€ğŸš€', 450, true);

      setTimeout(()=>{
        const isMath = (Chat.State.data.subject || '').trim() === '××ª××˜×™×§×”';
        const isHighGrade = ['×™×','×™×‘'].includes(Chat.State.data.grade);
        const isFiveUnits = (Chat.State.data.units || '') === '5';
        const allowGroup = !(isMath && isHighGrade && isFiveUnits);

        if (allowGroup){
          Chat.button(`×§×‘×•×¦×” â€“ ×¢×“ 5 ×ª×œ××™×“×™× â€“ ${P.group}â‚ª`, ()=>{
            Chat.userBubble(`×§×‘×•×¦×” â€“ ×¢×“ 5 ×ª×œ××™×“×™× â€“ ${P.group}â‚ª`);
            Chat.State.data.planType='group'; Chat.State.data.price=P.group; stepAvailability();
          }, 'btn primary');
        }

        Chat.button(`×˜×¨×™×¤×œ â€“ ×¢×“ 3 ×ª×œ××™×“×™× â€“ ${P.triple}â‚ª`, ()=>{
          Chat.userBubble(`×˜×¨×™×¤×œ â€“ ×¢×“ 3 ×ª×œ××™×“×™× â€“ ${P.triple}â‚ª`);
          Chat.State.data.planType='triple'; Chat.State.data.price=P.triple; stepAvailability();
        });

        Chat.button(`×¤×¨×˜×™ â€“ ${P.private}â‚ª`, ()=>{
          Chat.userBubble(`×¤×¨×˜×™ â€“ ${P.private}â‚ª`);
          Chat.State.data.planType='private'; Chat.State.data.price=P.private; stepAvailability();
        });

        const s = document.createElement('div'); s.className='summary';
        if (Chat.State.data.subject) s.appendChild(Chat.chip(`××§×¦×•×¢: ${Chat.State.data.subject}`));
        if (Chat.State.data.grade)   s.appendChild(Chat.chip(`×›×™×ª×”: ${Chat.State.data.grade}${Chat.State.data.units?` â€¢ ${Chat.State.data.units} ×™×—×™×“×•×ª`:''}`));
        document.getElementById('area').appendChild(s);
      }, 450);
    }

    function stepAvailability(){
      setHelpContext('availability');
      Chat.clear(); Chat.push(stepAvailability);

      const name = Chat.State.data.firstName ? `, ${Chat.State.data.firstName}` : '';
      Chat.typingThen(
        '<strong>×©×¢×•×ª ×¤×ª×™×—×”</strong><br>' +
        '<span class="muted">××³â€“×”×³ 14:00â€“21:00.</span><br><br>' +
        `<strong>×‘×—×™×¨×ª ×™××™× ×•×©×¢×•×ª ××•×¢×“×¤×™×${name}</strong> ğŸ‘¨â€ğŸš€`,
        450, true
      );

      // ×©×™××•×© ×‘×¨×›×™×‘ ×”â€‘picker ×”××©×•×¤×¨ ××ª×•×š chat-helpers
      setTimeout(async ()=>{
        const chosen = await Chat.pickAvailability({
          tipText: '×‘×—×¨×• ×›××” ×©×™×•×ª×¨ ××¤×©×¨×•×™×•×ª ×©× ×•×—×•×ª ×œ×›×',
          continueText: '×”××©×š'
        });
        if(!chosen) return; // ×—×–×¨×• ××—×•×¨×”
        Chat.State.data.availability = chosen.join('; ');
        stepNotes();
      }, 550);
    }

    function stepNotes(){
      setHelpContext('notes');
      Chat.clear(); Chat.push(stepNotes);

      const name = Chat.State.data.firstName ? `, ${Chat.State.data.firstName}` : '';
      Chat.typingThen(`<strong>×”×¢×¨×•×ª ×œ××–×›×™×¨×•×ª</strong><br><span class="muted">××¤×©×¨ ×œ×¦×™×™×Ÿ ×”×¢×“×¤×” ×œ××•×¨×”, ×¨××”, ××• ×‘×§×©×” ××™×•×—×“×ª (×œ× ×—×•×‘×”)${name}</span> ğŸ‘¨â€ğŸš€`, 450, true);

      setTimeout(()=>{
        const message = Chat.inputRow('×”×¢×¨×•×ª (×œ× ×—×•×‘×”)', { textarea:true, id:'message', placeholder:'×œ×“×•×’××”: ×¨×¢× ×•×Ÿ ×œ×§×¨××ª ××‘×—×Ÿ / ×”×¢×“×¤×” ×œ×©×¢×ª ×¢×¨×‘' });
        const btnNext = Chat.button('×”××©×š', ()=>{
          Chat.userBubble('×”××©×š');
          Chat.State.data.message = (message.value||'').trim();
          stepReview();
        }, 'btn primary');
        message.addEventListener('input', ()=>{ btnNext.disabled = false; });
      }, 450);
    }

    function stepReview(){
      setHelpContext('review');
      Chat.clear(); Chat.push(stepReview);

      const h = Chat.botHTML('<strong>×¡×™×›×•× ×”×‘×§×©×”</strong><br><span class="muted">× × ×œ×•×•×“× ×©×”×›×•×œ × ×›×•×Ÿ ×œ×¤× ×™ ×©×œ×™×—×”.</span> ğŸ‘¨â€ğŸš€');
      Chat.scrollStartOf(h);

      const chips = document.createElement('div'); chips.className='summary';
      const d = Chat.State.data;
      if (d.subject) chips.appendChild(Chat.chip(`××§×¦×•×¢: ${d.subject}`));
      if (d.grade)   chips.appendChild(Chat.chip(`×›×™×ª×”: ${d.grade}${d.units?` â€¢ ${d.units} ×™×—×™×“×•×ª`:''}`));
      if (d.planType) chips.appendChild(Chat.chip(`××¡×œ×•×œ: ${Chat.cfg.PLAN_HE[d.planType]} (${d.price}â‚ª)`));
      const card = document.createElement('div'); card.className='bubble bot'; card.appendChild(chips);

      const details = document.createElement('div'); details.style.lineHeight='1.9';
      const add = (k,v)=>{ if(!v) return; const row=document.createElement('div'); const b=document.createElement('strong'); b.textContent=k+' '; const s=document.createElement('span'); s.textContent=v; row.append(b,s); details.appendChild(row); };
      add('×©×:', d.firstName||'');
      add('×©× ××©×¤×—×”:', d.lastName||'');
      add('××§×¦×•×¢:', d.subject||'');
      add('×›×™×ª×”:', `${d.grade||''}${d.units?` â€¢ ${d.units} ×™×—×™×“×•×ª`:''}`);
      add('××¡×œ×•×œ:', `${(Chat.cfg.PLAN_HE[d.planType]||'')}${d.price?` â€“ ${d.price}â‚ª`:''}`);
      add('×™××™× ×•×©×¢×•×ª ××•×¢×“×¤×™×:', d.availability||'');
      if (d.message) add('×”×¢×¨×•×ª ×œ××–×›×™×¨×•×ª:', d.message);
      add('×˜×œ×¤×•×Ÿ ×œ×—×–×¨×”:', d.phone||'');
      card.appendChild(details);
      document.getElementById('area').appendChild(card);
      document.getElementById('area').scrollTop = document.getElementById('area').scrollHeight;

      Chat.button('××™×©×•×¨ ×•×©×œ×™×—×” ×œ××–×›×™×¨×•×ª ğŸ“¤', async ()=>{
        const stop = Chat.showProcessing();
        const ok = await Chat.sendLeadToSheet({
          path: '×©×™×¢×•×¨ ×¢×œ ×‘×¡×™×¡ ××§×•× ×¤× ×•×™',
          planType: Chat.cfg.PLAN_HE[d.planType],
          price: `${d.price}â‚ª`,
          subject: d.subject,
          grade: d.grade,
          units: d.units || '',
          availability: d.availability,
          message: d.message || '',
          extraNotes: '',
          fullName: `${d.firstName||''} ${d.lastName||''}`.trim(),
          firstName: d.firstName,
          lastName:  d.lastName,
          phone: d.phone,
          cta: '×©×™×¢×•×¨ ×—×“Ö¾×¤×¢××™',
          source: '×™×•×¡×˜×•×Ÿ â€“ ××ª×¨',
          status: '×œ×˜×™×¤×•×œ',
          createdAt: new Date().toISOString()
        });
        stop(); Chat.clear();

        if(ok){
          Chat.botText('×”××™×“×¢ × ×©×œ×— ×œ××–×›×™×¨×•×ª âœ… × ×™×¦×•×¨ ×§×©×¨ ×‘×”×§×“× ×‘×•×•××˜×¡××¤ ×œ×ª×™××•× ×©×™×¢×•×¨ ×¢×œ ×‘×¡×™×¡ ××§×•× ×¤× ×•×™ ğŸ‘¨â€ğŸš€').classList.add('ok');
        }else{
          Chat.botText('×œ× ×”×¦×œ×—× ×• ×œ×©××•×¨ ××ª ×”×‘×§×©×” âŒ × ×™×ª×Ÿ ×œ× ×¡×•×ª ×©×•×‘ ××• ×œ×¤× ×•×ª ×‘×•×•××˜×¡××¤ 050â€‘9570866.').classList.add('err');
        }
        const home = Chat.button('×—×–×¨×” ×œ×ª×¤×¨×™×˜ ×”×¨××©×™', ()=> location.href='../index.html', 'btn');
        home.focus();
      }, 'btn primary');
    }

    function start(){
      // ×× chat-helpers ×œ× × ×˜×¢×Ÿ â€” ×”×•×“×¢×ª fallback ×‘×¨×•×¨×”
      if(!window.Chat){
        const a = document.getElementById('area');
        a.innerHTML = '';
        const d = document.createElement('div');
        d.className = 'bubble bot';
        d.textContent =
          '×©×’×™××”: ×¨×›×™×‘×™ ×”×¦×³××˜ ×œ× × ×˜×¢× ×•. ×‘×“×§×• ××ª ×”× ×ª×™×‘×™× /branches/js/config.js ×•â€‘/branches/js/chat-helpers.js';
        a.appendChild(d);
        return;
      }
      Chat.clear(); Chat.push(start);
      stepContactFirst();
    }

    // ×œ×”×¨×™×¥ ××—×¨×™ ×©×”×›×•×œ × ×˜×¢×Ÿ (×›×•×œ×œ ×¡×§×¨×™×¤×˜×™× ×¢× defer)
    window.addEventListener('load', start);
  </script>
</body>
</html>