<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>×©×™×¢×•×¨ ×¢×œ ×‘×¡×™×¡ ××§×•× ×¤× ×•×™</title>

  <link rel="stylesheet" href="../styles.css?v=3" />
  <meta name="theme-color" content="#2563eb" />
  <style>#area{overflow-y:auto;max-height:70vh;scroll-behavior:smooth}</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <!-- ×›×•×ª×¨×ª -->
      <div class="head">
        <div class="brand">
          <div class="logo">HB</div>
          <div class="title">×©×™×¢×•×¨ ×¢×œ ×‘×¡×™×¡ ××§×•× ×¤× ×•×™</div>
        </div>
      </div>

      <!-- ××–×•×¨ ×”×ª×•×›×Ÿ -->
      <div class="body chat-body" id="area" role="log" aria-live="polite" aria-atomic="false"></div>

      <!-- ×ª×—×ª×™×ª -->
      <div class="footer">
        <button id="backBtn" class="btn" disabled>×—×–×¨×”</button>
        <button class="btn primary" onclick="location.href='../index.html'">×œ×ª×¤×¨×™×˜ ×¨××©×™</button>
      </div>
    </div>
  </div>

  <!-- ×¡×§×¨×™×¤×˜×™× ××©×•×ª×¤×™× -->
  <script src="./js/config.js?v=2"></script>
  <script src="./js/chat-helpers.js?v=2"></script>

  <script>
    function start(){
      Chat.clear(); Chat.push(start);

      Chat.typingThen(
        '× ×©××— ×œ×¢×–×•×¨ ×œ×ª×× ×©×™×¢×•×¨ ×—×“Ö¾×¤×¢××™ ğŸ—“ï¸<br><br>' +
        '×‘××¨×›×– ×‘×¨××•× ×©×˜×™×™×Ÿ, ×’× ×‘×©×™×¢×•×¨ ×§×‘×•×¦×ª×™ ×›×œ ×ª×œ××™×“/×” ××§×‘×œ/×ª ×™×—×¡ ××™×©×™ ×•×ª×›× ×™×ª ×œ×™××•×“ ××•×ª×××ª â€” ×œ×œ× ×ª×œ×•×ª ×‘×§×¦×‘ ×©×œ ××—×¨×™×.',
        900, true
      );

      setTimeout(()=> Chat.typingThen('<strong>××™×–×” ×¡×•×’ ×©×™×¢×•×¨ ××ª××™×?</strong>', 800, true), 2000);

      setTimeout(()=>{
        const P = Chat.cfg.PRICES;

        Chat.button(`×§×‘×•×¦×” â€“ ×¢×“ 5 ×ª×œ××™×“×™× â€“ ${P.group}â‚ª`, ()=>{
          Chat.userBubble(`×§×‘×•×¦×” â€“ ×¢×“ 5 ×ª×œ××™×“×™× â€“ ${P.group}â‚ª`);
          Chat.State.data.planType='group';
          Chat.State.data.price=P.group;
          stepSubject();
        }, 'btn primary');

        Chat.button(`×˜×¨×™×¤×œ â€“ ×¢×“ 3 ×ª×œ××™×“×™× â€“ ${P.triple}â‚ª`, ()=>{
          Chat.userBubble(`×˜×¨×™×¤×œ â€“ ×¢×“ 3 ×ª×œ××™×“×™× â€“ ${P.triple}â‚ª`);
          Chat.State.data.planType='triple';
          Chat.State.data.price=P.triple;
          stepSubject();
        });

        Chat.button(`×¤×¨×˜×™ â€“ ${P.private}â‚ª`, ()=>{
          Chat.userBubble(`×¤×¨×˜×™ â€“ ${P.private}â‚ª`);
          Chat.State.data.planType='private';
          Chat.State.data.price=P.private;
          stepSubject();
        });
      }, 3000);
    }

    function stepSubject(){
      Chat.clear(); Chat.push(stepSubject);
      Chat.typingThen('<strong>×‘××™×–×” ××§×¦×•×¢ ×ª×¨×¦×• ××ª ×”×©×™×¢×•×¨? ğŸ“–</strong>', 800, true);

      setTimeout(()=>{
        Chat.cfg.SUBJECTS.forEach(s => Chat.button(s, ()=>{
          Chat.userBubble(s);
          Chat.State.data.subject = s;
          stepDetails();
        }));
        // ×¦×³×™×¤×¡ ××¡×œ×•×œ+××—×™×¨
        const s = document.createElement('div'); s.className='summary';
        if (Chat.State.data.planType)
          s.appendChild(Chat.chip(`××¡×œ×•×œ: ${Chat.cfg.PLAN_HE[Chat.State.data.planType]} (${Chat.State.data.price}â‚ª)`));
        document.getElementById('area').appendChild(s);
      }, 1500);
    }

    async function stepDetails(){
      Chat.clear(); Chat.push(stepDetails);

      // × ×•×¢×œ ××•×˜×•-×¡×§×¨×•×œ ×§×¦×¨ ×›×“×™ ×œ× "×œ×§×¤×•×¥" ×œ×ª×—×ª×™×ª
      Chat.State.autoScroll = false;
      const header = Chat.botHTML('<strong>×¤×¨×˜×™ ×ª×™××•×</strong><br><span class="muted">× ××œ× ×›××” ×¤×¨×˜×™× ×•××– × ×¡×›× ğŸ“‹</span>');

      const chips = document.createElement('div'); chips.className='summary';
      if (Chat.State.data.planType) chips.appendChild(Chat.chip(`××¡×œ×•×œ: ${Chat.cfg.PLAN_HE[Chat.State.data.planType]} (${Chat.State.data.price}â‚ª)`));
      if (Chat.State.data.subject)  chips.appendChild(Chat.chip(`××§×¦×•×¢: ${Chat.State.data.subject}`));
      document.getElementById('area').appendChild(chips);

      Chat.scrollStartOf(header);
      setTimeout(()=> Chat.State.autoScroll = true, 450);

      // ×©×¢×•×ª ×¤×¢×™×œ×•×ª + ×‘×§×©×ª ×™××™/×©×¢×•×ª
      Chat.typingThen(
        '×©×¢×•×ª ×”×¤×¢×™×œ×•×ª ×©×œ× ×•: <strong>××³â€“×”×³, 14:00â€“21:00</strong> â°<br>' +
        '××”× ×”×™××™× ×•×”×©×¢×•×ª ×©× ×•×—×™× ×œ×©×™×¢×•×¨?',
        700, true
      );

      // ×©×“×•×ª
      await waitP(300);
      const availability = Chat.inputRow('×™××™× ×•×©×¢×•×ª ××•×¢×“×¤×™×', {
        textarea:true, id:'availability',
        placeholder:'×œ×“×•×’××”: ××³â€“×’×³ 16:00â€“19:00 / ×©×™×©×™ ×‘×•×§×¨', required:true
      });

      await waitP(150);
      const message = Chat.inputRow('×”×¢×¨×•×ª ×œ××–×›×™×¨×•×ª (×œ× ×—×•×‘×”)', {
        textarea:true, id:'message', placeholder:'×¨××”/×™×¢×“/×”×¢×“×¤×•×ª ××™×•×—×“×•×ª'
      });

      await waitP(150);
      const fullName = Chat.inputRow('×©× ××œ×', {
        id:'fullName', placeholder:'×œ×“×•×’××”: ×“× ×” ×œ×•×™', required:true, autocomplete:'name'
      });

      await waitP(150);
      const phone = Chat.inputRow('×˜×œ×¤×•×Ÿ ×œ×—×–×¨×”', {
        type:'tel', id:'phone', placeholder:'×œ×“×•×’××”: 0501234567',
        required:true, autocomplete:'tel', inputmode:'tel'
      });

      availability.focus({ preventScroll:true });

      await waitP(120);
      Chat.button('×”××©×š ×œ×¡×™×›×•×', ()=>{
        Chat.userBubble('×”××©×š ×œ×¡×™×›×•×');

        const avail = (availability.value||'').trim();
        const note  = (message.value||'').trim();
        const name  = (fullName.value||'').trim();
        const tel   = Chat.normalizeILPhone(phone.value||'');

        if(!avail){ Chat.botText('× × ×œ×¦×™×™×Ÿ ×–××™× ×•×ª (×™××™× ×•×©×¢×•×ª) ğŸ•’').classList.add('err'); availability.focus(); return; }
        if(!name){  Chat.botText('× × ×œ×”×–×™×Ÿ ×©× ××œ× âœï¸').classList.add('err'); fullName.focus(); return; }
        if(!Chat.validILPhone(tel)){ Chat.botText('××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ× ×ª×§×™×Ÿ ğŸ“').classList.add('err'); phone.focus(); return; }

        Chat.State.data.availability = avail;
        Chat.State.data.message      = note;
        Chat.State.data.fullName     = name;
        Chat.State.data.phone        = tel;

        stepReview();
      }, 'btn primary');

      Chat.button('×—×–×¨×”', Chat.goBack);

      function waitP(ms){ return new Promise(r=>setTimeout(r, ms)); }
    }

    function stepReview(){
      Chat.clear(); Chat.push(stepReview);

      const h = Chat.botHTML('<strong>×¡×™×›×•× ×”×‘×§×©×”</strong><br><span class="muted">×‘×“×§×• ×©×”×›×•×œ × ×›×•×Ÿ ×œ×¤× ×™ ×©×œ×™×—×”.</span>');
      Chat.scrollStartOf(h);

      const card = document.createElement('div'); card.className='bubble bot';

      const chips = document.createElement('div'); chips.className='summary';
      if (Chat.State.data.planType) chips.appendChild(Chat.chip(`××¡×œ×•×œ: ${Chat.cfg.PLAN_HE[Chat.State.data.planType]} (${Chat.State.data.price}â‚ª)`));
      if (Chat.State.data.subject)  chips.appendChild(Chat.chip(`××§×¦×•×¢: ${Chat.State.data.subject}`));
      card.appendChild(chips);

      const details = document.createElement('div'); details.style.lineHeight='1.9';
      const addLine = (label, value)=>{
        const line=document.createElement('div');
        const b=document.createElement('strong'); b.textContent=label+' ';
        const span=document.createElement('span'); span.textContent=value;
        line.append(b, span); details.appendChild(line);
      };
      addLine('×™××™× ×•×©×¢×•×ª ××•×¢×“×¤×™×:', Chat.State.data.availability);
      if (Chat.State.data.message) addLine('×”×¢×¨×•×ª:', Chat.State.data.message);
      addLine('×©× ××œ×:', Chat.State.data.fullName);
      addLine('×˜×œ×¤×•×Ÿ ×œ×—×–×¨×”:', Chat.State.data.phone);

      card.appendChild(details);
      document.getElementById('area').appendChild(card);
      (function(){ const a=document.getElementById('area'); a.scrollTop=a.scrollHeight; })();

      Chat.button('××™×©×•×¨ ×•×©×œ×™×—×” ×œ××–×›×™×¨×•×ª ğŸ“¤', async ()=>{
        const stopProcessing = Chat.showProcessing();

        const ok = await Chat.sendLeadToSheet({
          path: '×©×™×¢×•×¨ ×¢×œ ×‘×¡×™×¡ ××§×•× ×¤× ×•×™',
          planType: Chat.cfg.PLAN_HE[Chat.State.data.planType],
          price: `${Chat.State.data.price}â‚ª`,
          subject: Chat.State.data.subject,
          availability: Chat.State.data.availability,
          message: Chat.State.data.message,
          extraNotes: '×©×¢×•×ª ×¤×¢×™×œ×•×ª: ××³â€“×”×³ 14:00â€“21:00',
          fullName: Chat.State.data.fullName,
          phone: Chat.State.data.phone,
          cta: '×©×™×¢×•×¨ ×—×“Ö¾×¤×¢××™',
          source: '×™×•×¡×˜×•×Ÿ â€“ ××ª×¨',
          status: '×œ×˜×™×¤×•×œ',
          createdAt: new Date().toISOString()
        });

        stopProcessing();
        Chat.clear();

        if(ok){
          Chat.botText('×”×‘×§×©×” × ×©×œ×—×” ×œ××–×›×™×¨×•×ª âœ… × ×—×–×•×¨ ×‘×”×§×“× ×œ×‘×“×•×§ ×–××™× ×•×ª ×•×œ×”×©×¨×™×™×Ÿ ××•×¢×“ ğŸ“…').classList.add('ok');
        }else{
          Chat.botText('×œ× ×”×¦×œ×—× ×• ×œ×©××•×¨ ××ª ×”×‘×§×©×” âŒ ××¤×©×¨ ×œ× ×¡×•×ª ×©×•×‘ ××• ×œ×¤× ×•×ª ×‘×•×•××˜×¡××¤ 050â€‘9570866.').classList.add('err');
        }
        const home = Chat.button('×—×–×¨×” ×œ×ª×¤×¨×™×˜ ×”×¨××©×™', ()=> location.href='../index.html', 'btn primary');
        home.focus();
      }, 'btn primary');

      Chat.button('×¢×¨×™×›×”', ()=> stepDetails());
    }

    // ×”×¤×¢×œ×”
    start();
  </script>
</body>
</html>