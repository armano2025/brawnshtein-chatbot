<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>×©×™×¢×•×¨ ×¢×œ ×‘×¡×™×¡ ××§×•× ×¤× ×•×™</title>

  <!-- ×—×©×•×‘: ×œ×”×ª××™× ×œ×©× ×”×§×•×‘×¥ ××¦×œ×š (styles.css) -->
  <link rel="stylesheet" href="../styles.css" />
  <meta name="theme-color" content="#2563eb" />
</head>
<body>
  <div class="wrap">
    <div class="card">
      <!-- ×›×•×ª×¨×ª -->
      <div class="head">
        <div class="brand">
          <div class="logo">HB</div>
          <div class="title">×©×™×¢×•×¨ ×¢×œ ×‘×¡×™×¡ ××§×•× ×¤× ×•×™</div>
        </div>
      </div>

      <!-- ××–×•×¨ ×”×ª×•×›×Ÿ -->
      <div class="body" id="area"></div>

      <!-- ×›×¤×ª×•×¨×™ × ×™×•×•×˜ ×ª×—×ª×•× ×™× -->
      <div class="footer">
        <button id="backBtn" class="btn">×—×–×¨×”</button>
        <button id="homeBtn" class="btn primary" onclick="location.href='../index.html'">×œ×ª×¤×¨×™×˜ ×¨××©×™</button>
      </div>
    </div>
  </div>

  <script>
    /* ===== ×§×•× ×¤×™×’ ===== */
    const SHEETS_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbwnNKY0BeO5N2O9oWmr8ltCHr9fVdDdrXsL_3erastx4qdEqhCz1mYAhkvZETF-86CGnw/exec';
    const PRICES = { group: 80, triple: 100, private: 160 };
    const PLAN_HE = { group: '×§×‘×•×¦×”', triple: '×˜×¨×™×¤×œ', private: '×¤×¨×˜×™' };
    const SUBJECTS = ['×× ×’×œ×™×ª','××ª××˜×™×§×”','×¤×™×–×™×§×”','×©×¤×”','×× ×’×œ×™×ª ××“×•×‘×¨×ª'];

    /* ===== DOM/State ===== */
    const area = document.getElementById('area');
    const backBtn = document.getElementById('backBtn');
    const state = {
      history: [],
      data: {
        planType: null,       // group | triple | private
        price: null,          // 80 | 100 | 160
        subject: null,        // ×¢×‘×¨×™×ª
        availability: null,   // ×˜×§×¡×˜ ×—×•×¤×©×™
        message: '',          // ××•×¤×¦×™×•× ×œ×™
        fullName: null,
        phone: null
      }
    };
    const push  = (fn)=> state.history.push(fn);
    const goBack= ()=>{ if(state.history.length>1){ state.history.pop(); state.history.at(-1)(); } };
    backBtn.onclick = goBack;

    /* ===== ×¢×–×¨×™× UI ===== */
    const clear = ()=> area.innerHTML = '';
    function bubble(html){
      const d=document.createElement('div');
      d.className='bubble';
      d.innerHTML=html;
      area.appendChild(d);
      return d;
    }
    function button(text, onClick, cls='btn'){
      const b=document.createElement('button');
      b.className=cls;
      b.textContent=text;
      b.onclick=onClick;
      area.appendChild(b);
      return b;
    }
    function inputRow(label, {type='text', id, textarea=false, placeholder=''}={}){
      const wrap=document.createElement('div');
      wrap.className='input-wrap bubble';
      const l=document.createElement('label'); l.textContent=label;
      let el;
      if(textarea){
        el=document.createElement('textarea'); el.className='textarea';
      }else{
        el=document.createElement('input'); el.type=type; el.className='input';
      }
      el.id=id; el.placeholder=placeholder; el.dir='rtl';
      wrap.append(l, el);
      area.appendChild(wrap);
      return el;
    }
    function summaryChips(){
      const s=document.createElement('div'); s.className='summary';
      if(state.data.planType) s.appendChild(chip(`××¡×œ×•×œ: ${PLAN_HE[state.data.planType]} (${state.data.price}â‚ª)`));
      if(state.data.subject)  s.appendChild(chip(`××§×¦×•×¢: ${state.data.subject}`));
      area.appendChild(s);
    }
    function chip(text){
      const c=document.createElement('div'); c.className='chip'; c.textContent=text; return c;
    }

    /* ===== ××¤×§×˜ â€œ×©×œ×•×© × ×§×•×“×•×ªâ€ (1.5 ×©× ×™×•×ª) ===== */
    function addBotMessageWithTyping(text){
      const typing=document.createElement('div');
      typing.className='typing-indicator';
      typing.innerHTML='<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
      area.appendChild(typing);
      area.scrollTop = area.scrollHeight;
      setTimeout(()=>{
        typing.remove();
        bubble(text);
        area.scrollTop = area.scrollHeight;
      }, 1500);
    }

    /* ===== ×˜×œ×¤×•×Ÿ ×™×©×¨××œ×™ ===== */
    const normalizeILPhone = raw => {
      let p=(raw||'').toString().trim().replace(/[^\d+]/g,'');
      if(p.startsWith('+972')) p='0'+p.slice(4);
      if(p.startsWith('972'))  p='0'+p.slice(3);
      return p;
    };
    const validILPhone = p => /^0\d{8,9}$/.test(p||'');

    /* ===== ×©×œ×™×—×” ×œ-Google Sheets ===== */
    async function sendLeadToSheet(payload){
      try{
        const res = await fetch(SHEETS_WEBAPP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' }, // ××¤×—×™×ª preflight
          body: JSON.stringify(payload)
        });
        const j = await res.json().catch(()=>({ok:false}));
        return j.ok === true || res.ok;
      }catch(e){
        console.error('Sheets error', e);
        return false;
      }
    }

    /* ===== ×–×¨×™××” ===== */

    // ×¤×ª×™×—×”
    function start(){
      clear(); push(start);
      addBotMessageWithTyping('<strong>×”×™×™, ×× ×™ ×™×•×¡×˜×•×Ÿ ğŸ‘¨â€ğŸš€</strong><br>× ×§×‘×¢ ×©×™×¢×•×¨ ×—×“Ö¾×¤×¢××™ ×¢×œ ×‘×¡×™×¡ ××§×•× ×¤× ×•×™.');
      button('×™××œ×œ×” × ×ª×—×™×œ', stepPlan, 'btn primary');
    }

    // ×©×œ×‘ 1 â€“ ×‘×—×™×¨×ª ××¡×œ×•×œ
    function stepPlan(){
      clear(); push(stepPlan);
      bubble('<strong>×‘×—×¨×™ ××¡×œ×•×œ</strong><br><span class="muted">×—×“Ö¾×¤×¢××™ ×‘×œ×‘×“.</span>');
      button('×§×‘×•×¦×” â€“ ×¢×“ 5 ×ª×œ××™×“×™× â€“ 80â‚ª',  ()=>{ state.data.planType='group';  state.data.price=PRICES.group;  stepSubject(); });
      button('×˜×¨×™×¤×œ â€“ ×¢×“ 3 ×ª×œ××™×“×™× â€“ 100â‚ª', ()=>{ state.data.planType='triple'; state.data.price=PRICES.triple; stepSubject(); });
      button('×¤×¨×˜×™ â€“ 160â‚ª',                   ()=>{ state.data.planType='private';state.data.price=PRICES.private;stepSubject(); });
    }

    // ×©×œ×‘ 2 â€“ ×‘×—×™×¨×ª ××§×¦×•×¢
    function stepSubject(){
      clear(); push(stepSubject);
      bubble('<strong>××™×–×” ××§×¦×•×¢ ×œ×©×™×¢×•×¨?</strong>');
      SUBJECTS.forEach(s=> button(s, ()=>{ state.data.subject=s; stepDetails(); }));
      summaryChips();
    }

    // ×©×œ×‘ 3 (××¨×•×›×–) â€“ ×–××™× ×•×ª, ×”×•×“×¢×”, ×©×, ×˜×œ×¤×•×Ÿ + ×©×œ×™×—×”
    function stepDetails(){
      clear(); push(stepDetails);
      bubble('<strong>×¤×¨×˜×™ ×©×™×‘×•×¥</strong><br><span class="muted">××œ××™ ×•× ×©×œ×— ×œ××–×›×™×¨×•×ª.</span>');
      summaryChips();

      const availability = inputRow('×™××™ ×•×©×¢×•×ª ×–××™× ×•×ª',{textarea:true,id:'availability',placeholder:'×œ×“×•×’××”: ××³â€“×’×³ 15:00â€“19:00; ×•×³ ×‘×•×§×¨'});
      const message      = inputRow('×”×•×“×¢×” ×—×•×¤×©×™×ª (×œ× ×—×•×‘×”)',{textarea:true,id:'message',placeholder:'×”×¢×“×¤×” ×œ××•×¨×” / ×¨××” / ×”×¢×¨×•×ª'});
      const fullName     = inputRow('×©× ××œ×',{id:'fullName',placeholder:'×œ×“×•×’××”: ×“× ×” ×œ×•×™'});
      const phone        = inputRow('×˜×œ×¤×•×Ÿ ×œ×—×–×¨×”',{type:'tel',id:'phone',placeholder:'×œ×“×•×’××”: 0501234567'});

      button('×©×œ×™×—×” ×œ××–×›×™×¨×•×ª', async ()=>{
        const avail = (availability.value||'').trim();
        const note  = (message.value||'').trim();
        const name  = (fullName.value||'').trim();
        const tel   = normalizeILPhone(phone.value||'');

        if(!avail){ bubble('×× × ×›×ª×‘×™ ×–××™× ×•×ª (×™××™× ×•×©×¢×•×ª).').classList.add('err'); return; }
        if(!name){  bubble('×™×© ×œ×”×–×™×Ÿ ×©× ××œ×.').classList.add('err'); return; }
        if(!validILPhone(tel)){ bubble('××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ× ×ª×§×™×Ÿ (×œ××©×œ 0501234567).').classList.add('err'); return; }

        state.data.availability = avail;
        state.data.message = note;
        state.data.fullName = name;
        state.data.phone = tel;

        addBotMessageWithTyping('×©×•×œ×— ×œ××–×›×™×¨×•×ªâ€¦');

        const ok = await sendLeadToSheet({
          path: '×©×™×¢×•×¨ ×¢×œ ×‘×¡×™×¡ ××§×•× ×¤× ×•×™',
          planType: PLAN_HE[state.data.planType],
          price: `${state.data.price}â‚ª`,
          subject: state.data.subject,
          availability: state.data.availability,
          message: state.data.message,
          fullName: state.data.fullName,
          phone: state.data.phone,
          cta: '×©×™×¢×•×¨ ×—×“Ö¾×¤×¢××™',
          source: '×™×•×¡×˜×•×Ÿ â€“ ××ª×¨',
          status: '×—×“×©',
          createdAt: new Date().toISOString()
        });

        clear();
        if(ok){
          bubble('×”×‘×§×©×” × ×¨×©××” ×•×”×•×¢×‘×¨×” ×œ××–×›×™×¨×•×ª ğŸ›°ï¸ × ×—×–×•×¨ ××œ×™×™×š ×‘×§×¨×•×‘ ×›×“×™ ×œ×‘×“×•×§ ×–××™× ×•×ª ×•×œ×”×©×¨×™×™×Ÿ ×©×™×¢×•×¨.').classList.add('ok');
        }else{
          bubble('×œ× ×”×¦×œ×—× ×• ×œ×©××•×¨ ××ª ×”×‘×§×©×” ×œ×’×™×œ×™×•×Ÿ. ××¤×©×¨ ×œ× ×¡×•×ª ×©×•×‘ ××• ×œ×¤× ×•×ª ××œ×™× ×• ×‘×•×•××˜×¡××¤ 050â€‘9570866.').classList.add('err');
        }
        button('×—×–×¨×” ×œ×ª×¤×¨×™×˜ ×”×¨××©×™', ()=> location.href='../index.html', 'btn primary');
      }, 'btn primary');

      button('×—×–×¨×”', goBack);
    }

    // ×”×¤×¢×œ×”
    start();
  </script>
</body>
</html>